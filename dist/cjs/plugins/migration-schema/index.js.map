{"version":3,"file":"index.js","names":["_rxjs","require","_index","_rxMigrationState","Object","keys","forEach","key","prototype","hasOwnProperty","call","_exportNames","exports","defineProperty","enumerable","get","_migrationHelpers","_plugin","_index2","_migrationTypes","DATA_MIGRATOR_BY_COLLECTION","WeakMap","RxDBMigrationPlugin","name","rxdb","init","addRxPlugin","RxDBLocalDocumentsPlugin","hooks","preCloseRxDatabase","after","onDatabaseClose","prototypes","RxDatabase","proto","migrationStates","getMigrationStateByDatabase","pipe","shareReplay","RXJS_SHARE_REPLAY_DEFAULTS","RxCollection","getMigrationState","getFromMapOrCreate","RxMigrationState","asRxCollection","migrationStrategies","migrationNeeded","schema","version","PROMISE_RESOLVE_FALSE","mustMigrate","RxDBMigrationSchemaPlugin"],"sources":["../../../../src/plugins/migration-schema/index.ts"],"sourcesContent":["import {\r\n    Observable\r\n} from 'rxjs';\r\nimport {\r\n    shareReplay\r\n} from 'rxjs';\r\nimport type {\r\n    RxPlugin,\r\n    RxCollection,\r\n    RxDatabase\r\n} from '../../types/index.ts';\r\nimport {\r\n    getFromMapOrCreate,\r\n    PROMISE_RESOLVE_FALSE,\r\n    RXJS_SHARE_REPLAY_DEFAULTS\r\n} from '../../plugins/utils/index.ts';\r\nimport {\r\n    RxMigrationState\r\n} from './rx-migration-state.ts';\r\nimport {\r\n    getMigrationStateByDatabase,\r\n    mustMigrate,\r\n    onDatabaseClose\r\n} from './migration-helpers.ts';\r\nimport { addRxPlugin } from '../../plugin.ts';\r\nimport { RxDBLocalDocumentsPlugin } from '../local-documents/index.ts';\r\n\r\nexport const DATA_MIGRATOR_BY_COLLECTION: WeakMap<RxCollection, RxMigrationState> = new WeakMap();\r\n\r\nexport const RxDBMigrationPlugin: RxPlugin = {\r\n    name: 'migration-schema',\r\n    rxdb: true,\r\n    init() {\r\n        addRxPlugin(RxDBLocalDocumentsPlugin);\r\n    },\r\n    hooks: {\r\n        preCloseRxDatabase: {\r\n            after: onDatabaseClose\r\n        }\r\n    },\r\n    prototypes: {\r\n        RxDatabase: (proto: any) => {\r\n            proto.migrationStates = function (this: RxDatabase): Observable<RxMigrationState[]> {\r\n                return getMigrationStateByDatabase(this).pipe(\r\n                    shareReplay(RXJS_SHARE_REPLAY_DEFAULTS)\r\n                );\r\n            };\r\n        },\r\n        RxCollection: (proto: any) => {\r\n            proto.getMigrationState = function (this: RxCollection): RxMigrationState {\r\n                return getFromMapOrCreate(\r\n                    DATA_MIGRATOR_BY_COLLECTION,\r\n                    this,\r\n                    () => new RxMigrationState(\r\n                        this.asRxCollection,\r\n                        this.migrationStrategies\r\n                    )\r\n                );\r\n            };\r\n            proto.migrationNeeded = function (this: RxCollection) {\r\n                if (this.schema.version === 0) {\r\n                    return PROMISE_RESOLVE_FALSE;\r\n                }\r\n                return mustMigrate(this.getMigrationState());\r\n            };\r\n        }\r\n    }\r\n};\r\n\r\nexport const RxDBMigrationSchemaPlugin = RxDBMigrationPlugin;\r\n\r\n\r\nexport * from './rx-migration-state.ts';\r\nexport * from './migration-helpers.ts';\r\nexport * from './migration-types.ts';\r\n"],"mappings":"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","ignoreList":[]}