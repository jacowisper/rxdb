{"version":3,"file":"index.js","names":["_errorMessages","require","_checkSchema","Object","keys","forEach","key","prototype","hasOwnProperty","call","_exportNames","exports","defineProperty","enumerable","get","_checkOrm","_checkMigrationStrategies","_unallowedProperties","_checkQuery","_rxError","_index","_checkDocument","_devModeTracking","showDevModeWarning","disableWarnings","deepFreezeWhenDevMode","obj","deepFreeze","DEV_MODE_PLUGIN_NAME","RxDBDevModePlugin","name","rxdb","init","console","warn","join","overwritable","isDevMode","tunnelErrorMessage","code","ERROR_MESSAGES","error","Error","errorMessage","hooks","preCreateRxSchema","after","checkSchema","preCreateRxDatabase","before","args","storage","startsWith","newRxError","database","ensureDatabaseNameIsValid","createRxDatabase","addDevModeTrackingIframe","preCreateRxCollection","ensureCollectionNameValid","checkOrmDocumentMethods","schema","methods","charAt","createRxDocument","doc","ensurePrimaryKeyValid","primary","toJSON","prePrepareRxQuery","isQueryAllowed","preCreateRxQuery","checkQuery","prePrepareQuery","checkMangoQuery","preStorageWrite","checkWriteRows","storageInstance","rows","createRxCollection","checkOrmMethods","creator","statics","attachments","migrationStrategies","checkMigrationStrategies"],"sources":["../../../../src/plugins/dev-mode/index.ts"],"sourcesContent":["import type {\r\n    RxPlugin,\r\n    RxCollectionCreator,\r\n    RxDatabaseCreator,\r\n    RxErrorKey,\r\n    RxDocument,\r\n    RxDatabase\r\n} from '../../types/index.d.ts';\r\n\r\nimport {\r\n    ERROR_MESSAGES\r\n} from './error-messages.ts';\r\nimport {\r\n    checkSchema\r\n} from './check-schema.ts';\r\nimport {\r\n    checkOrmDocumentMethods,\r\n    checkOrmMethods\r\n} from './check-orm.ts';\r\nimport { checkMigrationStrategies } from './check-migration-strategies.ts';\r\nimport {\r\n    ensureCollectionNameValid,\r\n    ensureDatabaseNameIsValid\r\n} from './unallowed-properties.ts';\r\nimport { checkMangoQuery, checkQuery, isQueryAllowed } from './check-query.ts';\r\nimport { newRxError } from '../../rx-error.ts';\r\nimport { DeepReadonly } from '../../types/util.ts';\r\nimport { deepFreeze } from '../../plugins/utils/index.ts';\r\nimport { checkWriteRows, ensurePrimaryKeyValid } from './check-document.ts';\r\nimport { addDevModeTrackingIframe } from './dev-mode-tracking.ts';\r\n\r\nexport * from './check-schema.ts';\r\nexport * from './unallowed-properties.ts';\r\nexport * from './check-query.ts';\r\n\r\nlet showDevModeWarning = true;\r\n\r\n/**\r\n * Suppresses the warning message shown in the console, typically invoked once the developer (hello!) \r\n * has acknowledged it.\r\n */\r\nexport function disableWarnings() {\r\n    showDevModeWarning = false;\r\n}\r\n\r\n/**\r\n * Deep freezes and object when in dev-mode.\r\n * Deep-Freezing has the same performance as deep-cloning, so we only do that in dev-mode.\r\n * Also we can ensure the readonly state via typescript\r\n * @link https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze\r\n */\r\nexport function deepFreezeWhenDevMode<T>(obj: T): DeepReadonly<T> {\r\n    // direct return if not suitable for deepFreeze()\r\n    if (\r\n        !obj ||\r\n        typeof obj === 'string' ||\r\n        typeof obj === 'number'\r\n    ) {\r\n        return obj as any;\r\n    }\r\n\r\n    return deepFreeze(obj) as any;\r\n}\r\n\r\n\r\nexport const DEV_MODE_PLUGIN_NAME = 'dev-mode';\r\nexport const RxDBDevModePlugin: RxPlugin = {\r\n    name: DEV_MODE_PLUGIN_NAME,\r\n    rxdb: true,\r\n    init: () => {\r\n        if (showDevModeWarning) {\r\n            console.warn(\r\n                [\r\n                    '-------------- RxDB dev-mode warning -------------------------------',\r\n                    'you are seeing this because you use the RxDB dev-mode plugin https://rxdb.info/dev-mode.html?console=dev-mode ',\r\n                    'This is great in development mode, because it will run many checks to ensure',\r\n                    'that you use RxDB correct. If you see this in production mode,',\r\n                    'you did something wrong because the dev-mode plugin will decrease the performance.',\r\n                    '',\r\n                    'ðŸ¤— Hint: To get the most out of RxDB, check out the Premium Plugins',\r\n                    'to get access to faster storages and more professional features: https://rxdb.info/premium/?console=dev-mode ',\r\n                    '',\r\n                    'You can disable this warning by calling disableWarnings() from the dev-mode plugin.',\r\n                    // '',\r\n                    // 'Also take part in the RxDB User Survey: https://rxdb.info/survey.html',\r\n                    '---------------------------------------------------------------------'\r\n                ].join('\\n')\r\n            );\r\n        }\r\n    },\r\n    overwritable: {\r\n        isDevMode() {\r\n            return true;\r\n        },\r\n        deepFreezeWhenDevMode,\r\n        tunnelErrorMessage(code: RxErrorKey) {\r\n            if (!ERROR_MESSAGES[code]) {\r\n                console.error('RxDB: Error-Code not known: ' + code);\r\n                throw new Error('Error-Code ' + code + ' not known, contact the maintainer');\r\n            }\r\n            const errorMessage = ERROR_MESSAGES[code];\r\n            return `\r\nError message: ${errorMessage}\r\nError code: ${code}`;\r\n        }\r\n    },\r\n    hooks: {\r\n        preCreateRxSchema: {\r\n            after: checkSchema\r\n        },\r\n        preCreateRxDatabase: {\r\n            before: function (args: RxDatabaseCreator<any, any>) {\r\n                if (!args.storage.name.startsWith('validate-')) {\r\n                    throw newRxError('DVM1', {\r\n                        database: args.name,\r\n                        storage: args.storage.name\r\n                    });\r\n                }\r\n            },\r\n            after: function (args: RxDatabaseCreator<any, any>) {\r\n                ensureDatabaseNameIsValid(args);\r\n            }\r\n        },\r\n        createRxDatabase: {\r\n            after: async function (args) {\r\n                addDevModeTrackingIframe(args.database);\r\n            }\r\n        },\r\n        preCreateRxCollection: {\r\n            after: function (args: RxCollectionCreator<any> & { name: string; }) {\r\n                ensureCollectionNameValid(args);\r\n                checkOrmDocumentMethods(args.schema as any, args.methods);\r\n                if (args.name.charAt(0) === '_') {\r\n                    throw newRxError('DB2', {\r\n                        name: args.name\r\n                    });\r\n                }\r\n                if (!args.schema) {\r\n                    throw newRxError('DB4', {\r\n                        name: args.name,\r\n                        args\r\n                    });\r\n                }\r\n            }\r\n        },\r\n        createRxDocument: {\r\n            before: function (doc: RxDocument) {\r\n                ensurePrimaryKeyValid(doc.primary, doc.toJSON(true));\r\n            }\r\n        },\r\n        prePrepareRxQuery: {\r\n            after: function (args) {\r\n                isQueryAllowed(args);\r\n            }\r\n        },\r\n        preCreateRxQuery: {\r\n            after: function (args) {\r\n                checkQuery(args);\r\n            }\r\n        },\r\n        prePrepareQuery: {\r\n            after: (args) => {\r\n                checkMangoQuery(args);\r\n            }\r\n        },\r\n        preStorageWrite: {\r\n            before: (args) => {\r\n                checkWriteRows(args.storageInstance, args.rows);\r\n            }\r\n        },\r\n        createRxCollection: {\r\n            after: (args) => {\r\n                // check ORM-methods\r\n                checkOrmMethods(args.creator.statics);\r\n                checkOrmMethods(args.creator.methods);\r\n                checkOrmMethods(args.creator.attachments);\r\n\r\n                // check migration strategies\r\n                if (args.creator.schema && args.creator.migrationStrategies) {\r\n                    checkMigrationStrategies(\r\n                        args.creator.schema,\r\n                        args.creator.migrationStrategies\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    }\r\n};\r\n"],"mappings":"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","ignoreList":[]}