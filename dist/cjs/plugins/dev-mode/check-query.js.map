{"version":3,"file":"check-query.js","names":["_rxError","require","_index","_rxQueryHelper","checkQuery","args","isPlainObject","Object","prototype","toString","call","queryObj","newRxTypeError","op","collection","name","validKeys","keys","forEach","key","includes","limit","skip","newRxError","query","ensureObjectDoesNotContainRegExp","checkMangoQuery","schema","rxQuery","jsonSchema","undefinedFieldPath","findUndefinedPath","mangoQuery","field","massagedSelector","selector","schemaTopLevelFields","properties","filter","fieldOrOperator","startsWith","schemaIndexes","indexes","index","isInSchema","find","schemaIndex","deepEqual","areSelectorsSatisfiedByIndex","database","allowSlowCount","sort","map","sortPart","preparedQuery","prepareQuery","queryPlan","selectorSatisfiedByIndex","value","RegExp","Array","isArray","item","isQueryAllowed"],"sources":["../../../../src/plugins/dev-mode/check-query.ts"],"sourcesContent":["import type {\r\n    RxPluginPreCreateRxQueryArgs,\r\n    MangoQuery,\r\n    RxPluginPrePrepareQueryArgs,\r\n    FilledMangoQuery,\r\n    RxJsonSchema,\r\n    RxDocumentData,\r\n    MangoQuerySelector,\r\n    PreparedQuery,\r\n    RxQueryOP,\r\n    RxPluginPrePrepareRxQueryArgs\r\n} from '../../types/index.d.ts';\r\nimport { newRxError, newRxTypeError } from '../../rx-error.ts';\r\nimport { deepEqual, findUndefinedPath } from '../utils/index.ts';\r\nimport { prepareQuery } from '../../rx-query-helper.ts';\r\n\r\n/**\r\n * accidentally passing a non-valid object into the query params\r\n * is very hard to debug especially when queries are observed\r\n * This is why we do some checks here in dev-mode\r\n */\r\nexport function checkQuery(args: RxPluginPreCreateRxQueryArgs) {\r\n    const isPlainObject = Object.prototype.toString.call(args.queryObj) === '[object Object]';\r\n    if (!isPlainObject) {\r\n        throw newRxTypeError('QU11', {\r\n            op: args.op,\r\n            collection: args.collection.name,\r\n            queryObj: args.queryObj\r\n        });\r\n    }\r\n\r\n    const validKeys: (keyof MangoQuery)[] = [\r\n        'selector',\r\n        'limit',\r\n        'skip',\r\n        'sort',\r\n        'index'\r\n    ];\r\n    Object.keys(args.queryObj).forEach(key => {\r\n        if (!(validKeys as string[]).includes(key)) {\r\n            throw newRxTypeError('QU11', {\r\n                op: args.op,\r\n                collection: args.collection.name,\r\n                queryObj: args.queryObj,\r\n                key,\r\n                args: {\r\n                    validKeys\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    // do not allow skip or limit for count queries\r\n    if (\r\n        args.op === 'count' &&\r\n        (\r\n            args.queryObj.limit ||\r\n            args.queryObj.skip\r\n        )\r\n    ) {\r\n        throw newRxError(\r\n            'QU15',\r\n            {\r\n                collection: args.collection.name,\r\n                query: args.queryObj\r\n            }\r\n        );\r\n    }\r\n\r\n    ensureObjectDoesNotContainRegExp(args.queryObj);\r\n}\r\n\r\n\r\nexport function checkMangoQuery(args: RxPluginPrePrepareQueryArgs) {\r\n    const schema = args.rxQuery.collection.schema.jsonSchema;\r\n\r\n    const undefinedFieldPath = findUndefinedPath(args.mangoQuery);\r\n    if (undefinedFieldPath) {\r\n        throw newRxError('QU19', {\r\n            field: undefinedFieldPath,\r\n            query: args.mangoQuery,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Ensure that all top level fields are included in the schema.\r\n     * TODO this check can be augmented to also check sub-fields.\r\n     */\r\n    const massagedSelector: MangoQuerySelector<any> = args.mangoQuery.selector;\r\n    const schemaTopLevelFields = Object.keys(schema.properties);\r\n    Object.keys(massagedSelector)\r\n        // do not check operators\r\n        .filter(fieldOrOperator => !fieldOrOperator.startsWith('$'))\r\n        // skip this check on non-top-level fields\r\n        .filter(field => !field.includes('.'))\r\n        .forEach(field => {\r\n            if (!schemaTopLevelFields.includes(field)) {\r\n                throw newRxError('QU13', {\r\n                    schema,\r\n                    field,\r\n                    query: args.mangoQuery,\r\n                });\r\n            }\r\n        });\r\n\r\n    /**\r\n     * ensure if custom index is set,\r\n     * it is also defined in the schema\r\n     */\r\n    const schemaIndexes = schema.indexes ? schema.indexes : [];\r\n    const index = args.mangoQuery.index;\r\n    if (index) {\r\n        const isInSchema = schemaIndexes.find(schemaIndex => deepEqual(schemaIndex, index));\r\n        if (!isInSchema) {\r\n            throw newRxError(\r\n                'QU12',\r\n                {\r\n                    collection: args.rxQuery.collection.name,\r\n                    query: args.mangoQuery,\r\n                    schema\r\n                }\r\n            );\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Ensure that a count() query can only be used\r\n     * with selectors that are fully satisfied by the used index.\r\n     */\r\n    if (args.rxQuery.op === 'count') {\r\n        if (\r\n            !areSelectorsSatisfiedByIndex(\r\n                args.rxQuery.collection.schema.jsonSchema,\r\n                args.mangoQuery\r\n            ) &&\r\n            !args.rxQuery.collection.database.allowSlowCount\r\n        ) {\r\n            throw newRxError('QU14', {\r\n                collection: args.rxQuery.collection,\r\n                query: args.mangoQuery\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ensure that sort only runs on known fields\r\n     * TODO also check nested fields\r\n     */\r\n    if (args.mangoQuery.sort) {\r\n        args.mangoQuery.sort\r\n            .map(sortPart => Object.keys(sortPart)[0])\r\n            .filter(field => !field.includes('.'))\r\n            .forEach(field => {\r\n                if (!schemaTopLevelFields.includes(field)) {\r\n                    throw newRxError('QU13', {\r\n                        schema,\r\n                        field,\r\n                        query: args.mangoQuery,\r\n                    });\r\n                }\r\n            });\r\n    }\r\n\r\n    // Do not allow RexExp instances\r\n    ensureObjectDoesNotContainRegExp(args.mangoQuery);\r\n}\r\n\r\n\r\nexport function areSelectorsSatisfiedByIndex<RxDocType>(\r\n    schema: RxJsonSchema<RxDocumentData<RxDocType>>,\r\n    query: FilledMangoQuery<RxDocType>\r\n): boolean {\r\n    const preparedQuery: PreparedQuery<any> = prepareQuery(\r\n        schema,\r\n        query\r\n    );\r\n    return preparedQuery.queryPlan.selectorSatisfiedByIndex;\r\n}\r\n\r\n/**\r\n * Ensures that the selector does not contain any RegExp instance.\r\n * @recursive\r\n */\r\nexport function ensureObjectDoesNotContainRegExp(selector: any) {\r\n    if (typeof selector !== 'object' || selector === null) {\r\n        return;\r\n    }\r\n    const keys = Object.keys(selector);\r\n    keys.forEach(key => {\r\n        const value: any = selector[key];\r\n        if (value instanceof RegExp) {\r\n            throw newRxError('QU16', {\r\n                field: key,\r\n                query: selector,\r\n            });\r\n        } else if (Array.isArray(value)) {\r\n            value.forEach(item => ensureObjectDoesNotContainRegExp(item));\r\n        } else {\r\n            ensureObjectDoesNotContainRegExp(value);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n/**\r\n * People often use queries wrong\r\n * so we have some checks here.\r\n * For example people use numbers as primary keys\r\n * which is not allowed.\r\n */\r\nexport function isQueryAllowed(args: RxPluginPrePrepareRxQueryArgs) {\r\n    if (args.op === 'findOne') {\r\n        if (\r\n            typeof args.queryObj === 'number' ||\r\n            Array.isArray(args.queryObj)\r\n        ) {\r\n            throw newRxTypeError('COL6', {\r\n                collection: args.collection.name,\r\n                queryObj: args.queryObj\r\n            });\r\n        }\r\n    } else if (args.op === 'find') {\r\n        if (typeof args.queryObj === 'string') {\r\n            throw newRxError('COL5', {\r\n                collection: args.collection.name,\r\n                queryObj: args.queryObj\r\n            });\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]}