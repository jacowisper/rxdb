{"version":3,"file":"local-documents.js","names":["_index","require","_rxjs","_localDocumentsHelper","_rxStorageHelper","insertLocal","id","data","state","getLocalDocStateByParent","docData","_deleted","_meta","getDefaultRxDocumentMeta","_rev","getDefaultRevision","_attachments","writeSingle","storageInstance","document","then","newDocData","docCache","getCachedRxDocument","upsertLocal","getLocal","existing","docPromise","incrementalModify","found","getLatestDocumentDataIfExists","Promise","resolve","getSingleDocument","getLocal$","$","pipe","startWith","mergeMap","cE","changeEvent","doc","changeEventOrDoc","isLocal","documentId","use","filter","filterFlagged","map"],"sources":["../../../../src/plugins/local-documents/local-documents.ts"],"sourcesContent":["import {\r\n    getDefaultRevision,\r\n    getDefaultRxDocumentMeta\r\n} from '../../plugins/utils/index.ts';\r\n\r\nimport type {\r\n    RxChangeEvent,\r\n    RxCollection,\r\n    RxDatabase,\r\n    RxDocument,\r\n    RxDocumentWriteData,\r\n    RxLocalDocument,\r\n    RxLocalDocumentData\r\n} from '../../types/index.d.ts';\r\n\r\nimport {\r\n    filter,\r\n    map,\r\n    startWith,\r\n    mergeMap\r\n} from 'rxjs';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { getLocalDocStateByParent } from './local-documents-helper.ts';\r\nimport { getSingleDocument, writeSingle } from '../../rx-storage-helper.ts';\r\n\r\n\r\n\r\n/**\r\n * save the local-document-data\r\n * throws if already exists\r\n */\r\nexport async function insertLocal<DocData extends Record<string, any> = any, Reactivity = unknown>(\r\n    this: RxDatabase | RxCollection,\r\n    id: string,\r\n    data: DocData\r\n): Promise<RxLocalDocument<DocData, any, Reactivity>> {\r\n    const state = await getLocalDocStateByParent(this);\r\n\r\n    // create new one\r\n    const docData: RxDocumentWriteData<RxLocalDocumentData<DocData>> = {\r\n        id: id,\r\n        data,\r\n        _deleted: false,\r\n        _meta: getDefaultRxDocumentMeta(),\r\n        _rev: getDefaultRevision(),\r\n        _attachments: {}\r\n    };\r\n\r\n    return writeSingle(\r\n        state.storageInstance,\r\n        {\r\n            document: docData\r\n        },\r\n        'local-document-insert'\r\n    ).then(newDocData => state.docCache.getCachedRxDocument(newDocData) as any);\r\n}\r\n\r\n/**\r\n * save the local-document-data\r\n * overwrites existing if exists\r\n */\r\nexport function upsertLocal<DocData extends Record<string, any> = any, Reactivity = unknown>(\r\n    this: any,\r\n    id: string,\r\n    data: DocData\r\n): Promise<RxLocalDocument<DocData, any, Reactivity>> {\r\n    return this.getLocal(id)\r\n        .then((existing: RxDocument) => {\r\n            if (!existing) {\r\n                // create new one\r\n                const docPromise = this.insertLocal(id, data);\r\n                return docPromise;\r\n            } else {\r\n                // update existing\r\n                return existing.incrementalModify(() => {\r\n                    return data;\r\n                });\r\n            }\r\n        });\r\n}\r\n\r\nexport async function getLocal<DocData = any, Reactivity = unknown>(this: any, id: string): Promise<RxLocalDocument<DocData, any, Reactivity> | null> {\r\n    const state = await getLocalDocStateByParent(this);\r\n    const docCache = state.docCache;\r\n\r\n    // check in doc-cache\r\n    const found = docCache.getLatestDocumentDataIfExists(id);\r\n    if (found) {\r\n        return Promise.resolve(\r\n            docCache.getCachedRxDocument(found) as any\r\n        );\r\n    }\r\n\r\n    // if not found, check in storage instance\r\n    return getSingleDocument(state.storageInstance, id)\r\n        .then((docData) => {\r\n            if (!docData) {\r\n                return null;\r\n            }\r\n            return state.docCache.getCachedRxDocument(docData) as any;\r\n        });\r\n}\r\n\r\nexport function getLocal$<DocData = any, Reactivity = unknown>(this: RxCollection, id: string): Observable<RxLocalDocument<DocData, any, Reactivity> | null> {\r\n    return this.$.pipe(\r\n        startWith(null),\r\n        mergeMap(async (cE: RxChangeEvent<RxLocalDocumentData> | null) => {\r\n            if (cE) {\r\n                return {\r\n                    changeEvent: cE\r\n                };\r\n            } else {\r\n                const doc = await this.getLocal(id);\r\n                return {\r\n                    doc: doc\r\n                };\r\n            }\r\n        }),\r\n        mergeMap(async (changeEventOrDoc) => {\r\n            if (changeEventOrDoc.changeEvent) {\r\n                const cE = changeEventOrDoc.changeEvent;\r\n                if (!cE.isLocal || cE.documentId !== id) {\r\n                    return {\r\n                        use: false\r\n                    };\r\n                } else {\r\n                    const doc = await this.getLocal(id);\r\n                    return {\r\n                        use: true,\r\n                        doc: doc\r\n                    };\r\n                }\r\n            } else {\r\n                return {\r\n                    use: true,\r\n                    doc: changeEventOrDoc.doc\r\n                };\r\n            }\r\n        }),\r\n        filter(filterFlagged => filterFlagged.use),\r\n        map(filterFlagged => {\r\n            return filterFlagged.doc as any;\r\n        })\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]}