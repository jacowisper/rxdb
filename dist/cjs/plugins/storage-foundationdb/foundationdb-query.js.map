{"version":3,"file":"foundationdb-query.js","names":["_customIndex","require","_index","_foundationdbHelpers","_rxQueryHelper","queryFoundationDB","instance","preparedQuery","queryPlan","query","skip","limit","Infinity","skipPlusLimit","queryPlanFields","index","mustManuallyResort","sortSatisfiedByIndex","queryMatcher","selectorSatisfiedByIndex","getQueryMatcher","schema","dbs","internals","dbsPromise","indexForName","slice","indexName","getFoundationDBIndexName","indexDB","ensureNotFalsy","indexes","db","lowerBound","startKeys","lowerBoundString","getStartIndexStringFromLowerBound","upperBound","endKeys","upperBoundString","getStartIndexStringFromUpperBound","result","root","doTransaction","tx","innerResult","indexTx","at","subspace","mainTx","main","docId","get","docData","push","inclusiveStart","changeIndexableStringByOneQuantum","inclusiveEnd","range","getRangeBatch","done","next","rows","value","firstRow","shift","lastRow","lastOfArray","pop","docIds","map","row","docsData","Promise","all","forEach","length","return","sortComparator","getSortComparator","sort","documents"],"sources":["../../../../src/plugins/storage-foundationdb/foundationdb-query.ts"],"sourcesContent":["import {\r\n    changeIndexableStringByOneQuantum,\r\n    getStartIndexStringFromLowerBound,\r\n    getStartIndexStringFromUpperBound\r\n} from '../../custom-index.ts';\r\nimport type {\r\n    PreparedQuery,\r\n    QueryMatcher,\r\n    RxDocumentData,\r\n    RxStorageQueryResult\r\n} from '../../types/index.d.ts';\r\nimport { ensureNotFalsy, lastOfArray } from '../../plugins/utils/index.ts';\r\nimport { getFoundationDBIndexName } from './foundationdb-helpers.ts';\r\nimport { RxStorageInstanceFoundationDB } from './rx-storage-instance-foundationdb.ts';\r\nimport { getQueryMatcher, getSortComparator } from '../../rx-query-helper.ts';\r\n\r\nexport async function queryFoundationDB<RxDocType>(\r\n    instance: RxStorageInstanceFoundationDB<RxDocType>,\r\n    preparedQuery: PreparedQuery<RxDocType>\r\n): Promise<RxStorageQueryResult<RxDocType>> {\r\n    const queryPlan = preparedQuery.queryPlan;\r\n    const query = preparedQuery.query;\r\n    const skip = query.skip ? query.skip : 0;\r\n    const limit = query.limit ? query.limit : Infinity;\r\n    const skipPlusLimit = skip + limit;\r\n    const queryPlanFields: string[] = queryPlan.index;\r\n    const mustManuallyResort = !queryPlan.sortSatisfiedByIndex;\r\n\r\n\r\n    let queryMatcher: QueryMatcher<RxDocumentData<RxDocType>> | false = false;\r\n    if (!queryPlan.selectorSatisfiedByIndex) {\r\n        queryMatcher = getQueryMatcher(\r\n            instance.schema,\r\n            preparedQuery.query\r\n        );\r\n    }\r\n\r\n    const dbs = await instance.internals.dbsPromise;\r\n\r\n\r\n    const indexForName = queryPlanFields.slice(0);\r\n    const indexName = getFoundationDBIndexName(indexForName);\r\n    const indexDB = ensureNotFalsy(dbs.indexes[indexName]).db;\r\n\r\n    let lowerBound: any[] = queryPlan.startKeys;\r\n    let lowerBoundString = getStartIndexStringFromLowerBound(\r\n        instance.schema,\r\n        indexForName,\r\n        lowerBound\r\n    );\r\n\r\n    let upperBound: any[] = queryPlan.endKeys;\r\n    let upperBoundString = getStartIndexStringFromUpperBound(\r\n        instance.schema,\r\n        indexForName,\r\n        upperBound\r\n    );\r\n    let result: RxDocumentData<RxDocType>[] = await dbs.root.doTransaction(async (tx: any) => {\r\n        const innerResult: RxDocumentData<RxDocType>[] = [];\r\n        const indexTx = tx.at(indexDB.subspace);\r\n        const mainTx = tx.at(dbs.main.subspace);\r\n\r\n\r\n        /**\r\n         * TODO for whatever reason the keySelectors like firstGreaterThan etc.\r\n         * do not work properly. So we have to hack here to find the correct\r\n         * document in case lowerBoundString===upperBoundString.\r\n         * This likely must be fixed in the foundationdb library.\r\n         * When it is fixed, we do not need this if-case and instead\r\n         * can rely on .getRangeBatch() in all cases.\r\n         */\r\n        if (lowerBoundString === upperBoundString) {\r\n            const docId: string = await indexTx.get(lowerBoundString);\r\n            if (docId) {\r\n                const docData = await mainTx.get(docId);\r\n                if (!queryMatcher || queryMatcher(docData)) {\r\n                    innerResult.push(docData);\r\n                }\r\n            }\r\n            return innerResult;\r\n        }\r\n\r\n        if (!queryPlan.inclusiveStart) {\r\n            lowerBoundString = changeIndexableStringByOneQuantum(lowerBoundString, 1);\r\n        }\r\n        if (queryPlan.inclusiveEnd) {\r\n            upperBoundString = changeIndexableStringByOneQuantum(upperBoundString, +1);\r\n        }\r\n\r\n        const range = indexTx.getRangeBatch(\r\n            lowerBoundString,\r\n            upperBoundString,\r\n            // queryPlan.inclusiveStart ? keySelector.firstGreaterThan(lowerBoundString) : keySelector.firstGreaterOrEqual(lowerBoundString),\r\n            // queryPlan.inclusiveEnd ? keySelector.lastLessOrEqual(upperBoundString) : keySelector.lastLessThan(upperBoundString),\r\n            {\r\n                // TODO these options seem to be broken in the foundationdb node bindings\r\n                // limit: instance.settings.batchSize,\r\n                // streamingMode: StreamingMode.Exact\r\n            }\r\n        );\r\n        let done = false;\r\n        while (!done) {\r\n            const next = await range.next();\r\n            if (next.done) {\r\n                done = true;\r\n                break;\r\n            }\r\n            const rows: [string, string] = next.value;\r\n\r\n            if (!queryPlan.inclusiveStart) {\r\n                const firstRow = rows[0];\r\n                if (\r\n                    firstRow &&\r\n                    firstRow[0] === lowerBoundString\r\n                ) {\r\n                    rows.shift();\r\n                }\r\n            }\r\n            if (!queryPlan.inclusiveEnd) {\r\n                const lastRow = lastOfArray(rows);\r\n                if (\r\n                    lastRow &&\r\n                    lastRow[0] === upperBoundString\r\n                ) {\r\n                    rows.pop();\r\n                }\r\n            }\r\n\r\n            const docIds = rows.map(row => row[1]);\r\n            const docsData: RxDocumentData<RxDocType>[] = await Promise.all(docIds.map((docId: string) => mainTx.get(docId)));\r\n\r\n            docsData.forEach((docData) => {\r\n                if (!done) {\r\n                    if (!queryMatcher || queryMatcher(docData)) {\r\n                        innerResult.push(docData);\r\n                    }\r\n                }\r\n                if (\r\n                    !mustManuallyResort &&\r\n                    innerResult.length === skipPlusLimit\r\n                ) {\r\n                    done = true;\r\n                    range.return();\r\n                }\r\n            });\r\n        }\r\n        return innerResult;\r\n    });\r\n    if (mustManuallyResort) {\r\n        const sortComparator = getSortComparator(instance.schema, preparedQuery.query);\r\n        result = result.sort(sortComparator);\r\n    }\r\n\r\n    // apply skip and limit boundaries.\r\n    result = result.slice(skip, skipPlusLimit);\r\n\r\n    return {\r\n        documents: result\r\n    };\r\n}\r\n"],"mappings":"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","ignoreList":[]}