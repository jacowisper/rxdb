{"version":3,"file":"file-util.js","names":["fs","_interopRequireWildcard","require","path","_index","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","ensureFolderExists","folderPath","existsSync","mkdirSync","recursive","clearFolder","deleteFolder","rmdirSync","prepareFolders","database","options","directory","metaLoc","metaFileLocation","currentTime","now","metaData","createdAt","updatedAt","collectionStates","writeFileSync","JSON","stringify","keys","collections","forEach","collectionName","join","writeToFile","location","data","blobToString","Promise","res","rej","writeFile","err","writeJsonToFile","getMeta","loc","readFile","metaContent","parse","setMeta","meta","documentFolder","docId"],"sources":["../../../../src/plugins/backup/file-util.ts"],"sourcesContent":["import * as fs from 'node:fs';\r\nimport * as path from 'node:path';\r\nimport type {\r\n    BackupMetaFileContent,\r\n    BackupOptions,\r\n    RxDatabase\r\n} from '../../types/index.d.ts';\r\nimport { blobToString, now } from '../../plugins/utils/index.ts';\r\n\r\n/**\r\n * ensure that the given folder exists\r\n */\r\nexport function ensureFolderExists(folderPath: string): void {\r\n    if (!fs.existsSync(folderPath)) {\r\n        fs.mkdirSync(folderPath, { recursive: true });\r\n    }\r\n}\r\n\r\n/**\r\n * deletes and recreates the folder\r\n */\r\nexport function clearFolder(folderPath: string): void {\r\n    deleteFolder(folderPath);\r\n    ensureFolderExists(folderPath);\r\n}\r\n\r\nexport function deleteFolder(folderPath: string): void {\r\n    // only remove if exists to not raise warning\r\n    if (fs.existsSync(folderPath)) {\r\n        fs.rmdirSync(folderPath, { recursive: true });\r\n    }\r\n}\r\n\r\nexport function prepareFolders(\r\n    database: RxDatabase,\r\n    options: BackupOptions\r\n) {\r\n    ensureFolderExists(options.directory);\r\n\r\n    const metaLoc = metaFileLocation(options);\r\n\r\n    if (!fs.existsSync(metaLoc)) {\r\n        const currentTime = now();\r\n        const metaData: BackupMetaFileContent = {\r\n            createdAt: currentTime,\r\n            updatedAt: currentTime,\r\n            collectionStates: {}\r\n        };\r\n        fs.writeFileSync(metaLoc, JSON.stringify(metaData), 'utf-8');\r\n    }\r\n\r\n    Object.keys(database.collections).forEach(collectionName => {\r\n        ensureFolderExists(\r\n            path.join(\r\n                options.directory,\r\n                collectionName\r\n            )\r\n        );\r\n    });\r\n}\r\n\r\nexport async function writeToFile(\r\n    location: string,\r\n    data: string | Blob\r\n): Promise<void> {\r\n    if (typeof data !== 'string') {\r\n        data = await blobToString(data);\r\n    }\r\n    return new Promise(function (res, rej) {\r\n        fs.writeFile(\r\n            location,\r\n            data as string,\r\n            'utf-8',\r\n            (err) => {\r\n                if (err) {\r\n                    rej(err);\r\n                } else {\r\n                    res();\r\n                }\r\n            }\r\n        );\r\n    });\r\n}\r\n\r\nexport function writeJsonToFile(\r\n    location: string,\r\n    data: any\r\n): Promise<void> {\r\n    return writeToFile(\r\n        location,\r\n        JSON.stringify(data)\r\n    );\r\n}\r\n\r\nexport function metaFileLocation(options: BackupOptions): string {\r\n    return path.join(\r\n        options.directory,\r\n        'backup_meta.json'\r\n    );\r\n}\r\n\r\nexport function getMeta(options: BackupOptions): Promise<BackupMetaFileContent> {\r\n    const loc = metaFileLocation(options);\r\n    return new Promise((res, rej) => {\r\n        fs.readFile(loc, 'utf-8', (err, data) => {\r\n            if (err) {\r\n                rej(err);\r\n            } else {\r\n                const metaContent = JSON.parse(data);\r\n                res(metaContent);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\nexport function setMeta(\r\n    options: BackupOptions,\r\n    meta: BackupMetaFileContent\r\n): Promise<void> {\r\n    const loc = metaFileLocation(options);\r\n    return writeJsonToFile(loc, meta);\r\n}\r\n\r\nexport function documentFolder(\r\n    options: BackupOptions,\r\n    docId: string\r\n): string {\r\n    return path.join(\r\n        options.directory,\r\n        docId\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]}