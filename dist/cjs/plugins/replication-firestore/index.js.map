{"version":3,"file":"index.js","names":["_index","require","_firestore","_index2","_index3","_index4","_rxjs","_firestoreHelper","Object","keys","forEach","key","prototype","hasOwnProperty","call","_exportNames","exports","defineProperty","enumerable","get","_firestoreTypes","RxFirestoreReplicationState","_RxReplicationState","firestore","replicationIdentifierHash","collection","pull","push","live","retryTime","autoStart","_this","_inheritsLoose2","default","RxReplicationState","replicateFirestore","options","addRxPlugin","RxDBLeaderElectionPlugin","pullStream$","Subject","replicationPrimitivesPull","waitForLeadership","serverTimestampField","primaryPath","schema","schemaPart","getSchemaByObjectPath","jsonSchema","includes","newRxError","field","pullFilters","filter","undefined","toArray","pullQuery","query","handler","lastPulledCheckpoint","batchSize","newerQuery","sameTimeQuery","lastServerTimestamp","isoStringToServerTimestamp","serverTimestamp","where","orderBy","limit","documentId","id","mustsReRun","useDocs","waitForPendingWrites","database","runTransaction","_tx","newerQueryResult","sameTimeQueryResult","Promise","all","getDocs","metadata","hasPendingWrites","ensureNotFalsy","docs","missingAmount","length","additionalDocs","slice","x","appendToArray","checkpoint","documents","lastDoc","lastOfArray","map","row","firestoreRowToDocData","newCheckpoint","serverTimestampToIsoString","data","ret","modifier","stream$","asObservable","replicationPrimitivesPush","pushFilter","rows","asyncFilter","newDocumentState","writeRowsById","docIds","docId","conflicts","getQuery","ids","docsInDbResult","getContentByIds","docsInDbById","docDataInDb","stripServerTimestampField","batch","writeBatch","hasWrite","entries","writeRow","docInDb","assumedMasterState","conflictHandler","isEqual","docRef","doc","writeDocData","flatClone","set","stripPrimaryKey","update","commit","replicationState","replicationIdentifier","startBefore","start","bind","cancelBefore","cancel","lastChangeQuery","unsubscribe","onSnapshot","_querySnapshot","reSync","error","subjects","next","errorToPlainJson","startReplicationOnLeaderShip"],"sources":["../../../../src/plugins/replication-firestore/index.ts"],"sourcesContent":["import {\r\n    appendToArray,\r\n    asyncFilter,\r\n    ensureNotFalsy,\r\n    errorToPlainJson,\r\n    flatClone,\r\n    lastOfArray,\r\n    toArray\r\n} from '../../plugins/utils/index.ts';\r\n\r\nimport {\r\n    doc,\r\n    query,\r\n    where,\r\n    orderBy,\r\n    limit,\r\n    getDocs,\r\n    onSnapshot,\r\n    runTransaction,\r\n    writeBatch,\r\n    serverTimestamp,\r\n    QueryDocumentSnapshot,\r\n    waitForPendingWrites,\r\n    documentId\r\n} from 'firebase/firestore';\r\n\r\nimport { RxDBLeaderElectionPlugin } from '../leader-election/index.ts';\r\nimport type {\r\n    RxCollection,\r\n    ReplicationPullOptions,\r\n    ReplicationPushOptions,\r\n    RxReplicationWriteToMasterRow,\r\n    RxReplicationPullStreamItem\r\n} from '../../types/index.d.ts';\r\nimport {\r\n    RxReplicationState,\r\n    startReplicationOnLeaderShip\r\n} from '../replication/index.ts';\r\nimport {\r\n    addRxPlugin,\r\n    ById,\r\n    getSchemaByObjectPath,\r\n    newRxError,\r\n    WithDeleted\r\n} from '../../index.ts';\r\n\r\nimport type {\r\n    FirestoreCheckpointType,\r\n    FirestoreOptions,\r\n    SyncOptionsFirestore\r\n} from './firestore-types.ts';\r\nimport { Subject } from 'rxjs';\r\nimport {\r\n    firestoreRowToDocData,\r\n    getContentByIds,\r\n    isoStringToServerTimestamp,\r\n    serverTimestampToIsoString,\r\n    stripPrimaryKey,\r\n    stripServerTimestampField\r\n} from './firestore-helper.ts';\r\n\r\nexport * from './firestore-helper.ts';\r\nexport * from './firestore-types.ts';\r\n\r\nexport class RxFirestoreReplicationState<RxDocType> extends RxReplicationState<RxDocType, FirestoreCheckpointType> {\r\n    constructor(\r\n        public readonly firestore: FirestoreOptions<RxDocType>,\r\n        public readonly replicationIdentifierHash: string,\r\n        public readonly collection: RxCollection<RxDocType>,\r\n        public readonly pull?: ReplicationPullOptions<RxDocType, FirestoreCheckpointType>,\r\n        public readonly push?: ReplicationPushOptions<RxDocType>,\r\n        public readonly live: boolean = true,\r\n        public retryTime: number = 1000 * 5,\r\n        public autoStart: boolean = true\r\n    ) {\r\n        super(\r\n            replicationIdentifierHash,\r\n            collection,\r\n            '_deleted',\r\n            pull,\r\n            push,\r\n            live,\r\n            retryTime,\r\n            autoStart\r\n        );\r\n    }\r\n}\r\n\r\nexport function replicateFirestore<RxDocType>(\r\n    options: SyncOptionsFirestore<RxDocType>\r\n): RxFirestoreReplicationState<RxDocType> {\r\n    const collection: RxCollection<RxDocType> = options.collection;\r\n    addRxPlugin(RxDBLeaderElectionPlugin);\r\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, FirestoreCheckpointType>> = new Subject();\r\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, FirestoreCheckpointType> | undefined;\r\n    options.live = typeof options.live === 'undefined' ? true : options.live;\r\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\r\n    const serverTimestampField = typeof options.serverTimestampField === 'undefined' ? 'serverTimestamp' : options.serverTimestampField;\r\n    options.serverTimestampField = serverTimestampField;\r\n    const primaryPath = collection.schema.primaryPath;\r\n\r\n    /**\r\n     * The serverTimestampField MUST NOT be part of the collections RxJsonSchema.\r\n     */\r\n    const schemaPart = getSchemaByObjectPath(collection.schema.jsonSchema, serverTimestampField);\r\n    if (\r\n        schemaPart ||\r\n        // also must not be nested.\r\n        serverTimestampField.includes('.')\r\n    ) {\r\n        throw newRxError('RC6', {\r\n            field: serverTimestampField,\r\n            schema: collection.schema.jsonSchema\r\n        });\r\n    }\r\n\r\n    const pullFilters = options.pull?.filter !== undefined\r\n        ? toArray(options.pull.filter)\r\n        : [];\r\n\r\n    const pullQuery = query(options.firestore.collection, ...pullFilters);\r\n\r\n    if (options.pull) {\r\n        replicationPrimitivesPull = {\r\n            async handler(\r\n                lastPulledCheckpoint: FirestoreCheckpointType | undefined,\r\n                batchSize: number\r\n            ) {\r\n                let newerQuery: ReturnType<typeof query>;\r\n                let sameTimeQuery: ReturnType<typeof query> | undefined;\r\n\r\n                if (lastPulledCheckpoint) {\r\n                    const lastServerTimestamp = isoStringToServerTimestamp(lastPulledCheckpoint.serverTimestamp);\r\n                    newerQuery = query(pullQuery,\r\n                        where(serverTimestampField, '>', lastServerTimestamp),\r\n                        orderBy(serverTimestampField, 'asc'),\r\n                        limit(batchSize)\r\n                    );\r\n                    sameTimeQuery = query(pullQuery,\r\n                        where(serverTimestampField, '==', lastServerTimestamp),\r\n                        where(documentId(), '>', lastPulledCheckpoint.id),\r\n                        orderBy(documentId(), 'asc'),\r\n                        limit(batchSize)\r\n                    );\r\n                } else {\r\n                    newerQuery = query(pullQuery,\r\n                        orderBy(serverTimestampField, 'asc'),\r\n                        limit(batchSize)\r\n                    );\r\n                }\r\n\r\n                let mustsReRun = true;\r\n                let useDocs: QueryDocumentSnapshot<RxDocType>[] = [];\r\n                while (mustsReRun) {\r\n                    /**\r\n                     * Local writes that have not been persisted to the server\r\n                     * are in pending state and do not have a correct serverTimestamp set.\r\n                     * We have to ensure we only use document states that are in sync with the server.\r\n                     * @link https://medium.com/firebase-developers/the-secrets-of-firestore-fieldvalue-servertimestamp-revealed-29dd7a38a82b\r\n                     */\r\n                    await waitForPendingWrites(options.firestore.database);\r\n                    await runTransaction(options.firestore.database, async (_tx) => {\r\n                        useDocs = [];\r\n                        const [\r\n                            newerQueryResult,\r\n                            sameTimeQueryResult\r\n                        ] = await Promise.all([\r\n                            getDocs(newerQuery),\r\n                            sameTimeQuery ? getDocs(sameTimeQuery) : undefined\r\n                        ]);\r\n\r\n                        if (\r\n                            newerQueryResult.metadata.hasPendingWrites ||\r\n                            (sameTimeQuery && ensureNotFalsy(sameTimeQueryResult).metadata.hasPendingWrites)\r\n                        ) {\r\n                            return;\r\n                        } else {\r\n                            mustsReRun = false;\r\n\r\n                            if (sameTimeQuery) {\r\n                                useDocs = ensureNotFalsy(sameTimeQueryResult).docs as any;\r\n                            }\r\n                            const missingAmount = batchSize - useDocs.length;\r\n                            if (missingAmount > 0) {\r\n                                const additionalDocs = newerQueryResult.docs.slice(0, missingAmount).filter(x => !!x);\r\n                                appendToArray(useDocs, additionalDocs);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n\r\n                if (useDocs.length === 0) {\r\n                    return {\r\n                        checkpoint: lastPulledCheckpoint ?? null,\r\n                        documents: []\r\n                    };\r\n                }\r\n                const lastDoc = ensureNotFalsy(lastOfArray(useDocs));\r\n                const documents: WithDeleted<RxDocType>[] = useDocs\r\n                    .map(row => firestoreRowToDocData(\r\n                        serverTimestampField,\r\n                        primaryPath,\r\n                        row\r\n                    ));\r\n                const newCheckpoint: FirestoreCheckpointType = {\r\n                    id: lastDoc.id,\r\n                    serverTimestamp: serverTimestampToIsoString(serverTimestampField, lastDoc.data())\r\n                };\r\n                const ret = {\r\n                    documents: documents,\r\n                    checkpoint: newCheckpoint\r\n                };\r\n                return ret;\r\n            },\r\n            batchSize: ensureNotFalsy(options.pull).batchSize,\r\n            modifier: ensureNotFalsy(options.pull).modifier,\r\n            stream$: pullStream$.asObservable()\r\n        };\r\n    }\r\n\r\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\r\n    if (options.push) {\r\n        const pushFilter = options.push?.filter;\r\n        replicationPrimitivesPush = {\r\n            async handler(\r\n                rows: RxReplicationWriteToMasterRow<RxDocType>[]\r\n            ) {\r\n                if (pushFilter !== undefined) {\r\n                    rows = await asyncFilter(rows, (row) => pushFilter(row.newDocumentState));\r\n                }\r\n\r\n                const writeRowsById: ById<RxReplicationWriteToMasterRow<RxDocType>> = {};\r\n                const docIds: string[] = rows.map(row => {\r\n                    const docId = (row.newDocumentState as any)[primaryPath];\r\n                    writeRowsById[docId] = row;\r\n                    return docId;\r\n                });\r\n                await waitForPendingWrites(options.firestore.database);\r\n                let conflicts: WithDeleted<RxDocType>[] = [];\r\n\r\n                /**\r\n                 * Everything must run INSIDE of the transaction\r\n                 * because on tx-errors, firebase will re-run the transaction on some cases.\r\n                 * @link https://firebase.google.com/docs/firestore/manage-data/transactions#transaction_failure\r\n                 * @link https://firebase.google.com/docs/firestore/manage-data/transactions\r\n                 */\r\n                await runTransaction(options.firestore.database, async (_tx) => {\r\n                    conflicts = []; // reset in case the tx has re-run.\r\n                    /**\r\n                     * @link https://stackoverflow.com/a/48423626/3443137\r\n                     */\r\n\r\n                    const getQuery = (ids: string[]) => {\r\n                        return getDocs(\r\n                            query(\r\n                                options.firestore.collection,\r\n                                where(documentId(), 'in', ids)\r\n                            )\r\n                        );\r\n                    };\r\n\r\n                    const docsInDbResult = await getContentByIds<RxDocType>(docIds, getQuery);\r\n\r\n                    const docsInDbById: ById<RxDocType> = {};\r\n                    docsInDbResult.forEach(row => {\r\n                        const docDataInDb = stripServerTimestampField(serverTimestampField, row.data());\r\n                        const docId = row.id;\r\n                        (docDataInDb as any)[primaryPath] = docId;\r\n                        docsInDbById[docId] = docDataInDb;\r\n                    });\r\n\r\n                    /**\r\n                     * @link https://firebase.google.com/docs/firestore/manage-data/transactions#batched-writes\r\n                     */\r\n                    const batch = writeBatch(options.firestore.database);\r\n                    let hasWrite = false;\r\n                    await Promise.all(\r\n                        Object.entries(writeRowsById).map(async ([docId, writeRow]) => {\r\n                            const docInDb: RxDocType | undefined = docsInDbById[docId];\r\n\r\n                            if (\r\n                                docInDb &&\r\n                                (\r\n                                    !writeRow.assumedMasterState ||\r\n                                    collection.conflictHandler.isEqual(docInDb as any, writeRow.assumedMasterState, 'replication-firestore-push') === false\r\n                                )\r\n                            ) {\r\n                                // conflict\r\n                                conflicts.push(docInDb as any);\r\n                            } else {\r\n                                // no conflict\r\n                                hasWrite = true;\r\n                                const docRef = doc(options.firestore.collection, docId);\r\n                                const writeDocData = flatClone(writeRow.newDocumentState);\r\n                                (writeDocData as any)[serverTimestampField] = serverTimestamp();\r\n                                if (!docInDb) {\r\n                                    // insert\r\n                                    batch.set(docRef, stripPrimaryKey(primaryPath, writeDocData));\r\n                                } else {\r\n                                    // update\r\n                                    batch.update(docRef, stripPrimaryKey(primaryPath, writeDocData));\r\n                                }\r\n                            }\r\n                        })\r\n                    );\r\n\r\n                    if (hasWrite) {\r\n                        await batch.commit();\r\n                    }\r\n                });\r\n                await waitForPendingWrites(options.firestore.database);\r\n                return conflicts;\r\n            },\r\n            batchSize: options.push.batchSize,\r\n            modifier: options.push.modifier\r\n        };\r\n    }\r\n\r\n\r\n    const replicationState = new RxFirestoreReplicationState<RxDocType>(\r\n        options.firestore,\r\n        options.replicationIdentifier,\r\n        collection,\r\n        replicationPrimitivesPull,\r\n        replicationPrimitivesPush,\r\n        options.live,\r\n        options.retryTime,\r\n        options.autoStart\r\n    );\r\n\r\n    /**\r\n     * Use long polling to get live changes for the pull.stream$\r\n     */\r\n    if (options.live && options.pull) {\r\n        const startBefore = replicationState.start.bind(replicationState);\r\n        const cancelBefore = replicationState.cancel.bind(replicationState);\r\n        replicationState.start = () => {\r\n            const lastChangeQuery = query(\r\n                pullQuery,\r\n                orderBy(serverTimestampField, 'desc'),\r\n                limit(1)\r\n            );\r\n            const unsubscribe = onSnapshot(\r\n                lastChangeQuery,\r\n                (_querySnapshot) => {\r\n                    /**\r\n                     * There is no good way to observe the event stream in firestore.\r\n                     * So instead we listen to any write to the collection\r\n                     * and then emit a 'RESYNC' flag.\r\n                     */\r\n                    replicationState.reSync();\r\n                },\r\n                (error) => {\r\n                    replicationState.subjects.error.next(\r\n                        newRxError('RC_STREAM', { error: errorToPlainJson(error) })\r\n                    );\r\n                }\r\n            );\r\n            replicationState.cancel = () => {\r\n                unsubscribe();\r\n                return cancelBefore();\r\n            };\r\n            return startBefore();\r\n        };\r\n    }\r\n\r\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\r\n\r\n    return replicationState;\r\n}\r\n"],"mappings":"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","ignoreList":[]}