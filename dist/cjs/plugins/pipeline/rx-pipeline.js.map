{"version":3,"file":"rx-pipeline.js","names":["_rxjs","require","_index","_rxStorageHelper","_docCache","_rxDatabaseInternalStore","_flaggedFunctions","RxPipeline","exports","identifier","source","destination","handler","batchSize","processQueue","PROMISE_RESOLVE_VOID","subs","stopped","toRun","lastSourceDocTime","BehaviorSubject","lastProcessedDocTime","somethingChanged","Subject","secretFunctionName","randomToken","waitBeforeWriteFn","stack","Error","includes","awaitIdle","checkpointId","onClose","push","close","awaitBeforeReads","add","eventBulks$","subscribe","bulk","next","events","documentData","_meta","lwt","database","internalStore","changeStream","eventBulk","index","length","event","context","INTERNAL_CONTEXT_PIPELINE_CHECKPOINT","key","data","lastDocTime","_proto","prototype","trigger","_this2","then","done","_loop","checkpointDoc","getCheckpointDoc","checkpoint","undefined","docsSinceResult","getChangedDocumentsSince","storageInstance","lastTime","documents","rxDocuments","mapDocumentsDataToCacheDocs","_this","fnKey","blockFlaggedFunctionKey","FLAGGED_FUNCTIONS","err","error","releaseFlaggedFunctionKey","v","ensureNotFalsy","lastOfArray","closed","setCheckpointDoc","_ret","getValue","firstValueFrom","delete","forEach","s","unsubscribe","remove","insternalStore","newDoc","clone","_deleted","writeResult","bulkWrite","previous","document","pipeline","getPrimaryKeyOfInternalDocument","results","findDocumentsById","result","newCheckpoint","_attachments","now","_rev","createRevision","token","id","addPipeline","options","waitForLeadership","startPromise","pipe","filter","isLocal"],"sources":["../../../../src/plugins/pipeline/rx-pipeline.ts"],"sourcesContent":["import {\r\n    BehaviorSubject,\r\n    Subject,\r\n    Subscription,\r\n    filter,\r\n    firstValueFrom,\r\n    race\r\n} from 'rxjs';\r\nimport type {\r\n    InternalStoreDocType,\r\n    RxCollection,\r\n    RxDocument,\r\n    RxDocumentData\r\n} from '../../types';\r\nimport type {\r\n    CheckpointDocData,\r\n    RxPipelineHandler,\r\n    RxPipelineOptions\r\n} from './types';\r\nimport {\r\n    PROMISE_RESOLVE_VOID,\r\n    clone,\r\n    createRevision,\r\n    ensureNotFalsy,\r\n    lastOfArray,\r\n    nameFunction,\r\n    now,\r\n    promiseWait,\r\n    randomToken\r\n} from '../utils/index.ts';\r\nimport { getChangedDocumentsSince } from '../../rx-storage-helper.ts';\r\nimport { mapDocumentsDataToCacheDocs } from '../../doc-cache.ts';\r\nimport { INTERNAL_CONTEXT_PIPELINE_CHECKPOINT, getPrimaryKeyOfInternalDocument } from '../../rx-database-internal-store.ts';\r\nimport { FLAGGED_FUNCTIONS, blockFlaggedFunctionKey, releaseFlaggedFunctionKey } from './flagged-functions.ts';\r\n\r\nexport class RxPipeline<RxDocType> {\r\n    processQueue = PROMISE_RESOLVE_VOID;\r\n    subs: Subscription[] = [];\r\n    stopped: boolean = false;\r\n\r\n    toRun = 1;\r\n    checkpointId: string;\r\n\r\n    lastSourceDocTime = new BehaviorSubject(-1);\r\n    lastProcessedDocTime = new BehaviorSubject(0);\r\n    somethingChanged = new Subject();\r\n\r\n\r\n    secretFunctionName = 'tx_fn_' + randomToken(10)\r\n\r\n    waitBeforeWriteFn = async () => {\r\n        const stack = new Error().stack;\r\n        if (stack && (\r\n            stack.includes(this.secretFunctionName)\r\n        )) {\r\n        } else {\r\n            await this.awaitIdle();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The handler of the pipeline must never throw.\r\n     * If it did anyway, the pipeline will be stuck and always\r\n     * throw the previous error on all operations.\r\n     */\r\n    error: any;\r\n\r\n    constructor(\r\n        public readonly identifier: string,\r\n        public readonly source: RxCollection<RxDocType>,\r\n        public readonly destination: RxCollection<any>,\r\n        public readonly handler: RxPipelineHandler<RxDocType>,\r\n        public readonly batchSize = 100\r\n    ) {\r\n        this.checkpointId = 'rx-pipeline-' + identifier;\r\n        this.source.onClose.push(() => this.close());\r\n        this.destination.awaitBeforeReads.add(this.waitBeforeWriteFn);\r\n        this.subs.push(\r\n            this.source.eventBulks$.subscribe((bulk) => {\r\n                this.lastSourceDocTime.next(bulk.events[0].documentData._meta.lwt);\r\n                this.somethingChanged.next({});\r\n            })\r\n        );\r\n        this.subs.push(\r\n            this.destination.database.internalStore\r\n                .changeStream()\r\n                .subscribe(eventBulk => {\r\n                    const events = eventBulk.events;\r\n                    for (let index = 0; index < events.length; index++) {\r\n                        const event = events[index];\r\n                        if (\r\n                            event.documentData.context === INTERNAL_CONTEXT_PIPELINE_CHECKPOINT &&\r\n                            event.documentData.key === this.checkpointId\r\n                        ) {\r\n                            this.lastProcessedDocTime.next(event.documentData.data.lastDocTime);\r\n                            this.somethingChanged.next({});\r\n                        }\r\n                    }\r\n                })\r\n        );\r\n    }\r\n\r\n    trigger() {\r\n        /**\r\n         * Do not stack up too many\r\n         * so that fast writes to the source collection\r\n         * do not block anything too long.\r\n         */\r\n        if (this.toRun > 2) {\r\n            return;\r\n        }\r\n        this.toRun = this.toRun + 1;\r\n\r\n        this.processQueue = this.processQueue.then(async () => {\r\n            this.toRun = this.toRun - 1;\r\n\r\n            let done = false;\r\n            while (\r\n                !done &&\r\n                !this.stopped &&\r\n                !this.destination.closed &&\r\n                !this.source.closed &&\r\n                !this.error\r\n            ) {\r\n                const checkpointDoc = await getCheckpointDoc(this);\r\n                const checkpoint = checkpointDoc ? checkpointDoc.data.checkpoint : undefined;\r\n                const docsSinceResult = await getChangedDocumentsSince(\r\n                    this.source.storageInstance,\r\n                    this.batchSize,\r\n                    checkpoint\r\n                );\r\n\r\n                let lastTime = checkpointDoc ? checkpointDoc.data.lastDocTime : 0;\r\n                if (docsSinceResult.documents.length > 0) {\r\n                    const rxDocuments = mapDocumentsDataToCacheDocs(this.source._docCache, docsSinceResult.documents);\r\n                    const _this = this;\r\n\r\n\r\n\r\n                    // const o: any = {};\r\n                    // eval(`\r\n                    //     async function ${this.secretFunctionName}(docs){ const x = await _this.handler(docs); return x; }\r\n                    //     o.${this.secretFunctionName} = ${this.secretFunctionName};\r\n                    // `);\r\n                    // await o[this.secretFunctionName](rxDocuments);\r\n\r\n                    const fnKey = blockFlaggedFunctionKey();\r\n                    this.secretFunctionName = fnKey;\r\n                    try {\r\n                        await FLAGGED_FUNCTIONS[fnKey](() => _this.handler(rxDocuments));\r\n                    } catch (err: any) {\r\n                        this.error = err;\r\n                    } finally {\r\n                        releaseFlaggedFunctionKey(fnKey);\r\n                    }\r\n\r\n                    if (this.error) {\r\n                        return;\r\n                    }\r\n\r\n                    lastTime = ensureNotFalsy(lastOfArray(docsSinceResult.documents))._meta.lwt;\r\n                }\r\n                if (!this.destination.closed) {\r\n                    await setCheckpointDoc(this, { checkpoint: docsSinceResult.checkpoint, lastDocTime: lastTime }, checkpointDoc);\r\n                }\r\n                if (docsSinceResult.documents.length < this.batchSize) {\r\n                    done = true;\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    async awaitIdle() {\r\n        if (this.error) {\r\n            throw this.error;\r\n        }\r\n        let done = false;\r\n        while (!done) {\r\n            await this.processQueue;\r\n            if (this.error) {\r\n                throw this.error;\r\n            }\r\n            if (this.lastProcessedDocTime.getValue() >= this.lastSourceDocTime.getValue()) {\r\n                done = true;\r\n            } else {\r\n                await firstValueFrom(this.somethingChanged);\r\n            }\r\n        }\r\n    }\r\n\r\n    async close() {\r\n        await this.processQueue;\r\n        this.stopped = true;\r\n        this.destination.awaitBeforeReads.delete(this.waitBeforeWriteFn);\r\n        this.subs.forEach(s => s.unsubscribe());\r\n        await this.processQueue;\r\n    }\r\n\r\n    /**\r\n     * Remove the pipeline and all metadata which it has stored\r\n     */\r\n    async remove() {\r\n        const insternalStore = this.destination.database.internalStore;\r\n        const checkpointDoc = await getCheckpointDoc(this);\r\n        if (checkpointDoc) {\r\n            const newDoc: RxDocumentData<InternalStoreDocType> = clone(checkpointDoc);\r\n            newDoc._deleted = true;\r\n            const writeResult = await insternalStore.bulkWrite([{\r\n                previous: checkpointDoc,\r\n                document: newDoc,\r\n            }], 'rx-pipeline');\r\n            if (writeResult.error.length > 0) {\r\n                throw writeResult.error;\r\n            }\r\n        }\r\n        return this.close();\r\n    }\r\n}\r\n\r\n\r\nexport async function getCheckpointDoc<RxDocType>(\r\n    pipeline: RxPipeline<RxDocType>\r\n): Promise<RxDocumentData<InternalStoreDocType<CheckpointDocData>> | undefined> {\r\n    const insternalStore = pipeline.destination.database.internalStore;\r\n    const checkpointId = getPrimaryKeyOfInternalDocument(\r\n        pipeline.checkpointId,\r\n        INTERNAL_CONTEXT_PIPELINE_CHECKPOINT\r\n    );\r\n    const results = await insternalStore.findDocumentsById([checkpointId], false);\r\n    const result: RxDocumentData<InternalStoreDocType> = results[0];\r\n    if (result) {\r\n        return result;\r\n    } else {\r\n        return undefined;\r\n    }\r\n}\r\n\r\nexport async function setCheckpointDoc<RxDocType>(\r\n    pipeline: RxPipeline<RxDocType>,\r\n    newCheckpoint: CheckpointDocData,\r\n    previous?: RxDocumentData<InternalStoreDocType>\r\n): Promise<void> {\r\n    const insternalStore = pipeline.destination.database.internalStore;\r\n    const newDoc: RxDocumentData<InternalStoreDocType<CheckpointDocData>> = {\r\n        _attachments: {},\r\n        _deleted: false,\r\n        _meta: {\r\n            lwt: now()\r\n        },\r\n        _rev: createRevision(pipeline.destination.database.token, previous),\r\n        context: INTERNAL_CONTEXT_PIPELINE_CHECKPOINT,\r\n        data: newCheckpoint,\r\n        id: getPrimaryKeyOfInternalDocument(\r\n            pipeline.checkpointId,\r\n            INTERNAL_CONTEXT_PIPELINE_CHECKPOINT\r\n        ),\r\n        key: pipeline.checkpointId\r\n    };\r\n\r\n    const writeResult = await insternalStore.bulkWrite([{\r\n        previous,\r\n        document: newDoc,\r\n    }], 'rx-pipeline');\r\n    if (writeResult.error.length > 0) {\r\n        throw writeResult.error;\r\n    }\r\n}\r\n\r\n\r\nexport async function addPipeline<RxDocType>(\r\n    this: RxCollection<RxDocType>,\r\n    options: RxPipelineOptions<RxDocType>\r\n): Promise<RxPipeline<RxDocType>> {\r\n    const pipeline = new RxPipeline<RxDocType>(\r\n        options.identifier,\r\n        this,\r\n        options.destination,\r\n        options.handler,\r\n        options.batchSize\r\n    );\r\n    const waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\r\n    const startPromise = waitForLeadership ? this.database.waitForLeadership() : PROMISE_RESOLVE_VOID;\r\n    startPromise.then(() => {\r\n        pipeline.trigger();\r\n        pipeline.subs.push(\r\n            this.eventBulks$.pipe(\r\n                filter(bulk => {\r\n                    if (pipeline.stopped) {\r\n                        return false;\r\n                    }\r\n                    return !bulk.isLocal;\r\n                })\r\n            ).subscribe(() => pipeline.trigger())\r\n        );\r\n    });\r\n\r\n    return pipeline;\r\n}\r\n"],"mappings":"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","ignoreList":[]}