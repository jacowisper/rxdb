{"version":3,"file":"couchdb-helper.js","names":["_index","require","COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX","exports","mergeUrlQueryParams","params","Object","entries","filter","_k","value","map","key","join","couchDBDocToRxDocData","primaryPath","couchDocData","doc","couchSwapIdToPrimary","_deleted","_rev","primaryKey","docData","flatClone","_id","couchSwapPrimaryToId","idValue","ret","getDefaultFetch","window","fetch","bind","getFetchWithCouchDBAuthorization","username","password","url","options","assign","headers","b64EncodeUnicode"],"sources":["../../../../src/plugins/replication-couchdb/couchdb-helper.ts"],"sourcesContent":["import type {\r\n    RxDocumentData,\r\n    StringKeys,\r\n    WithDeleted\r\n} from '../../types/index.d.ts';\r\nimport { b64EncodeUnicode, flatClone } from '../../plugins/utils/index.ts';\r\nimport { URLQueryParams } from './couchdb-types.ts';\r\n\r\n\r\nexport const COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX = 'couchdb';\r\n\r\n\r\nexport function mergeUrlQueryParams(\r\n    params: URLQueryParams\r\n): string {\r\n    return Object.entries(params)\r\n        .filter(([_k, value]) => typeof value !== 'undefined')\r\n        .map(([key, value]) => key + '=' + value)\r\n        .join('&');\r\n}\r\n\r\nexport function couchDBDocToRxDocData<RxDocType>(\r\n    primaryPath: string,\r\n    couchDocData: any\r\n): WithDeleted<RxDocType> {\r\n    const doc = couchSwapIdToPrimary(primaryPath as any, couchDocData);\r\n\r\n    // ensure deleted flag is set.\r\n    doc._deleted = !!doc._deleted;\r\n\r\n    delete doc._rev;\r\n\r\n    return doc;\r\n}\r\n\r\n\r\nexport function couchSwapIdToPrimary<T>(\r\n    primaryKey: StringKeys<RxDocumentData<T>>,\r\n    docData: any\r\n): any {\r\n    if (primaryKey === '_id' || docData[primaryKey]) {\r\n        return flatClone(docData);\r\n    }\r\n    docData = flatClone(docData);\r\n    docData[primaryKey] = docData._id;\r\n    delete docData._id;\r\n\r\n    return docData;\r\n}\r\n\r\n/**\r\n * Swaps the primaryKey of the document\r\n * to the _id property.\r\n */\r\nexport function couchSwapPrimaryToId<RxDocType>(\r\n    primaryKey: StringKeys<RxDocumentData<RxDocType>>,\r\n    docData: any\r\n): RxDocType & { _id: string; } {\r\n    // optimisation shortcut\r\n    if (primaryKey === '_id') {\r\n        return docData;\r\n    }\r\n\r\n    const idValue = docData[primaryKey];\r\n    const ret = flatClone(docData);\r\n    delete ret[primaryKey];\r\n    ret._id = idValue;\r\n    return ret;\r\n}\r\n\r\n\r\nexport function getDefaultFetch() {\r\n    if (\r\n        typeof window === 'object' &&\r\n        (window as any)['fetch']\r\n    ) {\r\n        /**\r\n         * @link https://stackoverflow.com/a/47180009/3443137\r\n         */\r\n        return window.fetch.bind(window);\r\n    } else {\r\n        return fetch;\r\n    }\r\n}\r\n\r\n/**\r\n * Returns a fetch handler that contains the username and password\r\n * in the Authorization header\r\n */\r\nexport function getFetchWithCouchDBAuthorization(username: string, password: string): typeof fetch {\r\n    const ret: typeof fetch = (url, options) => {\r\n        options = Object.assign({}, options);\r\n        if (!options.headers) {\r\n            options.headers = {};\r\n        }\r\n        (options as any).headers['Authorization'] = 'Basic ' + b64EncodeUnicode(username + ':' + password);\r\n        return fetch(url as any, options);\r\n    };\r\n    return ret;\r\n}\r\n"],"mappings":";;;;;;;;;;;;AAKA,IAAAA,MAAA,GAAAC,OAAA;AAIO,IAAMC,8CAA8C,GAAAC,OAAA,CAAAD,8CAAA,GAAG,SAAS;AAGhE,SAASE,mBAAmBA,CAC/BC,MAAsB,EAChB;EACN,OAAOC,MAAM,CAACC,OAAO,CAACF,MAAM,CAAC,CACxBG,MAAM,CAAC,CAAC,CAACC,EAAE,EAAEC,KAAK,CAAC,KAAK,OAAOA,KAAK,KAAK,WAAW,CAAC,CACrDC,GAAG,CAAC,CAAC,CAACC,GAAG,EAAEF,KAAK,CAAC,KAAKE,GAAG,GAAG,GAAG,GAAGF,KAAK,CAAC,CACxCG,IAAI,CAAC,GAAG,CAAC;AAClB;AAEO,SAASC,qBAAqBA,CACjCC,WAAmB,EACnBC,YAAiB,EACK;EACtB,IAAMC,GAAG,GAAGC,oBAAoB,CAACH,WAAW,EAASC,YAAY,CAAC;;EAElE;EACAC,GAAG,CAACE,QAAQ,GAAG,CAAC,CAACF,GAAG,CAACE,QAAQ;EAE7B,OAAOF,GAAG,CAACG,IAAI;EAEf,OAAOH,GAAG;AACd;AAGO,SAASC,oBAAoBA,CAChCG,UAAyC,EACzCC,OAAY,EACT;EACH,IAAID,UAAU,KAAK,KAAK,IAAIC,OAAO,CAACD,UAAU,CAAC,EAAE;IAC7C,OAAO,IAAAE,gBAAS,EAACD,OAAO,CAAC;EAC7B;EACAA,OAAO,GAAG,IAAAC,gBAAS,EAACD,OAAO,CAAC;EAC5BA,OAAO,CAACD,UAAU,CAAC,GAAGC,OAAO,CAACE,GAAG;EACjC,OAAOF,OAAO,CAACE,GAAG;EAElB,OAAOF,OAAO;AAClB;;AAEA;AACA;AACA;AACA;AACO,SAASG,oBAAoBA,CAChCJ,UAAiD,EACjDC,OAAY,EACgB;EAC5B;EACA,IAAID,UAAU,KAAK,KAAK,EAAE;IACtB,OAAOC,OAAO;EAClB;EAEA,IAAMI,OAAO,GAAGJ,OAAO,CAACD,UAAU,CAAC;EACnC,IAAMM,GAAG,GAAG,IAAAJ,gBAAS,EAACD,OAAO,CAAC;EAC9B,OAAOK,GAAG,CAACN,UAAU,CAAC;EACtBM,GAAG,CAACH,GAAG,GAAGE,OAAO;EACjB,OAAOC,GAAG;AACd;AAGO,SAASC,eAAeA,CAAA,EAAG;EAC9B,IACI,OAAOC,MAAM,KAAK,QAAQ,IACzBA,MAAM,CAAS,OAAO,CAAC,EAC1B;IACE;AACR;AACA;IACQ,OAAOA,MAAM,CAACC,KAAK,CAACC,IAAI,CAACF,MAAM,CAAC;EACpC,CAAC,MAAM;IACH,OAAOC,KAAK;EAChB;AACJ;;AAEA;AACA;AACA;AACA;AACO,SAASE,gCAAgCA,CAACC,QAAgB,EAAEC,QAAgB,EAAgB;EAC/F,IAAMP,GAAiB,GAAGA,CAACQ,GAAG,EAAEC,OAAO,KAAK;IACxCA,OAAO,GAAG9B,MAAM,CAAC+B,MAAM,CAAC,CAAC,CAAC,EAAED,OAAO,CAAC;IACpC,IAAI,CAACA,OAAO,CAACE,OAAO,EAAE;MAClBF,OAAO,CAACE,OAAO,GAAG,CAAC,CAAC;IACxB;IACCF,OAAO,CAASE,OAAO,CAAC,eAAe,CAAC,GAAG,QAAQ,GAAG,IAAAC,uBAAgB,EAACN,QAAQ,GAAG,GAAG,GAAGC,QAAQ,CAAC;IAClG,OAAOJ,KAAK,CAACK,GAAG,EAASC,OAAO,CAAC;EACrC,CAAC;EACD,OAAOT,GAAG;AACd","ignoreList":[]}