{"version":3,"file":"helper.js","names":["_index","require","_rxStorageHelper","docStateToWriteDoc","databaseInstanceToken","hasAttachments","keepMeta","docState","previous","docData","Object","assign","_attachments","_meta","lwt","now","_rev","getDefaultRevision","createRevision","writeDocToDocState","writeDoc","keepAttachments","ret","flatClone","stripAttachmentsDataFromMetaWriteRows","state","rows","map","row","document","clone","stripAttachmentsDataFromDocument","getUnderlyingPersistentStorage","instance","underlyingPersistentStorage"],"sources":["../../../src/replication-protocol/helper.ts"],"sourcesContent":["import type {\r\n    BulkWriteRow,\r\n    RxDocumentData,\r\n    RxDocumentWriteData,\r\n    RxStorageInstance,\r\n    RxStorageInstanceReplicationState,\r\n    RxStorageReplicationMeta,\r\n    WithDeletedAndAttachments\r\n} from '../types/index.d.ts';\r\nimport {\r\n    clone,\r\n    createRevision,\r\n    flatClone,\r\n    getDefaultRevision,\r\n    now\r\n} from '../plugins/utils/index.ts';\r\nimport { stripAttachmentsDataFromDocument } from '../rx-storage-helper.ts';\r\n\r\nexport function docStateToWriteDoc<RxDocType>(\r\n    databaseInstanceToken: string,\r\n    hasAttachments: boolean,\r\n    keepMeta: boolean,\r\n    docState: WithDeletedAndAttachments<RxDocType>,\r\n    previous?: RxDocumentData<RxDocType>\r\n): RxDocumentWriteData<RxDocType> {\r\n    const docData: RxDocumentWriteData<RxDocType> = Object.assign(\r\n        {},\r\n        docState,\r\n        {\r\n            _attachments: hasAttachments && docState._attachments ? docState._attachments : {},\r\n            _meta: keepMeta ? (docState as any)._meta : Object.assign(\r\n                {},\r\n                previous ? previous._meta : {},\r\n                {\r\n                    lwt: now()\r\n                }\r\n            ),\r\n            _rev: keepMeta ? (docState as any)._rev : getDefaultRevision()\r\n        }\r\n    );\r\n    if (!docData._rev) {\r\n        docData._rev = createRevision(\r\n            databaseInstanceToken,\r\n            previous\r\n        );\r\n    }\r\n\r\n    return docData;\r\n}\r\n\r\nexport function writeDocToDocState<RxDocType>(\r\n    writeDoc: RxDocumentData<RxDocType>,\r\n    keepAttachments: boolean,\r\n    keepMeta: boolean\r\n): WithDeletedAndAttachments<RxDocType> {\r\n    const ret = flatClone(writeDoc);\r\n\r\n    if (!keepAttachments) {\r\n        delete (ret as any)._attachments;\r\n    }\r\n    if (!keepMeta) {\r\n        delete (ret as any)._meta;\r\n        delete (ret as any)._rev;\r\n    }\r\n    return ret;\r\n}\r\n\r\n\r\nexport function stripAttachmentsDataFromMetaWriteRows<RxDocType>(\r\n    state: RxStorageInstanceReplicationState<any>,\r\n    rows: BulkWriteRow<RxStorageReplicationMeta<RxDocType, any>>[]\r\n): BulkWriteRow<RxStorageReplicationMeta<RxDocType, any>>[] {\r\n    if (!state.hasAttachments) {\r\n        return rows;\r\n    }\r\n    return rows.map(row => {\r\n        const document = clone(row.document);\r\n        document.docData = stripAttachmentsDataFromDocument(document.docData);\r\n        return {\r\n            document,\r\n            previous: row.previous\r\n        };\r\n    });\r\n}\r\n\r\nexport function getUnderlyingPersistentStorage<RxDocType>(\r\n    instance: RxStorageInstance<RxDocType, any, any, any>\r\n): RxStorageInstance<RxDocType, any, any, any> {\r\n    while (true) {\r\n        if (instance.underlyingPersistentStorage) {\r\n            instance = instance.underlyingPersistentStorage;\r\n        } else {\r\n            return instance;\r\n        }\r\n    }\r\n}\r\n"],"mappings":";;;;;;;;;AASA,IAAAA,MAAA,GAAAC,OAAA;AAOA,IAAAC,gBAAA,GAAAD,OAAA;AAEO,SAASE,kBAAkBA,CAC9BC,qBAA6B,EAC7BC,cAAuB,EACvBC,QAAiB,EACjBC,QAA8C,EAC9CC,QAAoC,EACN;EAC9B,IAAMC,OAAuC,GAAGC,MAAM,CAACC,MAAM,CACzD,CAAC,CAAC,EACFJ,QAAQ,EACR;IACIK,YAAY,EAAEP,cAAc,IAAIE,QAAQ,CAACK,YAAY,GAAGL,QAAQ,CAACK,YAAY,GAAG,CAAC,CAAC;IAClFC,KAAK,EAAEP,QAAQ,GAAIC,QAAQ,CAASM,KAAK,GAAGH,MAAM,CAACC,MAAM,CACrD,CAAC,CAAC,EACFH,QAAQ,GAAGA,QAAQ,CAACK,KAAK,GAAG,CAAC,CAAC,EAC9B;MACIC,GAAG,EAAE,IAAAC,UAAG,EAAC;IACb,CACJ,CAAC;IACDC,IAAI,EAAEV,QAAQ,GAAIC,QAAQ,CAASS,IAAI,GAAG,IAAAC,yBAAkB,EAAC;EACjE,CACJ,CAAC;EACD,IAAI,CAACR,OAAO,CAACO,IAAI,EAAE;IACfP,OAAO,CAACO,IAAI,GAAG,IAAAE,qBAAc,EACzBd,qBAAqB,EACrBI,QACJ,CAAC;EACL;EAEA,OAAOC,OAAO;AAClB;AAEO,SAASU,kBAAkBA,CAC9BC,QAAmC,EACnCC,eAAwB,EACxBf,QAAiB,EACmB;EACpC,IAAMgB,GAAG,GAAG,IAAAC,gBAAS,EAACH,QAAQ,CAAC;EAE/B,IAAI,CAACC,eAAe,EAAE;IAClB,OAAQC,GAAG,CAASV,YAAY;EACpC;EACA,IAAI,CAACN,QAAQ,EAAE;IACX,OAAQgB,GAAG,CAAST,KAAK;IACzB,OAAQS,GAAG,CAASN,IAAI;EAC5B;EACA,OAAOM,GAAG;AACd;AAGO,SAASE,qCAAqCA,CACjDC,KAA6C,EAC7CC,IAA8D,EACN;EACxD,IAAI,CAACD,KAAK,CAACpB,cAAc,EAAE;IACvB,OAAOqB,IAAI;EACf;EACA,OAAOA,IAAI,CAACC,GAAG,CAACC,GAAG,IAAI;IACnB,IAAMC,QAAQ,GAAG,IAAAC,YAAK,EAACF,GAAG,CAACC,QAAQ,CAAC;IACpCA,QAAQ,CAACpB,OAAO,GAAG,IAAAsB,iDAAgC,EAACF,QAAQ,CAACpB,OAAO,CAAC;IACrE,OAAO;MACHoB,QAAQ;MACRrB,QAAQ,EAAEoB,GAAG,CAACpB;IAClB,CAAC;EACL,CAAC,CAAC;AACN;AAEO,SAASwB,8BAA8BA,CAC1CC,QAAqD,EACV;EAC3C,OAAO,IAAI,EAAE;IACT,IAAIA,QAAQ,CAACC,2BAA2B,EAAE;MACtCD,QAAQ,GAAGA,QAAQ,CAACC,2BAA2B;IACnD,CAAC,MAAM;MACH,OAAOD,QAAQ;IACnB;EACJ;AACJ","ignoreList":[]}