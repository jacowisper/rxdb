{"version":3,"file":"rx-schema.js","names":["_index","require","_rxError","_hooks","_rxSchemaHelper","_overwritable","RxSchema","exports","jsonSchema","hashFunction","indexes","getIndexes","primaryPath","getPrimaryFieldOfPrimaryKey","primaryKey","properties","maxLength","newRxError","schema","finalFields","getFinalFields","_proto","prototype","validateChange","dataBefore","dataAfter","forEach","fieldName","deepEqual","getDocumentPrototype","proto","pathProperties","getSchemaByObjectPath","Object","keys","key","fullPath","__defineGetter__","get","undefined","ret","defineProperty","get$","enumerable","configurable","get$$","populate","overwriteGetterForCaching","getPrimaryOfDocumentData","documentData","getComposedPrimaryKeyOfDocumentData","_createClass2","default","version","values","entries","filter","v","hasOwnProperty","call","k","JSON","stringify","map","index","isMaybeReadonlyArray","getPreviousVersions","c","Array","fill","createRxSchema","runPreCreateHooks","runPluginHooks","useJsonSchema","fillWithDefaultSettings","normalizeRxJsonSchema","overwritable","deepFreezeWhenDevMode","isRxSchema","obj","toTypedRxJsonSchema"],"sources":["../../src/rx-schema.ts"],"sourcesContent":["import {\r\n    overwriteGetterForCaching,\r\n    isMaybeReadonlyArray,\r\n    deepEqual\r\n} from './plugins/utils/index.ts';\r\nimport {\r\n    newRxError,\r\n} from './rx-error.ts';\r\nimport {\r\n    runPluginHooks\r\n} from './hooks.ts';\r\n\r\nimport type {\r\n    DeepMutable,\r\n    DeepReadonly,\r\n    HashFunction,\r\n    MaybeReadonly,\r\n    RxDocument,\r\n    RxDocumentData,\r\n    RxJsonSchema,\r\n    StringKeys\r\n} from './types/index.d.ts';\r\nimport {\r\n    fillWithDefaultSettings,\r\n    getComposedPrimaryKeyOfDocumentData,\r\n    getFinalFields,\r\n    getPrimaryFieldOfPrimaryKey,\r\n    getSchemaByObjectPath,\r\n    normalizeRxJsonSchema\r\n} from './rx-schema-helper.ts';\r\nimport { overwritable } from './overwritable.ts';\r\n\r\nexport class RxSchema<RxDocType = any> {\r\n    public indexes: MaybeReadonly<string[]>[];\r\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\r\n    public finalFields: string[];\r\n\r\n    constructor(\r\n        public readonly jsonSchema: RxJsonSchema<RxDocumentData<RxDocType>>,\r\n        public readonly hashFunction: HashFunction\r\n    ) {\r\n        this.indexes = getIndexes(this.jsonSchema);\r\n\r\n        // primary is always required\r\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.jsonSchema.primaryKey);\r\n\r\n        /**\r\n         * Many people accidentally put in wrong schema state\r\n         * without the dev-mode plugin, so we need this check here\r\n         * even in non-dev-mode.\r\n         */\r\n        if (!jsonSchema.properties[this.primaryPath].maxLength) {\r\n            throw newRxError('SC39', { schema: jsonSchema });\r\n        }\r\n\r\n        this.finalFields = getFinalFields(this.jsonSchema);\r\n    }\r\n\r\n    public get version(): number {\r\n        return this.jsonSchema.version;\r\n    }\r\n\r\n    public get defaultValues(): { [P in keyof RxDocType]: RxDocType[P] } {\r\n        const values = {} as { [P in keyof RxDocType]: RxDocType[P] };\r\n        Object\r\n            .entries(this.jsonSchema.properties)\r\n            .filter(([, v]) => Object.prototype.hasOwnProperty.call(v, 'default'))\r\n            .forEach(([k, v]) => (values as any)[k] = (v as any).default);\r\n        return overwriteGetterForCaching(\r\n            this,\r\n            'defaultValues',\r\n            values\r\n        );\r\n    }\r\n\r\n    /**\r\n     * @overrides itself on the first call\r\n     */\r\n    public get hash(): Promise<string> {\r\n        return overwriteGetterForCaching(\r\n            this,\r\n            'hash',\r\n            this.hashFunction(JSON.stringify(this.jsonSchema))\r\n        );\r\n    }\r\n\r\n    /**\r\n     * checks if a given change on a document is allowed\r\n     * Ensures that:\r\n     * - final fields are not modified\r\n     * @throws {Error} if not valid\r\n     */\r\n    validateChange(dataBefore: any, dataAfter: any): void {\r\n        this.finalFields.forEach(fieldName => {\r\n            if (!deepEqual(dataBefore[fieldName], dataAfter[fieldName])) {\r\n                throw newRxError('DOC9', {\r\n                    dataBefore,\r\n                    dataAfter,\r\n                    fieldName,\r\n                    schema: this.jsonSchema\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * creates the schema-based document-prototype,\r\n     * see RxCollection.getDocumentPrototype()\r\n     */\r\n    public getDocumentPrototype(): any {\r\n        const proto: any = {};\r\n\r\n        /**\r\n         * On the top level, we know all keys\r\n         * and therefore do not have to create a new Proxy object\r\n         * for each document. Instead we define the getter in the prototype once.\r\n         */\r\n        const pathProperties = getSchemaByObjectPath(\r\n            this.jsonSchema,\r\n            ''\r\n        );\r\n        Object.keys(pathProperties)\r\n            .forEach(key => {\r\n                const fullPath = key;\r\n\r\n                // getter - value\r\n                proto.__defineGetter__(\r\n                    key,\r\n                    function (this: RxDocument) {\r\n                        if (!this.get || typeof this.get !== 'function') {\r\n                            /**\r\n                             * When an object gets added to the state of a vuejs-component,\r\n                             * it happens that this getter is called with another scope.\r\n                             * To prevent errors, we have to return undefined in this case\r\n                             */\r\n                            return undefined;\r\n                        }\r\n                        const ret = this.get(fullPath);\r\n                        return ret;\r\n                    }\r\n                );\r\n                // getter - observable$\r\n                Object.defineProperty(proto, key + '$', {\r\n                    get: function () {\r\n                        return this.get$(fullPath);\r\n                    },\r\n                    enumerable: false,\r\n                    configurable: false\r\n                });\r\n                // getter - reactivity$$\r\n                Object.defineProperty(proto, key + '$$', {\r\n                    get: function () {\r\n                        return this.get$$(fullPath);\r\n                    },\r\n                    enumerable: false,\r\n                    configurable: false\r\n                });\r\n                // getter - populate_\r\n                Object.defineProperty(proto, key + '_', {\r\n                    get: function () {\r\n                        return this.populate(fullPath);\r\n                    },\r\n                    enumerable: false,\r\n                    configurable: false\r\n                });\r\n            });\r\n\r\n        overwriteGetterForCaching(\r\n            this,\r\n            'getDocumentPrototype',\r\n            () => proto\r\n        );\r\n        return proto;\r\n    }\r\n\r\n\r\n    getPrimaryOfDocumentData(\r\n        documentData: Partial<RxDocType>\r\n    ): string {\r\n        return getComposedPrimaryKeyOfDocumentData(\r\n            this.jsonSchema,\r\n            documentData\r\n        );\r\n    }\r\n}\r\n\r\nexport function getIndexes<RxDocType = any>(\r\n    jsonSchema: RxJsonSchema<RxDocType>\r\n): MaybeReadonly<string[]>[] {\r\n    return (jsonSchema.indexes || []).map(index => isMaybeReadonlyArray(index) ? index : [index]);\r\n}\r\n\r\n/**\r\n * array with previous version-numbers\r\n */\r\nexport function getPreviousVersions(schema: RxJsonSchema<any>): number[] {\r\n    const version = schema.version ? schema.version : 0;\r\n    let c = 0;\r\n    return new Array(version)\r\n        .fill(0)\r\n        .map(() => c++);\r\n}\r\n\r\nexport function createRxSchema<T>(\r\n    jsonSchema: RxJsonSchema<T>,\r\n    hashFunction: HashFunction,\r\n    runPreCreateHooks = true\r\n): RxSchema<T> {\r\n    if (runPreCreateHooks) {\r\n        runPluginHooks('preCreateRxSchema', jsonSchema);\r\n    }\r\n\r\n    let useJsonSchema = fillWithDefaultSettings(jsonSchema);\r\n    useJsonSchema = normalizeRxJsonSchema(useJsonSchema);\r\n    overwritable.deepFreezeWhenDevMode(useJsonSchema);\r\n\r\n    const schema = new RxSchema(useJsonSchema, hashFunction);\r\n    runPluginHooks('createRxSchema', schema);\r\n    return schema;\r\n}\r\n\r\nexport function isRxSchema(obj: any): boolean {\r\n    return obj instanceof RxSchema;\r\n}\r\n\r\n/**\r\n * Used as helper function the generate the document type out of the schema via typescript.\r\n * @link https://github.com/pubkey/rxdb/discussions/3467\r\n */\r\nexport function toTypedRxJsonSchema<T extends DeepReadonly<RxJsonSchema<any>>>(schema: T): DeepMutable<T> {\r\n    return schema as any;\r\n}\r\n"],"mappings":"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","ignoreList":[]}