{"version":3,"file":"flagged-functions.js","names":["ensureNotFalsy","rx_pipeline_fn_1_","fn","rx_pipeline_fn_2_","rx_pipeline_fn_3_","rx_pipeline_fn_4_","rx_pipeline_fn_5_","rx_pipeline_fn_6_","rx_pipeline_fn_7_","rx_pipeline_fn_8_","rx_pipeline_fn_9_","rx_pipeline_fn_10_","rx_pipeline_fn_11_","rx_pipeline_fn_12_","rx_pipeline_fn_13_","rx_pipeline_fn_14_","rx_pipeline_fn_15_","rx_pipeline_fn_16_","rx_pipeline_fn_17_","rx_pipeline_fn_18_","rx_pipeline_fn_19_","rx_pipeline_fn_20_","FLAGGED_FUNCTIONS","ids","Object","keys","blockFlaggedFunctionKey","id","pop","releaseFlaggedFunctionKey","key","push"],"sources":["../../../../src/plugins/pipeline/flagged-functions.ts"],"sourcesContent":["import { ensureNotFalsy } from '../utils/index.ts';\r\n\r\n/**\r\n * This is the most hacky thing we do in RxDB.\r\n * When a pipeline \"transaction\" is running,\r\n * we have to make all calls to the collection from the outside\r\n * wait while still make it possible to run reads and writes\r\n * from inside the transaction.\r\n * \r\n * We can decide where the call came from by checking the stack `new Error().stack`\r\n * for a random \"flag\".\r\n * But creating random flagged functions requires eval which we should not use.\r\n * Instead we have a list of some flagged functions here\r\n * that can be used and checked for in the stacktrace.\r\n * \r\n * \r\n * When doing this with eval() instead it would look like:\r\n * ```ts\r\n * eval(`\r\n *     async function ${this.secretFunctionName}(docs){ const x = await _this.handler(docs); return x; }\r\n *     o.${this.secretFunctionName} = ${this.secretFunctionName};\r\n *   `);\r\n * await o[this.secretFunctionName](rxDocuments);\r\n * \r\n * ```\r\n */\r\nasync function rx_pipeline_fn_1_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_2_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_3_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_4_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_5_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_6_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_7_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_8_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_9_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_10_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_11_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_12_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_13_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_14_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_15_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_16_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_17_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_18_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_19_(fn: any) {\r\n    return await fn();\r\n}\r\nasync function rx_pipeline_fn_20_(fn: any) {\r\n    return await fn();\r\n}\r\n\r\n\r\n\r\n\r\n\r\nexport const FLAGGED_FUNCTIONS = {\r\n    rx_pipeline_fn_1_,\r\n    rx_pipeline_fn_2_,\r\n    rx_pipeline_fn_3_,\r\n    rx_pipeline_fn_4_,\r\n    rx_pipeline_fn_5_,\r\n    rx_pipeline_fn_6_,\r\n    rx_pipeline_fn_7_,\r\n    rx_pipeline_fn_8_,\r\n    rx_pipeline_fn_9_,\r\n    rx_pipeline_fn_10_,\r\n    rx_pipeline_fn_11_,\r\n    rx_pipeline_fn_12_,\r\n    rx_pipeline_fn_13_,\r\n    rx_pipeline_fn_14_,\r\n    rx_pipeline_fn_15_,\r\n    rx_pipeline_fn_16_,\r\n    rx_pipeline_fn_17_,\r\n    rx_pipeline_fn_18_,\r\n    rx_pipeline_fn_19_,\r\n    rx_pipeline_fn_20_,\r\n} as const;\r\n\r\n\r\n\r\nconst ids: (keyof typeof FLAGGED_FUNCTIONS)[] = Object.keys(FLAGGED_FUNCTIONS) as any;\r\n\r\nexport function blockFlaggedFunctionKey(): keyof typeof FLAGGED_FUNCTIONS {\r\n    /**\r\n     * If this happens and we have no more flagged keys left\r\n     * it means that more pipeline handlers are running in parallel.\r\n     * To fix this, add more functions.\r\n     */\r\n    const id = ensureNotFalsy(ids.pop(), 'no flagged keys left');\r\n    return id;\r\n}\r\n\r\nexport function releaseFlaggedFunctionKey(key: keyof typeof FLAGGED_FUNCTIONS) {\r\n    ids.push(key);\r\n}\r\n"],"mappings":"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","ignoreList":[]}