{"version":3,"file":"attachments-utils.js","names":["newRxError","ensureNotFalsy","ensureSchemaSupportsAttachments","doc","schemaJson","collection","schema","jsonSchema","attachments","link","assignMethodsToAttachment","attachment","Object","entries","forEach","funName","fun","defineProperty","get","bind","fillWriteDataForAttachmentsChange","primaryPath","storageInstance","newDocument","originalDocument","_attachments","Error","docId","originalAttachmentsIds","Set","keys","Promise","all","map","key","value","has","digest","data","attachmentDataString","getAttachmentData"],"sources":["../../../../src/plugins/attachments/attachments-utils.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\r\nimport type {\r\n    RxAttachmentWriteData,\r\n    RxStorageInstance,\r\n    WithDeletedAndAttachments\r\n} from '../../types/index.d.ts';\r\nimport { ensureNotFalsy } from '../utils/index.ts';\r\n\r\nexport function ensureSchemaSupportsAttachments(doc: any) {\r\n    const schemaJson = doc.collection.schema.jsonSchema;\r\n    if (!schemaJson.attachments) {\r\n        throw newRxError('AT1', {\r\n            link: 'https://pubkey.github.io/rxdb/rx-attachment.html'\r\n        });\r\n    }\r\n}\r\n\r\nexport function assignMethodsToAttachment(attachment: any) {\r\n    Object\r\n        .entries(attachment.doc.collection.attachments)\r\n        .forEach(([funName, fun]) => {\r\n            Object.defineProperty(attachment, funName, {\r\n                get: () => (fun as any).bind(attachment)\r\n            });\r\n        });\r\n}\r\n\r\n/**\r\n * Fill up the missing attachment.data of the newDocument\r\n * so that the new document can be send to somewhere else\r\n * which could then receive all required attachments data\r\n * that it did not have before.\r\n */\r\nexport async function fillWriteDataForAttachmentsChange<RxDocType>(\r\n    primaryPath: string,\r\n    storageInstance: RxStorageInstance<RxDocType, any, any, any>,\r\n    newDocument: WithDeletedAndAttachments<RxDocType>,\r\n    originalDocument?: WithDeletedAndAttachments<RxDocType>\r\n): Promise<WithDeletedAndAttachments<RxDocType>> {\r\n\r\n    if (\r\n        !newDocument._attachments ||\r\n        (\r\n            originalDocument &&\r\n            !originalDocument._attachments\r\n        )\r\n    ) {\r\n        throw new Error('_attachments missing');\r\n    }\r\n\r\n    const docId: string = (newDocument as any)[primaryPath];\r\n    const originalAttachmentsIds = new Set(\r\n        originalDocument && originalDocument._attachments\r\n            ? Object.keys(originalDocument._attachments)\r\n            : []\r\n    );\r\n    await Promise.all(\r\n        Object\r\n            .entries(newDocument._attachments)\r\n            .map(async ([key, value]) => {\r\n                if (\r\n                    (\r\n                        !originalAttachmentsIds.has(key) ||\r\n                        (\r\n                            originalDocument &&\r\n                            ensureNotFalsy(originalDocument._attachments)[key].digest !== value.digest\r\n                        )\r\n                    ) &&\r\n                    !(value as RxAttachmentWriteData).data\r\n                ) {\r\n                    const attachmentDataString = await storageInstance.getAttachmentData(\r\n                        docId,\r\n                        key,\r\n                        value.digest\r\n                    );\r\n                    (value as RxAttachmentWriteData).data = attachmentDataString;\r\n                }\r\n            })\r\n    );\r\n\r\n    return newDocument;\r\n}\r\n"],"mappings":"AAAA,SAASA,UAAU,QAAQ,mBAAmB;AAM9C,SAASC,cAAc,QAAQ,mBAAmB;AAElD,OAAO,SAASC,+BAA+BA,CAACC,GAAQ,EAAE;EACtD,IAAMC,UAAU,GAAGD,GAAG,CAACE,UAAU,CAACC,MAAM,CAACC,UAAU;EACnD,IAAI,CAACH,UAAU,CAACI,WAAW,EAAE;IACzB,MAAMR,UAAU,CAAC,KAAK,EAAE;MACpBS,IAAI,EAAE;IACV,CAAC,CAAC;EACN;AACJ;AAEA,OAAO,SAASC,yBAAyBA,CAACC,UAAe,EAAE;EACvDC,MAAM,CACDC,OAAO,CAACF,UAAU,CAACR,GAAG,CAACE,UAAU,CAACG,WAAW,CAAC,CAC9CM,OAAO,CAAC,CAAC,CAACC,OAAO,EAAEC,GAAG,CAAC,KAAK;IACzBJ,MAAM,CAACK,cAAc,CAACN,UAAU,EAAEI,OAAO,EAAE;MACvCG,GAAG,EAAEA,CAAA,KAAOF,GAAG,CAASG,IAAI,CAACR,UAAU;IAC3C,CAAC,CAAC;EACN,CAAC,CAAC;AACV;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,eAAeS,iCAAiCA,CACnDC,WAAmB,EACnBC,eAA4D,EAC5DC,WAAiD,EACjDC,gBAAuD,EACV;EAE7C,IACI,CAACD,WAAW,CAACE,YAAY,IAErBD,gBAAgB,IAChB,CAACA,gBAAgB,CAACC,YACrB,EACH;IACE,MAAM,IAAIC,KAAK,CAAC,sBAAsB,CAAC;EAC3C;EAEA,IAAMC,KAAa,GAAIJ,WAAW,CAASF,WAAW,CAAC;EACvD,IAAMO,sBAAsB,GAAG,IAAIC,GAAG,CAClCL,gBAAgB,IAAIA,gBAAgB,CAACC,YAAY,GAC3Cb,MAAM,CAACkB,IAAI,CAACN,gBAAgB,CAACC,YAAY,CAAC,GAC1C,EACV,CAAC;EACD,MAAMM,OAAO,CAACC,GAAG,CACbpB,MAAM,CACDC,OAAO,CAACU,WAAW,CAACE,YAAY,CAAC,CACjCQ,GAAG,CAAC,OAAO,CAACC,GAAG,EAAEC,KAAK,CAAC,KAAK;IACzB,IACI,CACI,CAACP,sBAAsB,CAACQ,GAAG,CAACF,GAAG,CAAC,IAE5BV,gBAAgB,IAChBvB,cAAc,CAACuB,gBAAgB,CAACC,YAAY,CAAC,CAACS,GAAG,CAAC,CAACG,MAAM,KAAKF,KAAK,CAACE,MACvE,KAEL,CAAEF,KAAK,CAA2BG,IAAI,EACxC;MACE,IAAMC,oBAAoB,GAAG,MAAMjB,eAAe,CAACkB,iBAAiB,CAChEb,KAAK,EACLO,GAAG,EACHC,KAAK,CAACE,MACV,CAAC;MACAF,KAAK,CAA2BG,IAAI,GAAGC,oBAAoB;IAChE;EACJ,CAAC,CACT,CAAC;EAED,OAAOhB,WAAW;AACtB","ignoreList":[]}