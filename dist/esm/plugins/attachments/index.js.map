{"version":3,"file":"index.js","names":["map","blobToBase64String","blobToString","createBlobFromBase64","flatClone","getBlobSize","PROMISE_RESOLVE_VOID","assignMethodsToAttachment","ensureSchemaSupportsAttachments","RxAttachment","doc","id","type","length","digest","_proto","prototype","remove","collection","incrementalWriteQueue","addWrite","_data","docWriteData","_attachments","then","getData","plainDataBase64","storageInstance","getAttachmentData","primary","ret","getStringData","data","asString","fromStorageInstanceResult","attachmentData","rxDocument","putAttachment","dataSize","dataString","database","hashFunction","writeResult","newDocument","_docCache","getCachedRxDocument","attachmentDataOfId","attachment","getAttachment","docData","allAttachments","Object","keys","preMigrateDocument","attachments","newAttachments","Promise","all","attachmentId","docPrimary","oldCollection","schema","primaryPath","rawAttachmentData","postMigrateDocument","_action","RxDBAttachmentsPlugin","name","rxdb","prototypes","RxDocument","proto","defineProperty","get","allAttachments$","$","pipe","entries","toJSON","overwritable","hooks","after"],"sources":["../../../../src/plugins/attachments/index.ts"],"sourcesContent":["import {\r\n    map\r\n} from 'rxjs';\r\n\r\nimport {\r\n    blobToBase64String,\r\n    blobToString,\r\n    createBlobFromBase64,\r\n    flatClone,\r\n    getBlobSize,\r\n    PROMISE_RESOLVE_VOID\r\n} from '../../plugins/utils/index.ts';\r\nimport type {\r\n    RxDocument,\r\n    RxPlugin,\r\n    RxDocumentWriteData,\r\n    RxAttachmentData,\r\n    RxDocumentData,\r\n    RxAttachmentCreator,\r\n    RxAttachmentWriteData,\r\n    RxCollection\r\n} from '../../types/index.ts';\r\nimport {\r\n    assignMethodsToAttachment,\r\n    ensureSchemaSupportsAttachments\r\n} from './attachments-utils.ts';\r\n\r\n\r\n\r\n/**\r\n * an RxAttachment is basically just the attachment-stub\r\n * wrapped so that you can access the attachment-data\r\n */\r\nexport class RxAttachment {\r\n    public doc: RxDocument;\r\n    public id: string;\r\n    public type: string;\r\n    public length: number;\r\n    public digest: string;\r\n    constructor({\r\n        doc,\r\n        id,\r\n        type,\r\n        length,\r\n        digest\r\n    }: any) {\r\n        this.doc = doc;\r\n        this.id = id;\r\n        this.type = type;\r\n        this.length = length;\r\n        this.digest = digest;\r\n\r\n        assignMethodsToAttachment(this);\r\n    }\r\n\r\n    remove(): Promise<void> {\r\n        return this.doc.collection.incrementalWriteQueue.addWrite(\r\n            this.doc._data,\r\n            docWriteData => {\r\n                delete docWriteData._attachments[this.id];\r\n                return docWriteData;\r\n            }\r\n        ).then(() => { });\r\n    }\r\n\r\n    /**\r\n     * returns the data for the attachment\r\n     */\r\n    async getData(): Promise<Blob> {\r\n        const plainDataBase64 = await this.doc.collection.storageInstance.getAttachmentData(\r\n            this.doc.primary,\r\n            this.id,\r\n            this.digest\r\n        );\r\n        const ret = await createBlobFromBase64(\r\n            plainDataBase64,\r\n            this.type as any\r\n        );\r\n        return ret;\r\n    }\r\n\r\n    async getStringData(): Promise<string> {\r\n        const data = await this.getData();\r\n        const asString = await blobToString(data);\r\n        return asString;\r\n    }\r\n}\r\n\r\nexport function fromStorageInstanceResult<RxDocType>(\r\n    id: string,\r\n    attachmentData: RxAttachmentData,\r\n    rxDocument: RxDocument<RxDocType>\r\n) {\r\n    return new RxAttachment({\r\n        doc: rxDocument,\r\n        id,\r\n        type: attachmentData.type,\r\n        length: attachmentData.length,\r\n        digest: attachmentData.digest\r\n    });\r\n}\r\n\r\n\r\n\r\nexport async function putAttachment<RxDocType>(\r\n    this: RxDocument<RxDocType>,\r\n    attachmentData: RxAttachmentCreator\r\n): Promise<RxAttachment> {\r\n    ensureSchemaSupportsAttachments(this);\r\n\r\n    const dataSize = getBlobSize(attachmentData.data);\r\n    const dataString = await blobToBase64String(attachmentData.data);\r\n    const digest = await this.collection.database.hashFunction(dataString);\r\n\r\n    const id = attachmentData.id;\r\n    const type = attachmentData.type;\r\n    const data = dataString;\r\n\r\n    return this.collection.incrementalWriteQueue.addWrite(\r\n        this._data,\r\n        (docWriteData: RxDocumentWriteData<RxDocType>) => {\r\n            docWriteData = flatClone(docWriteData);\r\n            docWriteData._attachments = flatClone(docWriteData._attachments);\r\n            docWriteData._attachments[id] = {\r\n                length: dataSize,\r\n                type,\r\n                data,\r\n                digest\r\n            };\r\n            return docWriteData;\r\n        }).then(writeResult => {\r\n            const newDocument = this.collection._docCache.getCachedRxDocument(writeResult);\r\n            const attachmentDataOfId = writeResult._attachments[id];\r\n            const attachment = fromStorageInstanceResult(\r\n                id,\r\n                attachmentDataOfId,\r\n                newDocument\r\n            );\r\n            return attachment;\r\n        });\r\n}\r\n\r\n/**\r\n * get an attachment of the document by its id\r\n */\r\nexport function getAttachment(\r\n    this: RxDocument,\r\n    id: string\r\n): RxAttachment | null {\r\n    ensureSchemaSupportsAttachments(this);\r\n    const docData: any = this._data;\r\n    if (!docData._attachments || !docData._attachments[id])\r\n        return null;\r\n\r\n    const attachmentData = docData._attachments[id];\r\n    const attachment = fromStorageInstanceResult(\r\n        id,\r\n        attachmentData,\r\n        this\r\n    );\r\n    return attachment;\r\n}\r\n\r\n/**\r\n * returns all attachments of the document\r\n */\r\nexport function allAttachments(\r\n    this: RxDocument\r\n): RxAttachment[] {\r\n    ensureSchemaSupportsAttachments(this);\r\n    const docData: any = this._data;\r\n\r\n    // if there are no attachments, the field is missing\r\n    if (!docData._attachments) {\r\n        return [];\r\n    }\r\n    return Object.keys(docData._attachments)\r\n        .map(id => {\r\n            return fromStorageInstanceResult(\r\n                id,\r\n                docData._attachments[id],\r\n                this\r\n            );\r\n        });\r\n}\r\n\r\nexport async function preMigrateDocument<RxDocType>(\r\n    data: {\r\n        docData: RxDocumentData<RxDocType>;\r\n        oldCollection: RxCollection<RxDocType>;\r\n    }\r\n): Promise<void> {\r\n    const attachments = data.docData._attachments;\r\n    if (attachments) {\r\n        const newAttachments: { [attachmentId: string]: RxAttachmentWriteData; } = {};\r\n        await Promise.all(\r\n            Object.keys(attachments).map(async (attachmentId) => {\r\n                const attachment: RxAttachmentData = attachments[attachmentId];\r\n                const docPrimary: string = (data.docData as any)[data.oldCollection.schema.primaryPath];\r\n                const rawAttachmentData = await data.oldCollection.storageInstance.getAttachmentData(\r\n                    docPrimary,\r\n                    attachmentId,\r\n                    attachment.digest\r\n                );\r\n                const digest = await data.oldCollection.database.hashFunction(rawAttachmentData);\r\n                newAttachments[attachmentId] = {\r\n                    length: attachment.length,\r\n                    type: attachment.type,\r\n                    data: rawAttachmentData,\r\n                    digest\r\n                };\r\n            })\r\n        );\r\n\r\n        /**\r\n         * Hooks mutate the input\r\n         * instead of returning stuff\r\n         */\r\n        (data.docData as RxDocumentWriteData<RxDocType>)._attachments = newAttachments;\r\n    }\r\n}\r\n\r\nexport function postMigrateDocument(_action: any): Promise<void> {\r\n    /**\r\n     * No longer needed because\r\n     * we store the attachments data buffers directly in the document.\r\n     */\r\n    return PROMISE_RESOLVE_VOID;\r\n}\r\n\r\nexport const RxDBAttachmentsPlugin: RxPlugin = {\r\n    name: 'attachments',\r\n    rxdb: true,\r\n    prototypes: {\r\n        RxDocument: (proto: any) => {\r\n            proto.putAttachment = putAttachment;\r\n            proto.getAttachment = getAttachment;\r\n            proto.allAttachments = allAttachments;\r\n            Object.defineProperty(proto, 'allAttachments$', {\r\n                get: function allAttachments$(this: RxDocument) {\r\n                    return this.$\r\n                        .pipe(\r\n                            map(rxDocument => Object.entries(\r\n                                rxDocument.toJSON(true)._attachments\r\n                            )),\r\n                            map(entries => {\r\n                                return (entries as any)\r\n                                    .map(([id, attachmentData]: any) => {\r\n                                        return fromStorageInstanceResult(\r\n                                            id,\r\n                                            attachmentData,\r\n                                            this\r\n                                        );\r\n                                    });\r\n                            })\r\n                        );\r\n                }\r\n            });\r\n        }\r\n    },\r\n    overwritable: {},\r\n    hooks: {\r\n        preMigrateDocument: {\r\n            after: preMigrateDocument\r\n        },\r\n        postMigrateDocument: {\r\n            after: postMigrateDocument\r\n        }\r\n    }\r\n};\r\n\r\n\r\nexport * from './attachments-utils.ts';\r\n"],"mappings":"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","ignoreList":[]}