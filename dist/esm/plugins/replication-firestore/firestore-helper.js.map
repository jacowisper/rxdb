{"version":3,"file":"firestore-helper.js","names":["Timestamp","flatClone","now","getFirestoreSortFieldValue","docData","primaryKey","timeString","padStart","stripServerTimestampField","serverTimestampField","data","serverTimestampToIsoString","timestamp","date","toDate","toISOString","isoStringToServerTimestamp","isoString","Date","fromDate","firestoreRowToDocData","primaryPath","row","id","stripPrimaryKey","getContentByIds","ids","getQuery","batches","length","batch","splice","push","Promise","all","then","content","map","i","docs","flat"],"sources":["../../../../src/plugins/replication-firestore/firestore-helper.ts"],"sourcesContent":["import {\r\n    QueryDocumentSnapshot,\r\n    Timestamp\r\n} from 'firebase/firestore';\r\nimport type {\r\n    WithDeleted\r\n} from '../../types/index.d.ts';\r\nimport { flatClone, now } from '../../plugins/utils/index.ts';\r\nimport type { GetQuery } from './firestore-types.ts';\r\n\r\n\r\nexport function getFirestoreSortFieldValue(docData: any, primaryKey: string): string {\r\n    const timeString = now() + '';\r\n    return 'rxdb-' + timeString.padStart(15, '0') + '-' + docData[primaryKey];\r\n}\r\n\r\nexport function stripServerTimestampField<RxDocType>(\r\n    serverTimestampField: string,\r\n    docData: RxDocType\r\n): WithDeleted<RxDocType> {\r\n    const data = flatClone(docData);\r\n    delete (data as any)[serverTimestampField];\r\n    return data as any;\r\n}\r\n\r\n\r\nexport function serverTimestampToIsoString(serverTimestampField: string, docData: any): string {\r\n    const timestamp = (docData as any)[serverTimestampField];\r\n    const date: Date = timestamp.toDate();\r\n    return date.toISOString();\r\n}\r\n\r\nexport function isoStringToServerTimestamp(isoString: string): Timestamp {\r\n    const date = new Date(isoString);\r\n    return Timestamp.fromDate(date);\r\n}\r\n\r\nexport function firestoreRowToDocData<RxDocType>(\r\n    serverTimestampField: string,\r\n    primaryPath: string,\r\n    row: QueryDocumentSnapshot<RxDocType>\r\n): WithDeleted<RxDocType> {\r\n    const docData = stripServerTimestampField(\r\n        serverTimestampField,\r\n        row.data()\r\n    );\r\n    (docData as any)[primaryPath] = row.id;\r\n\r\n    if (primaryPath !== 'id') {\r\n        delete (docData as any)['id'];\r\n    }\r\n\r\n    return docData;\r\n}\r\n\r\nexport function stripPrimaryKey(\r\n    primaryPath: string,\r\n    docData: any\r\n): any {\r\n    docData = flatClone(docData);\r\n    delete (docData as any)[primaryPath];\r\n    return docData;\r\n}\r\n\r\n// https://stackoverflow.com/questions/61354866/is-there-a-workaround-for-the-firebase-query-in-limit-to-10\r\nexport function getContentByIds<RxDocType>(ids: string[], getQuery: GetQuery<RxDocType>): Promise<QueryDocumentSnapshot<RxDocType>[]> {\r\n    const batches = [];\r\n\r\n    while (ids.length) {\r\n        // firestore limits batches to 10\r\n        const batch = ids.splice(0, 10);\r\n\r\n        // add the batch request to to a queue\r\n        batches.push(getQuery(batch));\r\n    }\r\n\r\n    // after all of the data is fetched, return it\r\n    return Promise.all(batches).then((content) => content.map(i => i.docs).flat());\r\n}\r\n"],"mappings":"AAAA,SAEIA,SAAS,QACN,oBAAoB;AAI3B,SAASC,SAAS,EAAEC,GAAG,QAAQ,8BAA8B;AAI7D,OAAO,SAASC,0BAA0BA,CAACC,OAAY,EAAEC,UAAkB,EAAU;EACjF,IAAMC,UAAU,GAAGJ,GAAG,CAAC,CAAC,GAAG,EAAE;EAC7B,OAAO,OAAO,GAAGI,UAAU,CAACC,QAAQ,CAAC,EAAE,EAAE,GAAG,CAAC,GAAG,GAAG,GAAGH,OAAO,CAACC,UAAU,CAAC;AAC7E;AAEA,OAAO,SAASG,yBAAyBA,CACrCC,oBAA4B,EAC5BL,OAAkB,EACI;EACtB,IAAMM,IAAI,GAAGT,SAAS,CAACG,OAAO,CAAC;EAC/B,OAAQM,IAAI,CAASD,oBAAoB,CAAC;EAC1C,OAAOC,IAAI;AACf;AAGA,OAAO,SAASC,0BAA0BA,CAACF,oBAA4B,EAAEL,OAAY,EAAU;EAC3F,IAAMQ,SAAS,GAAIR,OAAO,CAASK,oBAAoB,CAAC;EACxD,IAAMI,IAAU,GAAGD,SAAS,CAACE,MAAM,CAAC,CAAC;EACrC,OAAOD,IAAI,CAACE,WAAW,CAAC,CAAC;AAC7B;AAEA,OAAO,SAASC,0BAA0BA,CAACC,SAAiB,EAAa;EACrE,IAAMJ,IAAI,GAAG,IAAIK,IAAI,CAACD,SAAS,CAAC;EAChC,OAAOjB,SAAS,CAACmB,QAAQ,CAACN,IAAI,CAAC;AACnC;AAEA,OAAO,SAASO,qBAAqBA,CACjCX,oBAA4B,EAC5BY,WAAmB,EACnBC,GAAqC,EACf;EACtB,IAAMlB,OAAO,GAAGI,yBAAyB,CACrCC,oBAAoB,EACpBa,GAAG,CAACZ,IAAI,CAAC,CACb,CAAC;EACAN,OAAO,CAASiB,WAAW,CAAC,GAAGC,GAAG,CAACC,EAAE;EAEtC,IAAIF,WAAW,KAAK,IAAI,EAAE;IACtB,OAAQjB,OAAO,CAAS,IAAI,CAAC;EACjC;EAEA,OAAOA,OAAO;AAClB;AAEA,OAAO,SAASoB,eAAeA,CAC3BH,WAAmB,EACnBjB,OAAY,EACT;EACHA,OAAO,GAAGH,SAAS,CAACG,OAAO,CAAC;EAC5B,OAAQA,OAAO,CAASiB,WAAW,CAAC;EACpC,OAAOjB,OAAO;AAClB;;AAEA;AACA,OAAO,SAASqB,eAAeA,CAAYC,GAAa,EAAEC,QAA6B,EAA+C;EAClI,IAAMC,OAAO,GAAG,EAAE;EAElB,OAAOF,GAAG,CAACG,MAAM,EAAE;IACf;IACA,IAAMC,KAAK,GAAGJ,GAAG,CAACK,MAAM,CAAC,CAAC,EAAE,EAAE,CAAC;;IAE/B;IACAH,OAAO,CAACI,IAAI,CAACL,QAAQ,CAACG,KAAK,CAAC,CAAC;EACjC;;EAEA;EACA,OAAOG,OAAO,CAACC,GAAG,CAACN,OAAO,CAAC,CAACO,IAAI,CAAEC,OAAO,IAAKA,OAAO,CAACC,GAAG,CAACC,CAAC,IAAIA,CAAC,CAACC,IAAI,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;AAClF","ignoreList":[]}