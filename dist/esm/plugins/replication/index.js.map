{"version":3,"file":"index.js","names":["BehaviorSubject","combineLatest","filter","mergeMap","Subject","RxDBLeaderElectionPlugin","arrayFilterNotEmpty","ensureNotFalsy","errorToPlainJson","flatClone","getFromMapOrCreate","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_TRUE","toArray","toPromise","awaitRxStorageReplicationFirstInSync","awaitRxStorageReplicationInSync","cancelRxStorageReplication","getRxReplicationMetaInstanceSchema","replicateRxStorageInstance","newRxError","awaitRetry","DEFAULT_MODIFIER","swapDefaultDeletedTodeletedField","handlePulledDocuments","preventHibernateBrowserTab","addConnectedStorageToCollection","removeConnectedStorageFromCollection","addRxPlugin","hasEncryption","overwritable","runAsyncPluginHooks","REPLICATION_STATE_BY_COLLECTION","WeakMap","RxReplicationState","replicationIdentifier","collection","deletedField","pull","push","live","retryTime","autoStart","toggleOnDocumentVisible","subs","subjects","received","sent","error","canceled","active","received$","asObservable","sent$","error$","canceled$","active$","wasStarted","onCancel","callOnStart","undefined","remoteEvents$","metaInfoPromise","metaInstanceCollectionName","database","hashFunction","name","join","metaInstanceSchema","schema","jsonSchema","collectionName","replicationStates","onClose","cancel","Object","keys","forEach","key","defineProperty","get","startPromise","Promise","res","_proto","prototype","start","isStopped","internalReplicationState","events","paused","next","reSync","pullModifier","modifier","pushModifier","metaInfo","metaInstance","all","storage","createStorageInstance","databaseName","databaseInstanceToken","token","multiInstance","options","password","devMode","isDevMode","pushBatchSize","batchSize","pullBatchSize","initialCheckpoint","upstream","downstream","forkInstance","storageInstance","identifier","conflictHandler","replicationHandler","masterChangeStream$","pipe","_v","ev","useEv","documents","map","d","masterChangesSince","checkpoint","done","result","isStoppedOrPaused","handler","err","emitError","errors","er","direction","useResult","masterWrite","rows","useRowsOrNull","row","newDocumentState","assumedMasterState","useRows","length","Array","isArray","pushRows","args","rxdb","conflicts","subscribe","processed","down","document","up","writeToMasterRow","isActive","stream$","pause","isPaused","getValue","awaitInitialReplication","awaitInSync","t","requestIdlePromise","emitEvent","promises","fn","checkpointQueue","then","close","sub","unsubscribe","complete","remove","replicateRxCollection","waitForLeadership","replicationState","addEventListener","visibilityState","isVisible","isLeader","removeEventListener","startReplicationOnLeaderShip","mustWaitForLeadership","waitTillRun"],"sources":["../../../../src/plugins/replication/index.ts"],"sourcesContent":["/**\r\n * This plugin contains the primitives to create\r\n * a RxDB client-server replication.\r\n * It is used in the other replication plugins\r\n * but also can be used as standalone with a custom replication handler.\r\n */\r\n\r\nimport {\r\n    BehaviorSubject,\r\n    combineLatest,\r\n    filter,\r\n    mergeMap,\r\n    Observable,\r\n    Subject,\r\n    Subscription\r\n} from 'rxjs';\r\nimport type {\r\n    ReplicationOptions,\r\n    ReplicationPullHandlerResult,\r\n    ReplicationPullOptions,\r\n    ReplicationPushOptions,\r\n    RxCollection,\r\n    RxDocumentData,\r\n    RxError,\r\n    RxJsonSchema,\r\n    RxReplicationPullStreamItem,\r\n    RxReplicationWriteToMasterRow,\r\n    RxStorageInstance,\r\n    RxStorageInstanceReplicationState,\r\n    RxStorageReplicationMeta,\r\n    RxTypeError,\r\n    WithDeleted\r\n} from '../../types/index.d.ts';\r\nimport { RxDBLeaderElectionPlugin } from '../leader-election/index.ts';\r\nimport {\r\n    arrayFilterNotEmpty,\r\n    ensureNotFalsy,\r\n    errorToPlainJson,\r\n    flatClone,\r\n    getFromMapOrCreate,\r\n    PROMISE_RESOLVE_FALSE,\r\n    PROMISE_RESOLVE_TRUE,\r\n    toArray,\r\n    toPromise\r\n} from '../../plugins/utils/index.ts';\r\nimport {\r\n    awaitRxStorageReplicationFirstInSync,\r\n    awaitRxStorageReplicationInSync,\r\n    cancelRxStorageReplication,\r\n    getRxReplicationMetaInstanceSchema,\r\n    replicateRxStorageInstance\r\n} from '../../replication-protocol/index.ts';\r\nimport { newRxError } from '../../rx-error.ts';\r\nimport {\r\n    awaitRetry,\r\n    DEFAULT_MODIFIER,\r\n    swapDefaultDeletedTodeletedField,\r\n    handlePulledDocuments,\r\n    preventHibernateBrowserTab\r\n} from './replication-helper.ts';\r\nimport {\r\n    addConnectedStorageToCollection,\r\n    removeConnectedStorageFromCollection\r\n} from '../../rx-database-internal-store.ts';\r\nimport { addRxPlugin } from '../../plugin.ts';\r\nimport { hasEncryption } from '../../rx-storage-helper.ts';\r\nimport { overwritable } from '../../overwritable.ts';\r\nimport {\r\n    runAsyncPluginHooks\r\n} from '../../hooks.ts';\r\n\r\n\r\nexport const REPLICATION_STATE_BY_COLLECTION: WeakMap<RxCollection, RxReplicationState<any, any>[]> = new WeakMap();\r\n\r\nexport class RxReplicationState<RxDocType, CheckpointType> {\r\n    public readonly subs: Subscription[] = [];\r\n    public readonly subjects = {\r\n        received: new Subject<RxDocumentData<RxDocType>>(), // all documents that are received from the endpoint\r\n        sent: new Subject<WithDeleted<RxDocType>>(), // all documents that are send to the endpoint\r\n        error: new Subject<RxError | RxTypeError>(), // all errors that are received from the endpoint, emits new Error() objects\r\n        canceled: new BehaviorSubject<boolean>(false), // true when the replication was canceled\r\n        active: new BehaviorSubject<boolean>(false) // true when something is running, false when not\r\n    };\r\n\r\n    readonly received$: Observable<RxDocumentData<RxDocType>> = this.subjects.received.asObservable();\r\n    readonly sent$: Observable<WithDeleted<RxDocType>> = this.subjects.sent.asObservable();\r\n    readonly error$: Observable<RxError | RxTypeError> = this.subjects.error.asObservable();\r\n    readonly canceled$: Observable<any> = this.subjects.canceled.asObservable();\r\n    readonly active$: Observable<boolean> = this.subjects.active.asObservable();\r\n\r\n    wasStarted: boolean = false;\r\n\r\n    readonly metaInfoPromise: Promise<{ collectionName: string, schema: RxJsonSchema<RxDocumentData<RxStorageReplicationMeta<RxDocType, any>>> }>;\r\n\r\n    public startPromise: Promise<void>;\r\n\r\n    public onCancel: (() => void)[] = [];\r\n\r\n    constructor(\r\n        /**\r\n         * The identifier, used to flag revisions\r\n         * and to identify which documents state came from the remote.\r\n         */\r\n        public readonly replicationIdentifier: string,\r\n        public readonly collection: RxCollection<RxDocType>,\r\n        public readonly deletedField: string,\r\n        public readonly pull?: ReplicationPullOptions<RxDocType, CheckpointType>,\r\n        public readonly push?: ReplicationPushOptions<RxDocType>,\r\n        public readonly live?: boolean,\r\n        public retryTime?: number,\r\n        public autoStart?: boolean,\r\n        public toggleOnDocumentVisible?: boolean\r\n    ) {\r\n        this.metaInfoPromise = (async () => {\r\n            const metaInstanceCollectionName = 'rx-replication-meta-' + await collection.database.hashFunction([\r\n                this.collection.name,\r\n                this.replicationIdentifier\r\n            ].join('-'));\r\n            const metaInstanceSchema = getRxReplicationMetaInstanceSchema(\r\n                this.collection.schema.jsonSchema,\r\n                hasEncryption(this.collection.schema.jsonSchema)\r\n            );\r\n            return {\r\n                collectionName: metaInstanceCollectionName,\r\n                schema: metaInstanceSchema\r\n            };\r\n        })();\r\n        const replicationStates = getFromMapOrCreate(\r\n            REPLICATION_STATE_BY_COLLECTION,\r\n            collection,\r\n            () => []\r\n        );\r\n        replicationStates.push(this);\r\n\r\n        // stop the replication when the collection gets closed\r\n        this.collection.onClose.push(() => this.cancel());\r\n\r\n        // create getters for the observables\r\n        Object.keys(this.subjects).forEach(key => {\r\n            Object.defineProperty(this, key + '$', {\r\n                get: function () {\r\n                    return this.subjects[key].asObservable();\r\n                }\r\n            });\r\n        });\r\n        const startPromise = new Promise<void>(res => {\r\n            this.callOnStart = res;\r\n        });\r\n        this.startPromise = startPromise;\r\n    }\r\n\r\n    private callOnStart: () => void = undefined as any;\r\n\r\n    public internalReplicationState?: RxStorageInstanceReplicationState<RxDocType>;\r\n    public metaInstance?: RxStorageInstance<RxStorageReplicationMeta<RxDocType, CheckpointType>, any, {}, any>;\r\n    public remoteEvents$: Subject<RxReplicationPullStreamItem<RxDocType, CheckpointType>> = new Subject();\r\n\r\n    public async start(): Promise<void> {\r\n        if (this.isStopped()) {\r\n            return;\r\n        }\r\n\r\n        if (this.internalReplicationState) {\r\n            this.internalReplicationState.events.paused.next(false);\r\n        }\r\n\r\n        /**\r\n         * If started after a pause,\r\n         * just re-sync once and continue.\r\n         */\r\n        if (this.wasStarted) {\r\n            this.reSync();\r\n            return;\r\n        }\r\n        this.wasStarted = true;\r\n\r\n\r\n        if (!this.toggleOnDocumentVisible) {\r\n            preventHibernateBrowserTab(this);\r\n        }\r\n\r\n        // fill in defaults for pull & push\r\n        const pullModifier = this.pull && this.pull.modifier ? this.pull.modifier : DEFAULT_MODIFIER;\r\n        const pushModifier = this.push && this.push.modifier ? this.push.modifier : DEFAULT_MODIFIER;\r\n\r\n        const database = this.collection.database;\r\n        const metaInfo = await this.metaInfoPromise;\r\n\r\n        const [metaInstance] = await Promise.all([\r\n            this.collection.database.storage.createStorageInstance<RxStorageReplicationMeta<RxDocType, CheckpointType>>({\r\n                databaseName: database.name,\r\n                collectionName: metaInfo.collectionName,\r\n                databaseInstanceToken: database.token,\r\n                multiInstance: database.multiInstance,\r\n                options: {},\r\n                schema: metaInfo.schema,\r\n                password: database.password,\r\n                devMode: overwritable.isDevMode()\r\n            }),\r\n            addConnectedStorageToCollection(\r\n                this.collection,\r\n                metaInfo.collectionName,\r\n                metaInfo.schema\r\n            )\r\n        ]);\r\n        this.metaInstance = metaInstance;\r\n\r\n\r\n        this.internalReplicationState = replicateRxStorageInstance({\r\n            pushBatchSize: this.push && this.push.batchSize ? this.push.batchSize : 100,\r\n            pullBatchSize: this.pull && this.pull.batchSize ? this.pull.batchSize : 100,\r\n            initialCheckpoint: {\r\n                upstream: this.push ? this.push.initialCheckpoint : undefined,\r\n                downstream: this.pull ? this.pull.initialCheckpoint : undefined\r\n            },\r\n            forkInstance: this.collection.storageInstance,\r\n            metaInstance: this.metaInstance,\r\n            hashFunction: database.hashFunction,\r\n            identifier: 'rxdbreplication' + this.replicationIdentifier,\r\n            conflictHandler: this.collection.conflictHandler,\r\n            replicationHandler: {\r\n                masterChangeStream$: this.remoteEvents$.asObservable().pipe(\r\n                    filter(_v => !!this.pull),\r\n                    mergeMap(async (ev) => {\r\n                        if (ev === 'RESYNC') {\r\n                            return ev;\r\n                        }\r\n                        const useEv = flatClone(ev);\r\n                        useEv.documents = handlePulledDocuments(this.collection, this.deletedField, useEv.documents);\r\n                        useEv.documents = await Promise.all(\r\n                            useEv.documents.map(d => pullModifier(d))\r\n                        );\r\n                        return useEv;\r\n                    })\r\n                ),\r\n                masterChangesSince: async (\r\n                    checkpoint: CheckpointType | undefined,\r\n                    batchSize: number\r\n                ) => {\r\n                    if (!this.pull) {\r\n                        return {\r\n                            checkpoint: null,\r\n                            documents: []\r\n                        };\r\n                    }\r\n                    /**\r\n                     * Retries must be done here in the replication primitives plugin,\r\n                     * because the replication protocol itself has no\r\n                     * error handling.\r\n                     */\r\n                    let done = false;\r\n                    let result: ReplicationPullHandlerResult<RxDocType, CheckpointType> = {} as any;\r\n                    while (!done && !this.isStoppedOrPaused()) {\r\n                        try {\r\n                            result = await this.pull.handler(\r\n                                checkpoint,\r\n                                batchSize\r\n                            );\r\n                            done = true;\r\n                        } catch (err: any | Error | Error[]) {\r\n                            const emitError = newRxError('RC_PULL', {\r\n                                checkpoint,\r\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\r\n                                direction: 'pull'\r\n                            });\r\n                            this.subjects.error.next(emitError);\r\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\r\n                        }\r\n                    }\r\n\r\n                    if (this.isStoppedOrPaused()) {\r\n                        return {\r\n                            checkpoint: null,\r\n                            documents: []\r\n                        };\r\n                    }\r\n\r\n                    const useResult = flatClone(result);\r\n                    useResult.documents = handlePulledDocuments(this.collection, this.deletedField, useResult.documents);\r\n                    useResult.documents = await Promise.all(\r\n                        useResult.documents.map(d => pullModifier(d))\r\n                    );\r\n                    return useResult;\r\n                },\r\n                masterWrite: async (\r\n                    rows: RxReplicationWriteToMasterRow<RxDocType>[]\r\n                ) => {\r\n                    if (!this.push) {\r\n                        return [];\r\n                    }\r\n                    let done = false;\r\n\r\n                    await runAsyncPluginHooks('preReplicationMasterWrite', {\r\n                        rows,\r\n                        collection: this.collection\r\n                    });\r\n\r\n                    const useRowsOrNull = await Promise.all(\r\n                        rows.map(async (row) => {\r\n                            row.newDocumentState = await pushModifier(row.newDocumentState);\r\n                            if (row.newDocumentState === null) {\r\n                                return null;\r\n                            }\r\n                            if (row.assumedMasterState) {\r\n                                row.assumedMasterState = await pushModifier(row.assumedMasterState);\r\n                            }\r\n                            if (this.deletedField !== '_deleted') {\r\n                                row.newDocumentState = swapDefaultDeletedTodeletedField(this.deletedField, row.newDocumentState) as any;\r\n                                if (row.assumedMasterState) {\r\n                                    row.assumedMasterState = swapDefaultDeletedTodeletedField(this.deletedField, row.assumedMasterState) as any;\r\n                                }\r\n                            }\r\n                            return row;\r\n                        })\r\n                    );\r\n                    const useRows: RxReplicationWriteToMasterRow<RxDocType>[] = useRowsOrNull.filter(arrayFilterNotEmpty);\r\n\r\n                    let result: WithDeleted<RxDocType>[] = null as any;\r\n\r\n                    // In case all the rows have been filtered and nothing has to be sent\r\n                    if (useRows.length === 0) {\r\n                        done = true;\r\n                        result = [];\r\n                    }\r\n\r\n                    while (!done && !this.isStoppedOrPaused()) {\r\n                        try {\r\n                            result = await this.push.handler(useRows);\r\n                            /**\r\n                             * It is a common problem that people have wrongly behaving backend\r\n                             * that do not return an array with the conflicts on push requests.\r\n                             * So we run this check here to make it easier to debug.\r\n                             * @link https://github.com/pubkey/rxdb/issues/4103\r\n                             */\r\n                            if (!Array.isArray(result)) {\r\n                                throw newRxError(\r\n                                    'RC_PUSH_NO_AR',\r\n                                    {\r\n                                        pushRows: rows,\r\n                                        direction: 'push',\r\n                                        args: { result }\r\n                                    }\r\n                                );\r\n                            }\r\n                            done = true;\r\n                        } catch (err: any | Error | Error[] | RxError) {\r\n                            const emitError = (err as RxError).rxdb ? err : newRxError('RC_PUSH', {\r\n                                pushRows: rows,\r\n                                errors: toArray(err).map(er => errorToPlainJson(er)),\r\n                                direction: 'push'\r\n                            });\r\n                            this.subjects.error.next(emitError);\r\n                            await awaitRetry(this.collection, ensureNotFalsy(this.retryTime));\r\n                        }\r\n                    }\r\n                    if (this.isStoppedOrPaused()) {\r\n                        return [];\r\n                    }\r\n\r\n                    await runAsyncPluginHooks('preReplicationMasterWriteDocumentsHandle', {\r\n                        result,\r\n                        collection: this.collection\r\n                    });\r\n\r\n                    const conflicts = handlePulledDocuments(this.collection, this.deletedField, ensureNotFalsy(result));\r\n                    return conflicts;\r\n                }\r\n            }\r\n        });\r\n        this.subs.push(\r\n            this.internalReplicationState.events.error.subscribe(err => {\r\n                this.subjects.error.next(err);\r\n            }),\r\n            this.internalReplicationState.events.processed.down\r\n                .subscribe(row => this.subjects.received.next(row.document as any)),\r\n            this.internalReplicationState.events.processed.up\r\n                .subscribe(writeToMasterRow => {\r\n                    this.subjects.sent.next(writeToMasterRow.newDocumentState);\r\n                }),\r\n            combineLatest([\r\n                this.internalReplicationState.events.active.down,\r\n                this.internalReplicationState.events.active.up\r\n            ]).subscribe(([down, up]) => {\r\n                const isActive = down || up;\r\n                this.subjects.active.next(isActive);\r\n            })\r\n        );\r\n\r\n        if (\r\n            this.pull &&\r\n            this.pull.stream$ &&\r\n            this.live\r\n        ) {\r\n            this.subs.push(\r\n                this.pull.stream$.subscribe({\r\n                    next: ev => {\r\n                        if (!this.isStoppedOrPaused()) {\r\n                            this.remoteEvents$.next(ev);\r\n                        }\r\n                    },\r\n                    error: err => {\r\n                        this.subjects.error.next(err);\r\n                    }\r\n                })\r\n            );\r\n        }\r\n\r\n        /**\r\n         * Non-live replications run once\r\n         * and then automatically get canceled.\r\n         */\r\n        if (!this.live) {\r\n            await awaitRxStorageReplicationFirstInSync(this.internalReplicationState);\r\n            await awaitRxStorageReplicationInSync(this.internalReplicationState);\r\n            await this.cancel();\r\n        }\r\n        this.callOnStart();\r\n    }\r\n\r\n    pause() {\r\n        ensureNotFalsy(this.internalReplicationState).events.paused.next(true);\r\n    }\r\n\r\n    isPaused(): boolean {\r\n        return this.internalReplicationState ? this.internalReplicationState.events.paused.getValue() : false;\r\n    }\r\n\r\n    isStopped(): boolean {\r\n        if (this.subjects.canceled.getValue()) {\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    isStoppedOrPaused() {\r\n        return this.isPaused() || this.isStopped();\r\n    }\r\n\r\n    async awaitInitialReplication(): Promise<void> {\r\n        await this.startPromise;\r\n        return awaitRxStorageReplicationFirstInSync(\r\n            ensureNotFalsy(this.internalReplicationState)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Returns a promise that resolves when:\r\n     * - All local data is replicated with the remote\r\n     * - No replication cycle is running or in retry-state\r\n     *\r\n     * WARNING: USing this function directly in a multi-tab browser application\r\n     * is dangerous because only the leading instance will ever be replicated,\r\n     * so this promise will not resolve in the other tabs.\r\n     * For multi-tab support you should set and observe a flag in a local document.\r\n     */\r\n    async awaitInSync(): Promise<true> {\r\n        await this.startPromise;\r\n        await awaitRxStorageReplicationFirstInSync(ensureNotFalsy(this.internalReplicationState));\r\n\r\n        /**\r\n         * To reduce the amount of re-renders and make testing\r\n         * and to make the whole behavior more predictable,\r\n         * we await these things multiple times.\r\n         * For example the state might be in sync already and at the\r\n         * exact same time a pull.stream$ event comes in and we want to catch\r\n         * that in the same call to awaitInSync() instead of resolving\r\n         * while actually the state is not in sync.\r\n         */\r\n        let t = 2;\r\n        while (t > 0) {\r\n            t--;\r\n\r\n            /**\r\n             * Often awaitInSync() is called directly after a document write,\r\n             * like in the unit tests.\r\n             * So we first have to await the idleness to ensure that all RxChangeEvents\r\n             * are processed already.\r\n             */\r\n            await this.collection.database.requestIdlePromise();\r\n            await awaitRxStorageReplicationInSync(ensureNotFalsy(this.internalReplicationState));\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    reSync() {\r\n        this.remoteEvents$.next('RESYNC');\r\n    }\r\n    emitEvent(ev: RxReplicationPullStreamItem<RxDocType, CheckpointType>) {\r\n        this.remoteEvents$.next(ev);\r\n    }\r\n\r\n    async cancel(): Promise<any> {\r\n        if (this.isStopped()) {\r\n            return PROMISE_RESOLVE_FALSE;\r\n        }\r\n\r\n        const promises: Promise<any>[] = this.onCancel.map(fn => toPromise(fn()));\r\n\r\n        if (this.internalReplicationState) {\r\n            await cancelRxStorageReplication(this.internalReplicationState);\r\n        }\r\n        if (this.metaInstance) {\r\n            promises.push(\r\n                ensureNotFalsy(this.internalReplicationState).checkpointQueue\r\n                    .then(() => ensureNotFalsy(this.metaInstance).close())\r\n            );\r\n        }\r\n\r\n        this.subs.forEach(sub => sub.unsubscribe());\r\n        this.subjects.canceled.next(true);\r\n\r\n        this.subjects.active.complete();\r\n        this.subjects.canceled.complete();\r\n        this.subjects.error.complete();\r\n        this.subjects.received.complete();\r\n        this.subjects.sent.complete();\r\n\r\n        return Promise.all(promises);\r\n    }\r\n\r\n    async remove() {\r\n        await ensureNotFalsy(this.metaInstance).remove();\r\n        const metaInfo = await this.metaInfoPromise;\r\n        await this.cancel();\r\n        await removeConnectedStorageFromCollection(\r\n            this.collection,\r\n            metaInfo.collectionName,\r\n            metaInfo.schema\r\n        );\r\n    }\r\n}\r\n\r\n\r\nexport function replicateRxCollection<RxDocType, CheckpointType>(\r\n    {\r\n        replicationIdentifier,\r\n        collection,\r\n        deletedField = '_deleted',\r\n        pull,\r\n        push,\r\n        live = true,\r\n        retryTime = 1000 * 5,\r\n        waitForLeadership = true,\r\n        autoStart = true,\r\n        toggleOnDocumentVisible = false\r\n    }: ReplicationOptions<RxDocType, CheckpointType>\r\n): RxReplicationState<RxDocType, CheckpointType> {\r\n    addRxPlugin(RxDBLeaderElectionPlugin);\r\n\r\n    /**\r\n     * It is a common error to forget to add these config\r\n     * objects. So we check here because it makes no sense\r\n     * to start a replication with neither push nor pull.\r\n     */\r\n    if (!pull && !push) {\r\n        throw newRxError('UT3', {\r\n            collection: collection.name,\r\n            args: {\r\n                replicationIdentifier\r\n            }\r\n        });\r\n    }\r\n\r\n    const replicationState = new RxReplicationState<RxDocType, CheckpointType>(\r\n        replicationIdentifier,\r\n        collection,\r\n        deletedField,\r\n        pull,\r\n        push,\r\n        live,\r\n        retryTime,\r\n        autoStart,\r\n        toggleOnDocumentVisible\r\n    );\r\n\r\n\r\n    if (\r\n        toggleOnDocumentVisible &&\r\n        typeof document !== 'undefined' &&\r\n        typeof document.addEventListener === 'function' &&\r\n        typeof document.visibilityState === 'string'\r\n    ) {\r\n        const handler = () => {\r\n            if (replicationState.isStopped()) {\r\n                return;\r\n            }\r\n            const isVisible = document.visibilityState;\r\n            if (isVisible) {\r\n                replicationState.start();\r\n            } else {\r\n                /**\r\n                 * Only pause if not the current leader.\r\n                 * If no tab is visible, the elected leader should still continue\r\n                 * the replication.\r\n                 */\r\n                if (!collection.database.isLeader()) {\r\n                    replicationState.pause();\r\n                }\r\n            }\r\n        }\r\n        document.addEventListener('visibilitychange', handler);\r\n        replicationState.onCancel.push(\r\n            () => document.removeEventListener('visibilitychange', handler)\r\n        );\r\n    }\r\n\r\n\r\n    startReplicationOnLeaderShip(waitForLeadership, replicationState);\r\n    return replicationState as any;\r\n}\r\n\r\n\r\nexport function startReplicationOnLeaderShip(\r\n    waitForLeadership: boolean,\r\n    replicationState: RxReplicationState<any, any>\r\n) {\r\n    /**\r\n     * Always await this Promise to ensure that the current instance\r\n     * is leader when waitForLeadership=true\r\n     */\r\n    const mustWaitForLeadership = waitForLeadership && replicationState.collection.database.multiInstance;\r\n    const waitTillRun: Promise<any> = mustWaitForLeadership ? replicationState.collection.database.waitForLeadership() : PROMISE_RESOLVE_TRUE;\r\n    return waitTillRun.then(() => {\r\n        if (replicationState.isStopped()) {\r\n            return;\r\n        }\r\n        if (replicationState.autoStart) {\r\n            replicationState.start();\r\n        }\r\n    });\r\n}\r\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;;AAEA,SACIA,eAAe,EACfC,aAAa,EACbC,MAAM,EACNC,QAAQ,EAERC,OAAO,QAEJ,MAAM;AAkBb,SAASC,wBAAwB,QAAQ,6BAA6B;AACtE,SACIC,mBAAmB,EACnBC,cAAc,EACdC,gBAAgB,EAChBC,SAAS,EACTC,kBAAkB,EAClBC,qBAAqB,EACrBC,oBAAoB,EACpBC,OAAO,EACPC,SAAS,QACN,8BAA8B;AACrC,SACIC,oCAAoC,EACpCC,+BAA+B,EAC/BC,0BAA0B,EAC1BC,kCAAkC,EAClCC,0BAA0B,QACvB,qCAAqC;AAC5C,SAASC,UAAU,QAAQ,mBAAmB;AAC9C,SACIC,UAAU,EACVC,gBAAgB,EAChBC,gCAAgC,EAChCC,qBAAqB,EACrBC,0BAA0B,QACvB,yBAAyB;AAChC,SACIC,+BAA+B,EAC/BC,oCAAoC,QACjC,qCAAqC;AAC5C,SAASC,WAAW,QAAQ,iBAAiB;AAC7C,SAASC,aAAa,QAAQ,4BAA4B;AAC1D,SAASC,YAAY,QAAQ,uBAAuB;AACpD,SACIC,mBAAmB,QAChB,gBAAgB;AAGvB,OAAO,IAAMC,+BAAsF,GAAG,IAAIC,OAAO,CAAC,CAAC;AAEnH,WAAaC,kBAAkB;EAwB3B,SAAAA;EACI;AACR;AACA;AACA;EACwBC,qBAA6B,EAC7BC,UAAmC,EACnCC,YAAoB,EACpBC,IAAwD,EACxDC,IAAwC,EACxCC,IAAc,EACvBC,SAAkB,EAClBC,SAAmB,EACnBC,uBAAiC,EAC1C;IAAA,KArCcC,IAAI,GAAmB,EAAE;IAAA,KACzBC,QAAQ,GAAG;MACvBC,QAAQ,EAAE,IAAI1C,OAAO,CAA4B,CAAC;MAAE;MACpD2C,IAAI,EAAE,IAAI3C,OAAO,CAAyB,CAAC;MAAE;MAC7C4C,KAAK,EAAE,IAAI5C,OAAO,CAAwB,CAAC;MAAE;MAC7C6C,QAAQ,EAAE,IAAIjD,eAAe,CAAU,KAAK,CAAC;MAAE;MAC/CkD,MAAM,EAAE,IAAIlD,eAAe,CAAU,KAAK,CAAC,CAAC;IAChD,CAAC;IAAA,KAEQmD,SAAS,GAA0C,IAAI,CAACN,QAAQ,CAACC,QAAQ,CAACM,YAAY,CAAC,CAAC;IAAA,KACxFC,KAAK,GAAuC,IAAI,CAACR,QAAQ,CAACE,IAAI,CAACK,YAAY,CAAC,CAAC;IAAA,KAC7EE,MAAM,GAAsC,IAAI,CAACT,QAAQ,CAACG,KAAK,CAACI,YAAY,CAAC,CAAC;IAAA,KAC9EG,SAAS,GAAoB,IAAI,CAACV,QAAQ,CAACI,QAAQ,CAACG,YAAY,CAAC,CAAC;IAAA,KAClEI,OAAO,GAAwB,IAAI,CAACX,QAAQ,CAACK,MAAM,CAACE,YAAY,CAAC,CAAC;IAAA,KAE3EK,UAAU,GAAY,KAAK;IAAA,KAMpBC,QAAQ,GAAmB,EAAE;IAAA,KAuD5BC,WAAW,GAAeC,SAAS;IAAA,KAIpCC,aAAa,GAAoE,IAAIzD,OAAO,CAAC,CAAC;IAAA,KApDjF+B,qBAA6B,GAA7BA,qBAA6B;IAAA,KAC7BC,UAAmC,GAAnCA,UAAmC;IAAA,KACnCC,YAAoB,GAApBA,YAAoB;IAAA,KACpBC,IAAwD,GAAxDA,IAAwD;IAAA,KACxDC,IAAwC,GAAxCA,IAAwC;IAAA,KACxCC,IAAc,GAAdA,IAAc;IAAA,KACvBC,SAAkB,GAAlBA,SAAkB;IAAA,KAClBC,SAAmB,GAAnBA,SAAmB;IAAA,KACnBC,uBAAiC,GAAjCA,uBAAiC;IAExC,IAAI,CAACmB,eAAe,GAAG,CAAC,YAAY;MAChC,IAAMC,0BAA0B,GAAG,sBAAsB,IAAG,MAAM3B,UAAU,CAAC4B,QAAQ,CAACC,YAAY,CAAC,CAC/F,IAAI,CAAC7B,UAAU,CAAC8B,IAAI,EACpB,IAAI,CAAC/B,qBAAqB,CAC7B,CAACgC,IAAI,CAAC,GAAG,CAAC,CAAC;MACZ,IAAMC,kBAAkB,GAAGlD,kCAAkC,CACzD,IAAI,CAACkB,UAAU,CAACiC,MAAM,CAACC,UAAU,EACjCzC,aAAa,CAAC,IAAI,CAACO,UAAU,CAACiC,MAAM,CAACC,UAAU,CACnD,CAAC;MACD,OAAO;QACHC,cAAc,EAAER,0BAA0B;QAC1CM,MAAM,EAAED;MACZ,CAAC;IACL,CAAC,EAAE,CAAC;IACJ,IAAMI,iBAAiB,GAAG9D,kBAAkB,CACxCsB,+BAA+B,EAC/BI,UAAU,EACV,MAAM,EACV,CAAC;IACDoC,iBAAiB,CAACjC,IAAI,CAAC,IAAI,CAAC;;IAE5B;IACA,IAAI,CAACH,UAAU,CAACqC,OAAO,CAAClC,IAAI,CAAC,MAAM,IAAI,CAACmC,MAAM,CAAC,CAAC,CAAC;;IAEjD;IACAC,MAAM,CAACC,IAAI,CAAC,IAAI,CAAC/B,QAAQ,CAAC,CAACgC,OAAO,CAACC,GAAG,IAAI;MACtCH,MAAM,CAACI,cAAc,CAAC,IAAI,EAAED,GAAG,GAAG,GAAG,EAAE;QACnCE,GAAG,EAAE,SAAAA,CAAA,EAAY;UACb,OAAO,IAAI,CAACnC,QAAQ,CAACiC,GAAG,CAAC,CAAC1B,YAAY,CAAC,CAAC;QAC5C;MACJ,CAAC,CAAC;IACN,CAAC,CAAC;IACF,IAAM6B,YAAY,GAAG,IAAIC,OAAO,CAAOC,GAAG,IAAI;MAC1C,IAAI,CAACxB,WAAW,GAAGwB,GAAG;IAC1B,CAAC,CAAC;IACF,IAAI,CAACF,YAAY,GAAGA,YAAY;EACpC;EAAC,IAAAG,MAAA,GAAAlD,kBAAA,CAAAmD,SAAA;EAAAD,MAAA,CAQYE,KAAK,GAAlB,eAAaA,KAAKA,CAAA,EAAkB;IAChC,IAAI,IAAI,CAACC,SAAS,CAAC,CAAC,EAAE;MAClB;IACJ;IAEA,IAAI,IAAI,CAACC,wBAAwB,EAAE;MAC/B,IAAI,CAACA,wBAAwB,CAACC,MAAM,CAACC,MAAM,CAACC,IAAI,CAAC,KAAK,CAAC;IAC3D;;IAEA;AACR;AACA;AACA;IACQ,IAAI,IAAI,CAAClC,UAAU,EAAE;MACjB,IAAI,CAACmC,MAAM,CAAC,CAAC;MACb;IACJ;IACA,IAAI,CAACnC,UAAU,GAAG,IAAI;IAGtB,IAAI,CAAC,IAAI,CAACd,uBAAuB,EAAE;MAC/BlB,0BAA0B,CAAC,IAAI,CAAC;IACpC;;IAEA;IACA,IAAMoE,YAAY,GAAG,IAAI,CAACvD,IAAI,IAAI,IAAI,CAACA,IAAI,CAACwD,QAAQ,GAAG,IAAI,CAACxD,IAAI,CAACwD,QAAQ,GAAGxE,gBAAgB;IAC5F,IAAMyE,YAAY,GAAG,IAAI,CAACxD,IAAI,IAAI,IAAI,CAACA,IAAI,CAACuD,QAAQ,GAAG,IAAI,CAACvD,IAAI,CAACuD,QAAQ,GAAGxE,gBAAgB;IAE5F,IAAM0C,QAAQ,GAAG,IAAI,CAAC5B,UAAU,CAAC4B,QAAQ;IACzC,IAAMgC,QAAQ,GAAG,MAAM,IAAI,CAAClC,eAAe;IAE3C,IAAM,CAACmC,YAAY,CAAC,GAAG,MAAMf,OAAO,CAACgB,GAAG,CAAC,CACrC,IAAI,CAAC9D,UAAU,CAAC4B,QAAQ,CAACmC,OAAO,CAACC,qBAAqB,CAAsD;MACxGC,YAAY,EAAErC,QAAQ,CAACE,IAAI;MAC3BK,cAAc,EAAEyB,QAAQ,CAACzB,cAAc;MACvC+B,qBAAqB,EAAEtC,QAAQ,CAACuC,KAAK;MACrCC,aAAa,EAAExC,QAAQ,CAACwC,aAAa;MACrCC,OAAO,EAAE,CAAC,CAAC;MACXpC,MAAM,EAAE2B,QAAQ,CAAC3B,MAAM;MACvBqC,QAAQ,EAAE1C,QAAQ,CAAC0C,QAAQ;MAC3BC,OAAO,EAAE7E,YAAY,CAAC8E,SAAS,CAAC;IACpC,CAAC,CAAC,EACFlF,+BAA+B,CAC3B,IAAI,CAACU,UAAU,EACf4D,QAAQ,CAACzB,cAAc,EACvByB,QAAQ,CAAC3B,MACb,CAAC,CACJ,CAAC;IACF,IAAI,CAAC4B,YAAY,GAAGA,YAAY;IAGhC,IAAI,CAACT,wBAAwB,GAAGrE,0BAA0B,CAAC;MACvD0F,aAAa,EAAE,IAAI,CAACtE,IAAI,IAAI,IAAI,CAACA,IAAI,CAACuE,SAAS,GAAG,IAAI,CAACvE,IAAI,CAACuE,SAAS,GAAG,GAAG;MAC3EC,aAAa,EAAE,IAAI,CAACzE,IAAI,IAAI,IAAI,CAACA,IAAI,CAACwE,SAAS,GAAG,IAAI,CAACxE,IAAI,CAACwE,SAAS,GAAG,GAAG;MAC3EE,iBAAiB,EAAE;QACfC,QAAQ,EAAE,IAAI,CAAC1E,IAAI,GAAG,IAAI,CAACA,IAAI,CAACyE,iBAAiB,GAAGpD,SAAS;QAC7DsD,UAAU,EAAE,IAAI,CAAC5E,IAAI,GAAG,IAAI,CAACA,IAAI,CAAC0E,iBAAiB,GAAGpD;MAC1D,CAAC;MACDuD,YAAY,EAAE,IAAI,CAAC/E,UAAU,CAACgF,eAAe;MAC7CnB,YAAY,EAAE,IAAI,CAACA,YAAY;MAC/BhC,YAAY,EAAED,QAAQ,CAACC,YAAY;MACnCoD,UAAU,EAAE,iBAAiB,GAAG,IAAI,CAAClF,qBAAqB;MAC1DmF,eAAe,EAAE,IAAI,CAAClF,UAAU,CAACkF,eAAe;MAChDC,kBAAkB,EAAE;QAChBC,mBAAmB,EAAE,IAAI,CAAC3D,aAAa,CAACT,YAAY,CAAC,CAAC,CAACqE,IAAI,CACvDvH,MAAM,CAACwH,EAAE,IAAI,CAAC,CAAC,IAAI,CAACpF,IAAI,CAAC,EACzBnC,QAAQ,CAAC,MAAOwH,EAAE,IAAK;UACnB,IAAIA,EAAE,KAAK,QAAQ,EAAE;YACjB,OAAOA,EAAE;UACb;UACA,IAAMC,KAAK,GAAGnH,SAAS,CAACkH,EAAE,CAAC;UAC3BC,KAAK,CAACC,SAAS,GAAGrG,qBAAqB,CAAC,IAAI,CAACY,UAAU,EAAE,IAAI,CAACC,YAAY,EAAEuF,KAAK,CAACC,SAAS,CAAC;UAC5FD,KAAK,CAACC,SAAS,GAAG,MAAM3C,OAAO,CAACgB,GAAG,CAC/B0B,KAAK,CAACC,SAAS,CAACC,GAAG,CAACC,CAAC,IAAIlC,YAAY,CAACkC,CAAC,CAAC,CAC5C,CAAC;UACD,OAAOH,KAAK;QAChB,CAAC,CACL,CAAC;QACDI,kBAAkB,EAAE,MAAAA,CAChBC,UAAsC,EACtCnB,SAAiB,KAChB;UACD,IAAI,CAAC,IAAI,CAACxE,IAAI,EAAE;YACZ,OAAO;cACH2F,UAAU,EAAE,IAAI;cAChBJ,SAAS,EAAE;YACf,CAAC;UACL;UACA;AACpB;AACA;AACA;AACA;UACoB,IAAIK,IAAI,GAAG,KAAK;UAChB,IAAIC,MAA+D,GAAG,CAAC,CAAQ;UAC/E,OAAO,CAACD,IAAI,IAAI,CAAC,IAAI,CAACE,iBAAiB,CAAC,CAAC,EAAE;YACvC,IAAI;cACAD,MAAM,GAAG,MAAM,IAAI,CAAC7F,IAAI,CAAC+F,OAAO,CAC5BJ,UAAU,EACVnB,SACJ,CAAC;cACDoB,IAAI,GAAG,IAAI;YACf,CAAC,CAAC,OAAOI,GAA0B,EAAE;cACjC,IAAMC,SAAS,GAAGnH,UAAU,CAAC,SAAS,EAAE;gBACpC6G,UAAU;gBACVO,MAAM,EAAE3H,OAAO,CAACyH,GAAG,CAAC,CAACR,GAAG,CAACW,EAAE,IAAIjI,gBAAgB,CAACiI,EAAE,CAAC,CAAC;gBACpDC,SAAS,EAAE;cACf,CAAC,CAAC;cACF,IAAI,CAAC7F,QAAQ,CAACG,KAAK,CAAC2C,IAAI,CAAC4C,SAAS,CAAC;cACnC,MAAMlH,UAAU,CAAC,IAAI,CAACe,UAAU,EAAE7B,cAAc,CAAC,IAAI,CAACkC,SAAS,CAAC,CAAC;YACrE;UACJ;UAEA,IAAI,IAAI,CAAC2F,iBAAiB,CAAC,CAAC,EAAE;YAC1B,OAAO;cACHH,UAAU,EAAE,IAAI;cAChBJ,SAAS,EAAE;YACf,CAAC;UACL;UAEA,IAAMc,SAAS,GAAGlI,SAAS,CAAC0H,MAAM,CAAC;UACnCQ,SAAS,CAACd,SAAS,GAAGrG,qBAAqB,CAAC,IAAI,CAACY,UAAU,EAAE,IAAI,CAACC,YAAY,EAAEsG,SAAS,CAACd,SAAS,CAAC;UACpGc,SAAS,CAACd,SAAS,GAAG,MAAM3C,OAAO,CAACgB,GAAG,CACnCyC,SAAS,CAACd,SAAS,CAACC,GAAG,CAACC,CAAC,IAAIlC,YAAY,CAACkC,CAAC,CAAC,CAChD,CAAC;UACD,OAAOY,SAAS;QACpB,CAAC;QACDC,WAAW,EAAE,MACTC,IAAgD,IAC/C;UACD,IAAI,CAAC,IAAI,CAACtG,IAAI,EAAE;YACZ,OAAO,EAAE;UACb;UACA,IAAI2F,IAAI,GAAG,KAAK;UAEhB,MAAMnG,mBAAmB,CAAC,2BAA2B,EAAE;YACnD8G,IAAI;YACJzG,UAAU,EAAE,IAAI,CAACA;UACrB,CAAC,CAAC;UAEF,IAAM0G,aAAa,GAAG,MAAM5D,OAAO,CAACgB,GAAG,CACnC2C,IAAI,CAACf,GAAG,CAAC,MAAOiB,GAAG,IAAK;YACpBA,GAAG,CAACC,gBAAgB,GAAG,MAAMjD,YAAY,CAACgD,GAAG,CAACC,gBAAgB,CAAC;YAC/D,IAAID,GAAG,CAACC,gBAAgB,KAAK,IAAI,EAAE;cAC/B,OAAO,IAAI;YACf;YACA,IAAID,GAAG,CAACE,kBAAkB,EAAE;cACxBF,GAAG,CAACE,kBAAkB,GAAG,MAAMlD,YAAY,CAACgD,GAAG,CAACE,kBAAkB,CAAC;YACvE;YACA,IAAI,IAAI,CAAC5G,YAAY,KAAK,UAAU,EAAE;cAClC0G,GAAG,CAACC,gBAAgB,GAAGzH,gCAAgC,CAAC,IAAI,CAACc,YAAY,EAAE0G,GAAG,CAACC,gBAAgB,CAAQ;cACvG,IAAID,GAAG,CAACE,kBAAkB,EAAE;gBACxBF,GAAG,CAACE,kBAAkB,GAAG1H,gCAAgC,CAAC,IAAI,CAACc,YAAY,EAAE0G,GAAG,CAACE,kBAAkB,CAAQ;cAC/G;YACJ;YACA,OAAOF,GAAG;UACd,CAAC,CACL,CAAC;UACD,IAAMG,OAAmD,GAAGJ,aAAa,CAAC5I,MAAM,CAACI,mBAAmB,CAAC;UAErG,IAAI6H,MAAgC,GAAG,IAAW;;UAElD;UACA,IAAIe,OAAO,CAACC,MAAM,KAAK,CAAC,EAAE;YACtBjB,IAAI,GAAG,IAAI;YACXC,MAAM,GAAG,EAAE;UACf;UAEA,OAAO,CAACD,IAAI,IAAI,CAAC,IAAI,CAACE,iBAAiB,CAAC,CAAC,EAAE;YACvC,IAAI;cACAD,MAAM,GAAG,MAAM,IAAI,CAAC5F,IAAI,CAAC8F,OAAO,CAACa,OAAO,CAAC;cACzC;AAC5B;AACA;AACA;AACA;AACA;cAC4B,IAAI,CAACE,KAAK,CAACC,OAAO,CAAClB,MAAM,CAAC,EAAE;gBACxB,MAAM/G,UAAU,CACZ,eAAe,EACf;kBACIkI,QAAQ,EAAET,IAAI;kBACdH,SAAS,EAAE,MAAM;kBACjBa,IAAI,EAAE;oBAAEpB;kBAAO;gBACnB,CACJ,CAAC;cACL;cACAD,IAAI,GAAG,IAAI;YACf,CAAC,CAAC,OAAOI,GAAoC,EAAE;cAC3C,IAAMC,SAAS,GAAID,GAAG,CAAakB,IAAI,GAAGlB,GAAG,GAAGlH,UAAU,CAAC,SAAS,EAAE;gBAClEkI,QAAQ,EAAET,IAAI;gBACdL,MAAM,EAAE3H,OAAO,CAACyH,GAAG,CAAC,CAACR,GAAG,CAACW,EAAE,IAAIjI,gBAAgB,CAACiI,EAAE,CAAC,CAAC;gBACpDC,SAAS,EAAE;cACf,CAAC,CAAC;cACF,IAAI,CAAC7F,QAAQ,CAACG,KAAK,CAAC2C,IAAI,CAAC4C,SAAS,CAAC;cACnC,MAAMlH,UAAU,CAAC,IAAI,CAACe,UAAU,EAAE7B,cAAc,CAAC,IAAI,CAACkC,SAAS,CAAC,CAAC;YACrE;UACJ;UACA,IAAI,IAAI,CAAC2F,iBAAiB,CAAC,CAAC,EAAE;YAC1B,OAAO,EAAE;UACb;UAEA,MAAMrG,mBAAmB,CAAC,0CAA0C,EAAE;YAClEoG,MAAM;YACN/F,UAAU,EAAE,IAAI,CAACA;UACrB,CAAC,CAAC;UAEF,IAAMqH,SAAS,GAAGjI,qBAAqB,CAAC,IAAI,CAACY,UAAU,EAAE,IAAI,CAACC,YAAY,EAAE9B,cAAc,CAAC4H,MAAM,CAAC,CAAC;UACnG,OAAOsB,SAAS;QACpB;MACJ;IACJ,CAAC,CAAC;IACF,IAAI,CAAC7G,IAAI,CAACL,IAAI,CACV,IAAI,CAACiD,wBAAwB,CAACC,MAAM,CAACzC,KAAK,CAAC0G,SAAS,CAACpB,GAAG,IAAI;MACxD,IAAI,CAACzF,QAAQ,CAACG,KAAK,CAAC2C,IAAI,CAAC2C,GAAG,CAAC;IACjC,CAAC,CAAC,EACF,IAAI,CAAC9C,wBAAwB,CAACC,MAAM,CAACkE,SAAS,CAACC,IAAI,CAC9CF,SAAS,CAACX,GAAG,IAAI,IAAI,CAAClG,QAAQ,CAACC,QAAQ,CAAC6C,IAAI,CAACoD,GAAG,CAACc,QAAe,CAAC,CAAC,EACvE,IAAI,CAACrE,wBAAwB,CAACC,MAAM,CAACkE,SAAS,CAACG,EAAE,CAC5CJ,SAAS,CAACK,gBAAgB,IAAI;MAC3B,IAAI,CAAClH,QAAQ,CAACE,IAAI,CAAC4C,IAAI,CAACoE,gBAAgB,CAACf,gBAAgB,CAAC;IAC9D,CAAC,CAAC,EACN/I,aAAa,CAAC,CACV,IAAI,CAACuF,wBAAwB,CAACC,MAAM,CAACvC,MAAM,CAAC0G,IAAI,EAChD,IAAI,CAACpE,wBAAwB,CAACC,MAAM,CAACvC,MAAM,CAAC4G,EAAE,CACjD,CAAC,CAACJ,SAAS,CAAC,CAAC,CAACE,IAAI,EAAEE,EAAE,CAAC,KAAK;MACzB,IAAME,QAAQ,GAAGJ,IAAI,IAAIE,EAAE;MAC3B,IAAI,CAACjH,QAAQ,CAACK,MAAM,CAACyC,IAAI,CAACqE,QAAQ,CAAC;IACvC,CAAC,CACL,CAAC;IAED,IACI,IAAI,CAAC1H,IAAI,IACT,IAAI,CAACA,IAAI,CAAC2H,OAAO,IACjB,IAAI,CAACzH,IAAI,EACX;MACE,IAAI,CAACI,IAAI,CAACL,IAAI,CACV,IAAI,CAACD,IAAI,CAAC2H,OAAO,CAACP,SAAS,CAAC;QACxB/D,IAAI,EAAEgC,EAAE,IAAI;UACR,IAAI,CAAC,IAAI,CAACS,iBAAiB,CAAC,CAAC,EAAE;YAC3B,IAAI,CAACvE,aAAa,CAAC8B,IAAI,CAACgC,EAAE,CAAC;UAC/B;QACJ,CAAC;QACD3E,KAAK,EAAEsF,GAAG,IAAI;UACV,IAAI,CAACzF,QAAQ,CAACG,KAAK,CAAC2C,IAAI,CAAC2C,GAAG,CAAC;QACjC;MACJ,CAAC,CACL,CAAC;IACL;;IAEA;AACR;AACA;AACA;IACQ,IAAI,CAAC,IAAI,CAAC9F,IAAI,EAAE;MACZ,MAAMzB,oCAAoC,CAAC,IAAI,CAACyE,wBAAwB,CAAC;MACzE,MAAMxE,+BAA+B,CAAC,IAAI,CAACwE,wBAAwB,CAAC;MACpE,MAAM,IAAI,CAACd,MAAM,CAAC,CAAC;IACvB;IACA,IAAI,CAACf,WAAW,CAAC,CAAC;EACtB,CAAC;EAAAyB,MAAA,CAED8E,KAAK,GAAL,SAAAA,KAAKA,CAAA,EAAG;IACJ3J,cAAc,CAAC,IAAI,CAACiF,wBAAwB,CAAC,CAACC,MAAM,CAACC,MAAM,CAACC,IAAI,CAAC,IAAI,CAAC;EAC1E,CAAC;EAAAP,MAAA,CAED+E,QAAQ,GAAR,SAAAA,QAAQA,CAAA,EAAY;IAChB,OAAO,IAAI,CAAC3E,wBAAwB,GAAG,IAAI,CAACA,wBAAwB,CAACC,MAAM,CAACC,MAAM,CAAC0E,QAAQ,CAAC,CAAC,GAAG,KAAK;EACzG,CAAC;EAAAhF,MAAA,CAEDG,SAAS,GAAT,SAAAA,SAASA,CAAA,EAAY;IACjB,IAAI,IAAI,CAAC1C,QAAQ,CAACI,QAAQ,CAACmH,QAAQ,CAAC,CAAC,EAAE;MACnC,OAAO,IAAI;IACf;IACA,OAAO,KAAK;EAChB,CAAC;EAAAhF,MAAA,CAEDgD,iBAAiB,GAAjB,SAAAA,iBAAiBA,CAAA,EAAG;IAChB,OAAO,IAAI,CAAC+B,QAAQ,CAAC,CAAC,IAAI,IAAI,CAAC5E,SAAS,CAAC,CAAC;EAC9C,CAAC;EAAAH,MAAA,CAEKiF,uBAAuB,GAA7B,eAAMA,uBAAuBA,CAAA,EAAkB;IAC3C,MAAM,IAAI,CAACpF,YAAY;IACvB,OAAOlE,oCAAoC,CACvCR,cAAc,CAAC,IAAI,CAACiF,wBAAwB,CAChD,CAAC;EACL;;EAEA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KATI;EAAAJ,MAAA,CAUMkF,WAAW,GAAjB,eAAMA,WAAWA,CAAA,EAAkB;IAC/B,MAAM,IAAI,CAACrF,YAAY;IACvB,MAAMlE,oCAAoC,CAACR,cAAc,CAAC,IAAI,CAACiF,wBAAwB,CAAC,CAAC;;IAEzF;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACQ,IAAI+E,CAAC,GAAG,CAAC;IACT,OAAOA,CAAC,GAAG,CAAC,EAAE;MACVA,CAAC,EAAE;;MAEH;AACZ;AACA;AACA;AACA;AACA;MACY,MAAM,IAAI,CAACnI,UAAU,CAAC4B,QAAQ,CAACwG,kBAAkB,CAAC,CAAC;MACnD,MAAMxJ,+BAA+B,CAACT,cAAc,CAAC,IAAI,CAACiF,wBAAwB,CAAC,CAAC;IACxF;IAEA,OAAO,IAAI;EACf,CAAC;EAAAJ,MAAA,CAEDQ,MAAM,GAAN,SAAAA,MAAMA,CAAA,EAAG;IACL,IAAI,CAAC/B,aAAa,CAAC8B,IAAI,CAAC,QAAQ,CAAC;EACrC,CAAC;EAAAP,MAAA,CACDqF,SAAS,GAAT,SAAAA,SAASA,CAAC9C,EAA0D,EAAE;IAClE,IAAI,CAAC9D,aAAa,CAAC8B,IAAI,CAACgC,EAAE,CAAC;EAC/B,CAAC;EAAAvC,MAAA,CAEKV,MAAM,GAAZ,eAAMA,MAAMA,CAAA,EAAiB;IACzB,IAAI,IAAI,CAACa,SAAS,CAAC,CAAC,EAAE;MAClB,OAAO5E,qBAAqB;IAChC;IAEA,IAAM+J,QAAwB,GAAG,IAAI,CAAChH,QAAQ,CAACoE,GAAG,CAAC6C,EAAE,IAAI7J,SAAS,CAAC6J,EAAE,CAAC,CAAC,CAAC,CAAC;IAEzE,IAAI,IAAI,CAACnF,wBAAwB,EAAE;MAC/B,MAAMvE,0BAA0B,CAAC,IAAI,CAACuE,wBAAwB,CAAC;IACnE;IACA,IAAI,IAAI,CAACS,YAAY,EAAE;MACnByE,QAAQ,CAACnI,IAAI,CACThC,cAAc,CAAC,IAAI,CAACiF,wBAAwB,CAAC,CAACoF,eAAe,CACxDC,IAAI,CAAC,MAAMtK,cAAc,CAAC,IAAI,CAAC0F,YAAY,CAAC,CAAC6E,KAAK,CAAC,CAAC,CAC7D,CAAC;IACL;IAEA,IAAI,CAAClI,IAAI,CAACiC,OAAO,CAACkG,GAAG,IAAIA,GAAG,CAACC,WAAW,CAAC,CAAC,CAAC;IAC3C,IAAI,CAACnI,QAAQ,CAACI,QAAQ,CAAC0C,IAAI,CAAC,IAAI,CAAC;IAEjC,IAAI,CAAC9C,QAAQ,CAACK,MAAM,CAAC+H,QAAQ,CAAC,CAAC;IAC/B,IAAI,CAACpI,QAAQ,CAACI,QAAQ,CAACgI,QAAQ,CAAC,CAAC;IACjC,IAAI,CAACpI,QAAQ,CAACG,KAAK,CAACiI,QAAQ,CAAC,CAAC;IAC9B,IAAI,CAACpI,QAAQ,CAACC,QAAQ,CAACmI,QAAQ,CAAC,CAAC;IACjC,IAAI,CAACpI,QAAQ,CAACE,IAAI,CAACkI,QAAQ,CAAC,CAAC;IAE7B,OAAO/F,OAAO,CAACgB,GAAG,CAACwE,QAAQ,CAAC;EAChC,CAAC;EAAAtF,MAAA,CAEK8F,MAAM,GAAZ,eAAMA,MAAMA,CAAA,EAAG;IACX,MAAM3K,cAAc,CAAC,IAAI,CAAC0F,YAAY,CAAC,CAACiF,MAAM,CAAC,CAAC;IAChD,IAAMlF,QAAQ,GAAG,MAAM,IAAI,CAAClC,eAAe;IAC3C,MAAM,IAAI,CAACY,MAAM,CAAC,CAAC;IACnB,MAAM/C,oCAAoC,CACtC,IAAI,CAACS,UAAU,EACf4D,QAAQ,CAACzB,cAAc,EACvByB,QAAQ,CAAC3B,MACb,CAAC;EACL,CAAC;EAAA,OAAAnC,kBAAA;AAAA;AAIL,OAAO,SAASiJ,qBAAqBA,CACjC;EACIhJ,qBAAqB;EACrBC,UAAU;EACVC,YAAY,GAAG,UAAU;EACzBC,IAAI;EACJC,IAAI;EACJC,IAAI,GAAG,IAAI;EACXC,SAAS,GAAG,IAAI,GAAG,CAAC;EACpB2I,iBAAiB,GAAG,IAAI;EACxB1I,SAAS,GAAG,IAAI;EAChBC,uBAAuB,GAAG;AACiB,CAAC,EACH;EAC7Cf,WAAW,CAACvB,wBAAwB,CAAC;;EAErC;AACJ;AACA;AACA;AACA;EACI,IAAI,CAACiC,IAAI,IAAI,CAACC,IAAI,EAAE;IAChB,MAAMnB,UAAU,CAAC,KAAK,EAAE;MACpBgB,UAAU,EAAEA,UAAU,CAAC8B,IAAI;MAC3BqF,IAAI,EAAE;QACFpH;MACJ;IACJ,CAAC,CAAC;EACN;EAEA,IAAMkJ,gBAAgB,GAAG,IAAInJ,kBAAkB,CAC3CC,qBAAqB,EACrBC,UAAU,EACVC,YAAY,EACZC,IAAI,EACJC,IAAI,EACJC,IAAI,EACJC,SAAS,EACTC,SAAS,EACTC,uBACJ,CAAC;EAGD,IACIA,uBAAuB,IACvB,OAAOkH,QAAQ,KAAK,WAAW,IAC/B,OAAOA,QAAQ,CAACyB,gBAAgB,KAAK,UAAU,IAC/C,OAAOzB,QAAQ,CAAC0B,eAAe,KAAK,QAAQ,EAC9C;IACE,IAAMlD,OAAO,GAAGA,CAAA,KAAM;MAClB,IAAIgD,gBAAgB,CAAC9F,SAAS,CAAC,CAAC,EAAE;QAC9B;MACJ;MACA,IAAMiG,SAAS,GAAG3B,QAAQ,CAAC0B,eAAe;MAC1C,IAAIC,SAAS,EAAE;QACXH,gBAAgB,CAAC/F,KAAK,CAAC,CAAC;MAC5B,CAAC,MAAM;QACH;AAChB;AACA;AACA;AACA;QACgB,IAAI,CAAClD,UAAU,CAAC4B,QAAQ,CAACyH,QAAQ,CAAC,CAAC,EAAE;UACjCJ,gBAAgB,CAACnB,KAAK,CAAC,CAAC;QAC5B;MACJ;IACJ,CAAC;IACDL,QAAQ,CAACyB,gBAAgB,CAAC,kBAAkB,EAAEjD,OAAO,CAAC;IACtDgD,gBAAgB,CAAC3H,QAAQ,CAACnB,IAAI,CAC1B,MAAMsH,QAAQ,CAAC6B,mBAAmB,CAAC,kBAAkB,EAAErD,OAAO,CAClE,CAAC;EACL;EAGAsD,4BAA4B,CAACP,iBAAiB,EAAEC,gBAAgB,CAAC;EACjE,OAAOA,gBAAgB;AAC3B;AAGA,OAAO,SAASM,4BAA4BA,CACxCP,iBAA0B,EAC1BC,gBAA8C,EAChD;EACE;AACJ;AACA;AACA;EACI,IAAMO,qBAAqB,GAAGR,iBAAiB,IAAIC,gBAAgB,CAACjJ,UAAU,CAAC4B,QAAQ,CAACwC,aAAa;EACrG,IAAMqF,WAAyB,GAAGD,qBAAqB,GAAGP,gBAAgB,CAACjJ,UAAU,CAAC4B,QAAQ,CAACoH,iBAAiB,CAAC,CAAC,GAAGxK,oBAAoB;EACzI,OAAOiL,WAAW,CAAChB,IAAI,CAAC,MAAM;IAC1B,IAAIQ,gBAAgB,CAAC9F,SAAS,CAAC,CAAC,EAAE;MAC9B;IACJ;IACA,IAAI8F,gBAAgB,CAAC3I,SAAS,EAAE;MAC5B2I,gBAAgB,CAAC/F,KAAK,CAAC,CAAC;IAC5B;EACJ,CAAC,CAAC;AACN","ignoreList":[]}