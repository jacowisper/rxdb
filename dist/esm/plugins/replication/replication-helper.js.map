{"version":3,"file":"replication-helper.js","names":["flatClone","getComposedPrimaryKeyOfDocumentData","DEFAULT_MODIFIER","d","Promise","resolve","swapDefaultDeletedTodeletedField","deletedField","doc","isDeleted","_deleted","handlePulledDocuments","collection","docs","map","useDoc","primaryPath","schema","jsonSchema","awaitRetry","retryTime","window","addEventListener","navigator","onLine","promiseWait","listener","onlineAgain","res","removeEventListener","race","then","preventHibernateBrowserTab","replicationState","simulateActivity","document","dispatchEvent","event","Event","intervalId","setInterval","onCancel","push","clearInterval"],"sources":["../../../../src/plugins/replication/replication-helper.ts"],"sourcesContent":["import type {\r\n    RxCollection,\r\n    WithDeleted\r\n} from '../../types/index.d.ts';\r\nimport { flatClone } from '../../plugins/utils/index.ts';\r\nimport { getComposedPrimaryKeyOfDocumentData } from '../../rx-schema-helper.ts';\r\nimport type { RxReplicationState } from './index.ts';\r\n\r\n// does nothing\r\nexport const DEFAULT_MODIFIER = (d: any) => Promise.resolve(d);\r\n\r\n\r\nexport function swapDefaultDeletedTodeletedField<RxDocType>(\r\n    deletedField: string,\r\n    doc: WithDeleted<RxDocType>\r\n): RxDocType {\r\n    if (deletedField === '_deleted') {\r\n        return doc;\r\n    } else {\r\n        doc = flatClone(doc);\r\n        const isDeleted = !!doc._deleted;\r\n        (doc as any)[deletedField] = isDeleted;\r\n        delete (doc as any)._deleted;\r\n        return doc;\r\n    }\r\n}\r\n\r\n/**\r\n * Must be run over all plain document data\r\n * that was pulled from the remote.\r\n * Used to fill up fields or modify the deleted field etc.\r\n */\r\nexport function handlePulledDocuments<RxDocType>(\r\n    collection: RxCollection<RxDocType>,\r\n    deletedField: string,\r\n    docs: RxDocType[]\r\n): WithDeleted<RxDocType>[] {\r\n    return docs.map(doc => {\r\n        const useDoc: WithDeleted<RxDocType> = flatClone(doc) as any;\r\n\r\n        /**\r\n         * Swap out the deleted field\r\n         */\r\n        if (deletedField !== '_deleted') {\r\n            const isDeleted = !!(useDoc as any)[deletedField];\r\n            (useDoc as any)._deleted = isDeleted;\r\n            delete (useDoc as any)[deletedField];\r\n        } else {\r\n            // ensure we have a boolean.\r\n            useDoc._deleted = !!useDoc._deleted;\r\n        }\r\n\r\n        /**\r\n         * Fill up composed primary\r\n         */\r\n        const primaryPath = collection.schema.primaryPath;\r\n        (useDoc as any)[primaryPath] = getComposedPrimaryKeyOfDocumentData(\r\n            collection.schema.jsonSchema,\r\n            useDoc\r\n        );\r\n        return useDoc as any;\r\n    });\r\n}\r\n\r\n\r\n/**\r\n * Like normal promiseWait()\r\n * but will skip the wait time if the online-state changes.\r\n */\r\nexport function awaitRetry(\r\n    collection: RxCollection,\r\n    retryTime: number\r\n) {\r\n    if (\r\n        typeof window === 'undefined' ||\r\n        typeof window !== 'object' ||\r\n        typeof window.addEventListener === 'undefined' ||\r\n        navigator.onLine\r\n    ) {\r\n        return collection.promiseWait(retryTime);\r\n    }\r\n\r\n    let listener: any;\r\n    const onlineAgain = new Promise<void>(res => {\r\n        listener = () => {\r\n            window.removeEventListener('online', listener);\r\n            res();\r\n        };\r\n        window.addEventListener('online', listener);\r\n    });\r\n\r\n    return Promise.race([\r\n        onlineAgain,\r\n        collection.promiseWait(retryTime)\r\n    ]).then(() => {\r\n        window.removeEventListener('online', listener);\r\n    });\r\n}\r\n\r\n\r\n/**\r\n * When a replication is running and the leading tab get hibernated\r\n * by the browser, the replication will be stuck.\r\n * To prevent this, we fire a mouseeven each X seconds while the replication is not canceled.\r\n * \r\n * If you find a better way to prevent hibernation, please make a pull request.\r\n */\r\nexport function preventHibernateBrowserTab(replicationState: RxReplicationState<any, any>) {\r\n    function simulateActivity() {\r\n        if (\r\n            typeof document === 'undefined' ||\r\n            typeof document.dispatchEvent !== 'function'\r\n        ) {\r\n            return;\r\n        }\r\n        const event = new Event('mousemove');\r\n        document.dispatchEvent(event);\r\n    }\r\n\r\n    const intervalId = setInterval(simulateActivity, 20 * 1000); // Simulate activity every 20 seconds\r\n    replicationState.onCancel.push(() => clearInterval(intervalId));\r\n}\r\n"],"mappings":"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","ignoreList":[]}