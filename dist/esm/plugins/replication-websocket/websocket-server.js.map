{"version":3,"file":"websocket-server.js","names":["pkg","WebSocketServer","rxStorageInstanceToReplicationHandler","PROMISE_RESOLVE_VOID","getFromMapOrCreate","Subject","startSocketServer","options","wss","closed","closeServer","onConnection$","complete","Promise","res","rej","ws","clients","close","err","on","next","server","asObservable","REPLICATION_HANDLER_BY_COLLECTION","Map","getReplicationHandlerByCollection","database","collectionName","collections","Error","collection","handler","storageInstance","conflictHandler","token","startWebsocketServer","wsOptions","serverState","onClose","push","subscribe","onCloseHandlers","onclose","map","fn","messageString","message","JSON","parse","method","changeStreamSub","masterChangeStream$","ev","streamResponse","id","result","send","stringify","unsubscribe","params","response"],"sources":["../../../../src/plugins/replication-websocket/websocket-server.ts"],"sourcesContent":["import type {\r\n    RxCollection,\r\n    RxDatabase,\r\n    RxReplicationHandler\r\n} from '../../types/index.d.ts';\r\n\r\nimport type {\r\n    WebSocket,\r\n    ServerOptions\r\n} from 'isomorphic-ws';\r\nimport pkg from 'isomorphic-ws';\r\nconst { WebSocketServer } = pkg;\r\n\r\nimport type {\r\n    WebsocketMessageResponseType,\r\n    WebsocketMessageType,\r\n    WebsocketServerOptions,\r\n    WebsocketServerState\r\n} from './websocket-types.ts';\r\nimport { rxStorageInstanceToReplicationHandler } from '../../replication-protocol/index.ts';\r\nimport {\r\n    PROMISE_RESOLVE_VOID, getFromMapOrCreate\r\n} from '../../plugins/utils/index.ts';\r\nimport { Subject } from 'rxjs';\r\n\r\nexport function startSocketServer(options: ServerOptions): WebsocketServerState {\r\n    const wss = new WebSocketServer(options);\r\n    let closed = false;\r\n    function closeServer() {\r\n        if (closed) {\r\n            return PROMISE_RESOLVE_VOID;\r\n        }\r\n        closed = true;\r\n        onConnection$.complete();\r\n        return new Promise<void>((res, rej) => {\r\n            /**\r\n             * We have to close all client connections,\r\n             * otherwise wss.close() will never call the callback.\r\n             * @link https://github.com/websockets/ws/issues/1288#issuecomment-360594458\r\n             */\r\n            for (const ws of wss.clients) {\r\n                ws.close();\r\n            }\r\n            wss.close((err: any) => {\r\n                if (err) {\r\n                    rej(err);\r\n                } else {\r\n                    res();\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    const onConnection$ = new Subject<WebSocket>();\r\n    wss.on('connection', (ws: any) => onConnection$.next(ws));\r\n\r\n    return {\r\n        server: wss,\r\n        close: closeServer,\r\n        onConnection$: onConnection$.asObservable()\r\n    };\r\n}\r\n\r\nconst REPLICATION_HANDLER_BY_COLLECTION: WeakMap<RxCollection, RxReplicationHandler<any, any>> = new Map();\r\nexport function getReplicationHandlerByCollection<RxDocType>(\r\n    database: RxDatabase<any>,\r\n    collectionName: string\r\n): RxReplicationHandler<RxDocType, any> {\r\n    if (!database.collections[collectionName]) {\r\n        throw new Error('collection ' + collectionName + ' does not exist');\r\n    }\r\n\r\n    const collection = database.collections[collectionName];\r\n    const handler = getFromMapOrCreate<RxCollection, RxReplicationHandler<RxDocType, any>>(\r\n        REPLICATION_HANDLER_BY_COLLECTION,\r\n        collection,\r\n        () => {\r\n            return rxStorageInstanceToReplicationHandler(\r\n                collection.storageInstance,\r\n                collection.conflictHandler,\r\n                database.token\r\n            );\r\n        }\r\n    );\r\n    return handler;\r\n}\r\n\r\nexport function startWebsocketServer(options: WebsocketServerOptions): WebsocketServerState {\r\n    const { database, ...wsOptions } = options;\r\n    const serverState = startSocketServer(wsOptions);\r\n\r\n    // auto close when the database gets closed\r\n    database.onClose.push(() => serverState.close());\r\n\r\n    serverState.onConnection$.subscribe(ws => {\r\n        const onCloseHandlers: Function[] = [];\r\n        ws.onclose = () => {\r\n            onCloseHandlers.map(fn => fn());\r\n        };\r\n        ws.on('message', async (messageString: string) => {\r\n            const message: WebsocketMessageType = JSON.parse(messageString);\r\n            const handler = getReplicationHandlerByCollection(database, message.collection);\r\n            if (message.method === 'auth') {\r\n                return;\r\n            }\r\n            const method = handler[message.method];\r\n\r\n            /**\r\n             * If it is not a function,\r\n             * it means that the client requested the masterChangeStream$\r\n             */\r\n            if (typeof method !== 'function') {\r\n                const changeStreamSub = handler.masterChangeStream$.subscribe(ev => {\r\n                    const streamResponse: WebsocketMessageResponseType = {\r\n                        id: 'stream',\r\n                        collection: message.collection,\r\n                        result: ev\r\n                    };\r\n                    ws.send(JSON.stringify(streamResponse));\r\n                });\r\n                onCloseHandlers.push(() => changeStreamSub.unsubscribe());\r\n                return;\r\n            }\r\n            const result = await (method as any)(...message.params);\r\n            const response: WebsocketMessageResponseType = {\r\n                id: message.id,\r\n                collection: message.collection,\r\n                result\r\n            };\r\n            ws.send(JSON.stringify(response));\r\n        });\r\n    });\r\n\r\n\r\n    return serverState;\r\n}\r\n"],"mappings":"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","ignoreList":[]}