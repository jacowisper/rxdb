{"version":3,"file":"check-document.js","names":["newRxError","fillPrimaryKey","getPrimaryFieldOfPrimaryKey","ensurePrimaryKeyValid","primaryKey","docData","document","trim","includes","containsDateInstance","obj","key","hasOwnProperty","Date","checkWriteRows","storageInstance","rows","primaryPath","schema","_loop","writeRow","previous","Object","keys","_meta","forEach","metaFieldName","prototype","call","dataBefore","dataAfter","args","structuredClone","JSON","parse","stringify","err","collection","collectionName"],"sources":["../../../../src/plugins/dev-mode/check-document.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\r\nimport { fillPrimaryKey, getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\r\nimport type { BulkWriteRow, RxDocumentData, RxStorageInstance } from '../../types/index.d.ts';\r\n\r\nexport function ensurePrimaryKeyValid(\r\n    primaryKey: string,\r\n    docData: RxDocumentData<any>\r\n) {\r\n    if (!primaryKey) {\r\n        throw newRxError('DOC20', {\r\n            primaryKey,\r\n            document: docData\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * This is required so that we can left-pad\r\n     * the primaryKey and we are still able to de-left-pad\r\n     * it to get again the original key.\r\n     */\r\n    if (\r\n        primaryKey !== primaryKey.trim()\r\n    ) {\r\n        throw newRxError('DOC21', {\r\n            primaryKey,\r\n            document: docData\r\n        });\r\n    }\r\n    if (\r\n        primaryKey.includes('\\r') ||\r\n        primaryKey.includes('\\n')\r\n    ) {\r\n        throw newRxError('DOC22', {\r\n            primaryKey,\r\n            document: docData\r\n        });\r\n    }\r\n    if (\r\n        primaryKey.includes('\"')\r\n    ) {\r\n        throw newRxError('DOC23', {\r\n            primaryKey,\r\n            document: docData\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Deeply checks if the object contains an\r\n * instance of the JavaScript Date class.\r\n * @recursive\r\n */\r\nexport function containsDateInstance(obj: any): boolean {\r\n    if (typeof obj !== 'object' || obj === null) {\r\n        return false;\r\n    }\r\n    for (let key in obj) {\r\n        if (obj.hasOwnProperty(key)) {\r\n            if (obj[key] instanceof Date) {\r\n                return true;\r\n            }\r\n            if (typeof obj[key] === 'object' && containsDateInstance(obj[key])) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n\r\nexport function checkWriteRows<RxDocType>(\r\n    storageInstance: RxStorageInstance<RxDocType, any, any, any>,\r\n    rows: BulkWriteRow<RxDocType>[]\r\n) {\r\n    const primaryPath = getPrimaryFieldOfPrimaryKey(storageInstance.schema.primaryKey);\r\n    for (const writeRow of rows) {\r\n        // ensure that the primary key has not been changed\r\n        writeRow.document = fillPrimaryKey(\r\n            primaryPath,\r\n            storageInstance.schema,\r\n            writeRow.document\r\n        );\r\n\r\n\r\n\r\n        /**\r\n         * Ensure that _meta fields have been merged\r\n         * and not replaced.\r\n         * This is important so that when one plugin A\r\n         * sets a _meta field and another plugin B does a write\r\n         * to the document, it must be ensured that the\r\n         * field of plugin A was not removed.\r\n         */\r\n        if (writeRow.previous) {\r\n            Object.keys(writeRow.previous._meta)\r\n                .forEach(metaFieldName => {\r\n                    if (!Object.prototype.hasOwnProperty.call(writeRow.document._meta, metaFieldName)) {\r\n                        throw newRxError('SNH', {\r\n                            dataBefore: writeRow.previous,\r\n                            dataAfter: writeRow.document,\r\n                            args: {\r\n                                metaFieldName\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n        }\r\n\r\n        /**\r\n         * Ensure it can be structured cloned\r\n         */\r\n        try {\r\n            /**\r\n             * Notice that structuredClone() is not available\r\n             * in ReactNative, so we test for JSON.stringify() instead\r\n             * @link https://github.com/pubkey/rxdb/issues/5046#issuecomment-1827374498\r\n             */\r\n            if (typeof structuredClone === 'function') {\r\n                structuredClone(writeRow);\r\n            } else {\r\n                JSON.parse(JSON.stringify(writeRow));\r\n            }\r\n        } catch (err) {\r\n            throw newRxError('DOC24', {\r\n                collection: storageInstance.collectionName,\r\n                document: writeRow.document\r\n            });\r\n        }\r\n\r\n\r\n        /**\r\n         * Ensure it does not contain a Date() object\r\n         */\r\n        if (containsDateInstance(writeRow.document)) {\r\n            throw newRxError('DOC24', {\r\n                collection: storageInstance.collectionName,\r\n                document: writeRow.document\r\n            });\r\n        }\r\n    }\r\n\r\n}\r\n"],"mappings":"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","ignoreList":[]}