{"version":3,"file":"rx-state.js","names":["Subject","distinctUntilChanged","map","merge","shareReplay","startWith","tap","overwritable","getChangedDocumentsSince","RXJS_SHARE_REPLAY_DEFAULTS","getProperty","setProperty","PROMISE_RESOLVE_VOID","appendToArray","clone","randomToken","deepEqual","getFromMapOrCreate","RX_STATE_COLLECTION_SCHEMA","isValidWeakMapKey","nextRxStateId","newRxError","runPluginHooks","debugId","deepFrozenCache","WeakMap","RxStateBase","prefix","collection","_id","_state","_nonPersisted","_writeQueue","_initDone","_instanceId","properties","sId","maxLength","_ownEmits$","onClose","push","_lastIdQuery","findOne","sort","id","$","subscribe","eventBulks$","pipe","eventBulk","events","index","length","event","operation","documentData","mergeOperationsIntoState","ops","_proto","prototype","set","path","modifier","_triggerWrite","then","useWrites","done","lastIdDoc","exec","nextId","undefined","newState","writeRow","value","newValue","k","v","insert","next","err","code","catch","error","name","get","ret","isDevMode","frozen","deepFreezeWhenDevMode","get$","get$$","obs","reactivity","database","getReactivityFactory","fromObservable","_cleanup","firstWrite","lastWrite","firstNr","parseInt","lastNr","find","selector","$lte","remove","createRxState","collectionName","addCollections","schema","collections","rxState","checkpoint","result","storageInstance","documents","document","proxy","Proxy","target","property","bind","lastChar","charAt","endsWith","key","slice","receiver","Error","state","operations"],"sources":["../../../../src/plugins/state/rx-state.ts"],"sourcesContent":["import {\r\n    Observable,\r\n    Subject,\r\n    distinctUntilChanged,\r\n    map,\r\n    merge,\r\n    shareReplay,\r\n    startWith,\r\n    tap\r\n} from 'rxjs';\r\nimport { overwritable } from '../../overwritable.ts';\r\nimport { getChangedDocumentsSince } from '../../rx-storage-helper.ts';\r\nimport type {\r\n    RxCollection,\r\n    RxDatabase,\r\n    RxQuery,\r\n    RxDocument,\r\n    RxError,\r\n    Paths\r\n} from '../../types';\r\nimport {\r\n    RXJS_SHARE_REPLAY_DEFAULTS,\r\n    getProperty,\r\n    setProperty,\r\n    PROMISE_RESOLVE_VOID,\r\n    appendToArray,\r\n    clone,\r\n    randomToken,\r\n    deepEqual,\r\n    getFromMapOrCreate\r\n} from '../utils/index.ts';\r\nimport {\r\n    RX_STATE_COLLECTION_SCHEMA,\r\n    isValidWeakMapKey,\r\n    nextRxStateId\r\n} from './helpers.ts';\r\nimport {\r\n    RxStateDocument,\r\n    RxStateOperation,\r\n    RxStateModifier\r\n} from './types.ts';\r\nimport { newRxError } from '../../rx-error.ts';\r\nimport { runPluginHooks } from '../../hooks.ts';\r\n\r\n\r\nlet debugId = 0;\r\n\r\n\r\nconst deepFrozenCache = new WeakMap<any, any>();\r\n\r\n/**\r\n * RxDB internally used properties are\r\n * prefixed with lodash _ to make them less\r\n * likely to clash with actual state properties\r\n * from the user.\r\n */\r\nexport class RxStateBase<T, Reactivity = unknown> {\r\n    // used for debugging\r\n    public _id: number = debugId++;\r\n    public _state: T | any = {};\r\n    public $: Observable<T>;\r\n    public _lastIdQuery: RxQuery<RxStateDocument, RxDocument<RxStateDocument, {}> | null>;\r\n    public _nonPersisted: {\r\n        path: string;\r\n        modifier: RxStateModifier;\r\n    }[] = [];\r\n    public _writeQueue = PROMISE_RESOLVE_VOID;\r\n    public _initDone = false;\r\n    public _instanceId = randomToken(RX_STATE_COLLECTION_SCHEMA.properties.sId.maxLength);\r\n    public _ownEmits$ = new Subject<T>();\r\n\r\n    constructor(\r\n        public readonly prefix: string,\r\n        public readonly collection: RxCollection<RxStateDocument>\r\n    ) {\r\n        this.collection.onClose.push(() => this._writeQueue);\r\n        this._lastIdQuery = this.collection.findOne({\r\n            sort: [\r\n                { id: 'desc' }\r\n            ]\r\n        });\r\n        // make it \"hot\" for better write performance\r\n        this._lastIdQuery.$.subscribe();\r\n\r\n        this.$ = merge(\r\n            this._ownEmits$,\r\n            this.collection.eventBulks$.pipe(\r\n                tap(eventBulk => {\r\n                    if (!this._initDone) {\r\n                        return;\r\n                    }\r\n                    const events = eventBulk.events;\r\n                    for (let index = 0; index < events.length; index++) {\r\n                        const event = events[index];\r\n                        if (\r\n                            event.operation === 'INSERT' &&\r\n                            event.documentData.sId !== this._instanceId\r\n                        ) {\r\n                            mergeOperationsIntoState(this._state, event.documentData.ops);\r\n                        }\r\n                    }\r\n                })\r\n            )\r\n        ).pipe(\r\n            shareReplay(RXJS_SHARE_REPLAY_DEFAULTS),\r\n            map(() => this._state)\r\n        );\r\n        // directly subscribe because of the tap() side effect\r\n        this.$.subscribe();\r\n    }\r\n\r\n    async set(\r\n        path: Paths<T> | '',\r\n        modifier: RxStateModifier\r\n    ) {\r\n        this._nonPersisted.push({\r\n            path,\r\n            modifier\r\n        });\r\n        return this._triggerWrite();\r\n    }\r\n\r\n    /**\r\n     * To have deterministic writes,\r\n     * and to ensure that multiple js realms do not overwrite\r\n     * each other, the write happens with incremental ids\r\n     * that would throw conflict errors and trigger a retry.\r\n     */\r\n    _triggerWrite() {\r\n        this._writeQueue = this._writeQueue.then(async () => {\r\n            if (this._nonPersisted.length === 0) {\r\n                return;\r\n            }\r\n            let useWrites: typeof this._nonPersisted = [];\r\n            let done = false;\r\n            while (!done) {\r\n                const lastIdDoc = await this._lastIdQuery.exec();\r\n                appendToArray(useWrites, this._nonPersisted);\r\n                this._nonPersisted = [];\r\n                const nextId = nextRxStateId(lastIdDoc ? lastIdDoc.id : undefined);\r\n                try {\r\n                    /**\r\n                     * TODO instead of a deep-clone we should\r\n                     * only clone the parts where we know that they\r\n                     * will be changed. This would improve performance.\r\n                     */\r\n                    let newState = clone(this._state);\r\n                    const ops: RxStateOperation[] = [];\r\n                    for (let index = 0; index < useWrites.length; index++) {\r\n                        const writeRow = useWrites[index];\r\n                        const value = getProperty(newState, writeRow.path);\r\n                        const newValue = writeRow.modifier(value);\r\n                        /**\r\n                         * Here we have to clone the value because\r\n                         * some storages like the memory storage\r\n                         * make input data deep-frozen in dev-mode.\r\n                         */\r\n                        if (writeRow.path === '') {\r\n                            newState = clone(newValue);\r\n                        } else {\r\n                            setProperty(newState, writeRow.path, clone(newValue));\r\n                        }\r\n                        ops.push({\r\n                            k: writeRow.path,\r\n                            /**\r\n                             * Here we have to clone the value because\r\n                             * some storages like the memory storage\r\n                             * make input data deep-frozen in dev-mode.\r\n                             */\r\n                            v: clone(newValue)\r\n                        });\r\n                    }\r\n                    await this.collection.insert({\r\n                        id: nextId,\r\n                        sId: this._instanceId,\r\n                        ops\r\n                    });\r\n                    this._state = newState;\r\n                    this._ownEmits$.next(this._state);\r\n                    done = true;\r\n                } catch (err) {\r\n                    if ((err as RxError).code !== 'CONFLICT') {\r\n                        throw err;\r\n                    }\r\n                }\r\n            }\r\n        }).catch(error => {\r\n            throw newRxError('SNH', {\r\n                name: 'RxState WRITE QUEUE ERROR',\r\n                error\r\n            });\r\n        });\r\n        return this._writeQueue;\r\n    }\r\n\r\n    get(path?: Paths<T>) {\r\n        let ret;\r\n        if (!path) {\r\n            ret = this._state;\r\n        } else {\r\n            ret = getProperty(this._state, path);\r\n        }\r\n\r\n        /**\r\n         * In dev-mode we have to clone the value before deep-freezing\r\n         * it to not have an immutable subobject in the state value.\r\n         * But calling .get() with the same path multiple times,\r\n         * should return exactly the same object instance\r\n         * so it does not cause re-renders on react.\r\n         * So in dev-mode we have to \r\n         */\r\n        if (overwritable.isDevMode() && isValidWeakMapKey(ret)) {\r\n            const frozen = getFromMapOrCreate(\r\n                deepFrozenCache,\r\n                ret,\r\n                () => overwritable.deepFreezeWhenDevMode(clone(ret))\r\n            );\r\n            return frozen;\r\n        }\r\n\r\n        return ret;\r\n    }\r\n    get$(path?: Paths<T>): Observable<any> {\r\n        return this.$.pipe(\r\n            map(() => this.get(path)),\r\n            startWith(this.get(path)),\r\n            distinctUntilChanged(deepEqual),\r\n            shareReplay(RXJS_SHARE_REPLAY_DEFAULTS),\r\n        );\r\n    }\r\n    get$$(path?: Paths<T>): Reactivity {\r\n        const obs = this.get$(path);\r\n        const reactivity = this.collection.database.getReactivityFactory();\r\n        return reactivity.fromObservable(\r\n            obs,\r\n            this.get(path),\r\n            this.collection.database\r\n        ) as any;\r\n    }\r\n\r\n    /**\r\n     * Merges the state operations into a single write row\r\n     * to store space and make recreating the state from\r\n     * disc faster.\r\n     */\r\n    async _cleanup() {\r\n        const firstWrite = await this.collection.findOne({\r\n            sort: [{ id: 'asc' }]\r\n        }).exec();\r\n        const lastWrite = await this._lastIdQuery.exec();\r\n\r\n        if (!firstWrite || !lastWrite) {\r\n            return;\r\n        }\r\n\r\n        const firstNr = parseInt(firstWrite.id, 10);\r\n        const lastNr = parseInt(lastWrite.id, 10);\r\n        if ((lastNr - 5) < firstNr) {\r\n            // only run if more then 5 write rows\r\n            return;\r\n        }\r\n\r\n        // update whole state object\r\n        await this._writeQueue;\r\n        await this.set('', () => this._state);\r\n\r\n        // delete old ones\r\n        await this.collection.find({\r\n            selector: {\r\n                id: {\r\n                    $lte: lastWrite.id\r\n                }\r\n            }\r\n        }).remove();\r\n    }\r\n}\r\n\r\n\r\nexport async function createRxState<T>(\r\n    database: RxDatabase,\r\n    prefix: string\r\n): Promise<RxStateBase<T>> {\r\n    const collectionName = 'rx-state-' + prefix;\r\n    await database.addCollections({\r\n        [collectionName]: {\r\n            schema: RX_STATE_COLLECTION_SCHEMA as any\r\n        }\r\n    });\r\n    const collection: RxCollection<RxStateDocument> = database.collections[collectionName];\r\n\r\n    const rxState = new RxStateBase<T>(\r\n        prefix,\r\n        collection\r\n    );\r\n\r\n\r\n    /**\r\n     * Directly get the state and put it into memory.\r\n     * This ensures we can do non-async accesses to the\r\n     * correct state.\r\n     */\r\n    let done = false;\r\n    let checkpoint: any = undefined;\r\n    while (!done) {\r\n        const result = await getChangedDocumentsSince<RxStateDocument, any>(\r\n            collection.storageInstance,\r\n            1000,\r\n            checkpoint\r\n        );\r\n        checkpoint = result.checkpoint;\r\n        const documents = result.documents;\r\n        if (documents.length === 0) {\r\n            done = true;\r\n        } else {\r\n            for (let index = 0; index < documents.length; index++) {\r\n                const document = documents[index];\r\n                mergeOperationsIntoState(rxState._state, document.ops);\r\n            }\r\n        }\r\n    }\r\n    rxState._initDone = true;\r\n\r\n    const proxy = new Proxy(\r\n        rxState as any,\r\n        {\r\n            get(target, property: any) {\r\n                if (typeof property !== 'string') {\r\n                    return target[property];\r\n                }\r\n                if ((rxState as any)[property]) {\r\n                    const ret = (rxState as any)[property];\r\n                    if (typeof ret === 'function') {\r\n                        return ret.bind(rxState);\r\n                    } else {\r\n                        return ret;\r\n                    }\r\n                }\r\n                const lastChar = property.charAt(property.length - 1);\r\n                if (property.endsWith('$$')) {\r\n                    const key = property.slice(0, -2);\r\n                    return rxState.get$$(key as any);\r\n                } else if (lastChar === '$') {\r\n                    const key = property.slice(0, -1);\r\n                    return rxState.get$(key as any);\r\n                } else {\r\n                    return rxState.get(property as any);\r\n                }\r\n            },\r\n            set(target, newValue, receiver) {\r\n                throw new Error('Do not write to RxState');\r\n            }\r\n        }\r\n    );\r\n\r\n    runPluginHooks('createRxState', {\r\n        collection,\r\n        state: proxy\r\n    });\r\n\r\n    return proxy;\r\n}\r\n\r\n\r\nexport function mergeOperationsIntoState<T>(\r\n    state: T,\r\n    operations: RxStateOperation[]\r\n) {\r\n    for (let index = 0; index < operations.length; index++) {\r\n        const operation = operations[index];\r\n        setProperty(state, operation.k, clone(operation.v));\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]}