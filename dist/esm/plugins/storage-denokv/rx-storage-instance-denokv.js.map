{"version":3,"file":"rx-storage-instance-denokv.js","names":["Subject","getPrimaryFieldOfPrimaryKey","addRxStorageMultiInstanceSupport","CLEANUP_INDEX","DENOKV_DOCUMENT_ROOT_PATH","RX_STORAGE_NAME_DENOKV","getDenoGlobal","getDenoKVIndexName","getIndexableStringMonad","getStartIndexStringFromLowerBound","appendToArray","batchArray","toArray","ensureNotFalsy","categorizeBulkWriteRows","now","queryDenoKV","INDEX_MAX","flatClone","RxStorageInstanceDenoKV","storage","databaseName","collectionName","schema","internals","options","settings","keySpace","version","join","kvOptions","consistency","consistencyLevel","changes$","primaryPath","primaryKey","kvPromise","openKv","openKvPath","then","kv","set","_proto","prototype","retryUntilNoWriteInBetween","fn","writeBlockKeyBefore","get","writeBlockValueBefore","value","result","writeBlockKeyAfter","writeBlockValueAfter","bulkWrite","documentWrites","context","_this","ret","error","batches","batchSize","writeBatch","_loop","writeBlockKey","docsInDB","Map","readManyBatches","Promise","all","map","readManyBatch","docsResult","getMany","writeRow","docId","document","row","docData","categorized","tx","atomic","check","bulkInsertDocs","forEach","Object","values","indexes","indexMeta","indexString","getIndexableString","indexId","bulkUpdateDocs","oldIndexString","previous","newIndexString","delete","txResult","commit","err","message","includes","ok","errors","eventBulk","events","length","lastState","newestRow","checkpoint","id","lwt","_meta","next","findDocumentsById","ids","withDeleted","kvKey","findSingleResult","docInDb","_deleted","push","query","preparedQuery","count","documents","mode","getAttachmentData","documentId","attachmentId","digest","Error","changeStream","asObservable","cleanup","minimumDeletedTime","_this2","maxDeletionTime","index","indexName","lowerBoundString","upperBoundString","noMoreUndeleted","range","list","start","end","limit","rangeCount","_loop2","docDataResult","indexMetaInner","_ret","close","closed","complete","remove","ensureNotClosed","promises","key","createDenoKVStorageInstance","params","indexDBs","useIndexes","slice","useIndexesFinal","indexAr","instance","resolve"],"sources":["../../../../src/plugins/storage-denokv/rx-storage-instance-denokv.ts"],"sourcesContent":["\r\nimport {\r\n    Subject,\r\n    Observable\r\n} from 'rxjs';\r\nimport type {\r\n    RxStorageInstance,\r\n    RxStorageChangeEvent,\r\n    RxDocumentData,\r\n    BulkWriteRow,\r\n    RxStorageBulkWriteResponse,\r\n    RxStorageQueryResult,\r\n    RxJsonSchema,\r\n    RxStorageInstanceCreationParams,\r\n    EventBulk,\r\n    StringKeys,\r\n    RxStorageDefaultCheckpoint,\r\n    RxStorageCountResult,\r\n    PreparedQuery\r\n} from '../../types/index.d.ts';\r\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\r\nimport { addRxStorageMultiInstanceSupport } from '../../rx-storage-multiinstance.ts';\r\nimport type { DenoKVIndexMeta, DenoKVSettings, DenoKVStorageInternals } from './denokv-types.ts';\r\nimport { RxStorageDenoKV } from './index.ts';\r\nimport { CLEANUP_INDEX, DENOKV_DOCUMENT_ROOT_PATH, RX_STORAGE_NAME_DENOKV, getDenoGlobal, getDenoKVIndexName } from \"./denokv-helper.ts\";\r\nimport { getIndexableStringMonad, getStartIndexStringFromLowerBound } from \"../../custom-index.ts\";\r\nimport { appendToArray, batchArray, lastOfArray, toArray } from \"../utils/utils-array.ts\";\r\nimport { ensureNotFalsy } from \"../utils/utils-other.ts\";\r\nimport { categorizeBulkWriteRows } from \"../../rx-storage-helper.ts\";\r\nimport { now } from \"../utils/utils-time.ts\";\r\nimport { queryDenoKV } from \"./denokv-query.ts\";\r\nimport { INDEX_MAX } from \"../../query-planner.ts\";\r\nimport { PROMISE_RESOLVE_VOID } from \"../utils/utils-promise.ts\";\r\nimport { flatClone } from \"../utils/utils-object.ts\";\r\n\r\n\r\n\r\nexport class RxStorageInstanceDenoKV<RxDocType> implements RxStorageInstance<\r\n    RxDocType,\r\n    DenoKVStorageInternals<RxDocType>,\r\n    DenoKVSettings,\r\n    RxStorageDefaultCheckpoint\r\n> {\r\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\r\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\r\n    public closed?: Promise<void>;\r\n    public readonly kvPromise: Promise<any>;\r\n\r\n    constructor(\r\n        public readonly storage: RxStorageDenoKV,\r\n        public readonly databaseName: string,\r\n        public readonly collectionName: string,\r\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\r\n        public readonly internals: DenoKVStorageInternals<RxDocType>,\r\n        public readonly options: Readonly<DenoKVSettings>,\r\n        public readonly settings: DenoKVSettings,\r\n        public readonly keySpace = ['rxdb', databaseName, collectionName, schema.version].join('|'),\r\n        public readonly kvOptions = { consistency: settings.consistencyLevel }\r\n    ) {\r\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\r\n        this.kvPromise = getDenoGlobal().openKv(settings.openKvPath).then(async (kv: any) => {\r\n            // insert writeBlockKey\r\n            await kv.set([this.keySpace], 1);\r\n            return kv;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * DenoKV has no transactions\r\n     * so we have to ensure that there is no write in between our queries\r\n     * which would confuse RxDB and return wrong query results.\r\n     */\r\n    async retryUntilNoWriteInBetween<T>(\r\n        fn: () => Promise<T>\r\n    ): Promise<T> {\r\n        const kv = await this.kvPromise;\r\n        while (true) {\r\n            const writeBlockKeyBefore = await kv.get([this.keySpace], this.kvOptions);\r\n            const writeBlockValueBefore = writeBlockKeyBefore ? writeBlockKeyBefore.value : -1;\r\n            const result = await fn();\r\n            const writeBlockKeyAfter = await kv.get([this.keySpace], this.kvOptions);\r\n            const writeBlockValueAfter = writeBlockKeyAfter ? writeBlockKeyAfter.value : -1;\r\n\r\n            if (writeBlockValueBefore === writeBlockValueAfter) {\r\n                return result;\r\n            }\r\n        }\r\n    }\r\n\r\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[], context: string): Promise<RxStorageBulkWriteResponse<RxDocType>> {\r\n        const kv = await this.kvPromise;\r\n        const primaryPath = this.primaryPath;\r\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\r\n            error: []\r\n        };\r\n\r\n        const batches = batchArray(documentWrites, ensureNotFalsy(this.settings.batchSize));\r\n\r\n        /**\r\n         * DenoKV does not have transactions\r\n         * so we use a special writeBlock row to ensure\r\n         * atomic writes (per document)\r\n         * and so that we can do bulkWrites\r\n         */\r\n        for (const writeBatch of batches) {\r\n            while (true) {\r\n                const writeBlockKey = await kv.get([this.keySpace], this.kvOptions);\r\n                const docsInDB = new Map<string, RxDocumentData<RxDocType>>();\r\n\r\n                /**\r\n                 * The max amount for .getMany() is 10 which is defined by deno itself:\r\n                 * @link https://docs.deno.com/deploy/kv/manual/transactions/\r\n                 * @link https://github.com/denoland/deno/issues/19284\r\n                 */\r\n                const readManyBatches = batchArray(writeBatch, 10);\r\n                await Promise.all(\r\n                    readManyBatches.map(async (readManyBatch) => {\r\n                        const docsResult = await kv.getMany(\r\n                            readManyBatch.map(writeRow => {\r\n                                const docId: string = writeRow.document[primaryPath] as any;\r\n                                return [this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId];\r\n                            })\r\n                        );\r\n                        docsResult.map((row: any) => {\r\n                            const docData = row.value;\r\n                            if (!docData) {\r\n                                return;\r\n                            }\r\n                            const docId: string = docData[primaryPath] as any;\r\n                            docsInDB.set(docId, docData);\r\n                        });\r\n                    })\r\n                );\r\n                const categorized = categorizeBulkWriteRows<RxDocType>(\r\n                    this,\r\n                    this.primaryPath as any,\r\n                    docsInDB,\r\n                    writeBatch,\r\n                    context\r\n                );\r\n\r\n                let tx = kv.atomic();\r\n                tx = tx.set([this.keySpace], ensureNotFalsy(writeBlockKey.value) + 1);\r\n                tx = tx.check(writeBlockKey);\r\n\r\n                // INSERTS\r\n                categorized.bulkInsertDocs.forEach(writeRow => {\r\n                    const docId: string = writeRow.document[this.primaryPath] as any;\r\n\r\n                    // insert document data\r\n                    tx = tx.set([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], writeRow.document);\r\n\r\n                    // insert secondary indexes\r\n                    Object.values(this.internals.indexes).forEach(indexMeta => {\r\n                        const indexString = indexMeta.getIndexableString(writeRow.document as any);\r\n                        tx = tx.set([this.keySpace, indexMeta.indexId, indexString], docId);\r\n                    });\r\n                });\r\n                // UPDATES\r\n                categorized.bulkUpdateDocs.forEach((writeRow: BulkWriteRow<RxDocType>) => {\r\n                    const docId: string = writeRow.document[this.primaryPath] as any;\r\n\r\n                    // insert document data\r\n                    tx = tx.set([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], writeRow.document);\r\n\r\n                    // insert secondary indexes\r\n                    Object.values(this.internals.indexes).forEach(indexMeta => {\r\n                        const oldIndexString = indexMeta.getIndexableString(ensureNotFalsy(writeRow.previous));\r\n                        const newIndexString = indexMeta.getIndexableString(writeRow.document as any);\r\n                        if (oldIndexString !== newIndexString) {\r\n                            tx = tx.delete([this.keySpace, indexMeta.indexId, oldIndexString]);\r\n                            tx = tx.set([this.keySpace, indexMeta.indexId, newIndexString], docId);\r\n                        }\r\n                    });\r\n                });\r\n\r\n                let txResult;\r\n                try {\r\n                    txResult = await tx.commit();\r\n                } catch (err: any) {\r\n                    if (\r\n                        err.message.includes('Error code 5:') ||\r\n                        err.message.includes('Error code 517:') ||\r\n                        err.message.includes('database is locked')\r\n                    ) {\r\n                        // retry\r\n                    } else {\r\n                        throw err;\r\n                    }\r\n                }\r\n                if (txResult && txResult.ok) {\r\n                    appendToArray(ret.error, categorized.errors);\r\n                    if (categorized.eventBulk.events.length > 0) {\r\n                        const lastState = ensureNotFalsy(categorized.newestRow).document;\r\n                        categorized.eventBulk.checkpoint = {\r\n                            id: lastState[primaryPath],\r\n                            lwt: lastState._meta.lwt\r\n                        };\r\n                        this.changes$.next(categorized.eventBulk);\r\n                    }\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        return ret;\r\n    }\r\n    async findDocumentsById(ids: string[], withDeleted: boolean): Promise<RxDocumentData<RxDocType>[]> {\r\n        const kv = await this.kvPromise;\r\n        const ret: RxDocumentData<RxDocType>[] = [];\r\n        await Promise.all(\r\n            ids.map(async (docId) => {\r\n                const kvKey = [this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId];\r\n                const findSingleResult = await kv.get(kvKey, this.kvOptions);\r\n                const docInDb = findSingleResult.value;\r\n                if (\r\n                    docInDb &&\r\n                    (\r\n                        !docInDb._deleted ||\r\n                        withDeleted\r\n                    )\r\n                ) {\r\n                    ret.push(docInDb);\r\n                }\r\n            })\r\n        );\r\n        return ret;\r\n    }\r\n    query(preparedQuery: PreparedQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\r\n        return this.retryUntilNoWriteInBetween(\r\n            () => queryDenoKV(this, preparedQuery)\r\n        );\r\n    }\r\n    async count(preparedQuery: PreparedQuery<RxDocType>): Promise<RxStorageCountResult> {\r\n        /**\r\n         * At this point in time (end 2023), DenoKV does not support\r\n         * range counts. So we have to run a normal query and use the result set length.\r\n         * @link https://github.com/denoland/deno/issues/18965\r\n         */\r\n        const result = await this.retryUntilNoWriteInBetween(\r\n            () => this.query(preparedQuery)\r\n        );\r\n        return {\r\n            count: result.documents.length,\r\n            mode: 'fast'\r\n        };\r\n    }\r\n    getAttachmentData(documentId: string, attachmentId: string, digest: string): Promise<string> {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    changeStream() {\r\n        return this.changes$.asObservable();\r\n    }\r\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\r\n        const maxDeletionTime = now() - minimumDeletedTime;\r\n        const kv = await this.kvPromise;\r\n        const index = CLEANUP_INDEX;\r\n        const indexName = getDenoKVIndexName(index);\r\n        const indexMeta = this.internals.indexes[indexName];\r\n        const lowerBoundString = getStartIndexStringFromLowerBound(\r\n            this.schema,\r\n            index,\r\n            [\r\n                true,\r\n                /**\r\n                 * Do not use 0 here,\r\n                 * because 1 is the minimum value for _meta.lwt\r\n                 */\r\n                1\r\n            ]\r\n        );\r\n        const upperBoundString = getStartIndexStringFromLowerBound(\r\n            this.schema,\r\n            index,\r\n            [\r\n                true,\r\n                maxDeletionTime\r\n            ]\r\n        );\r\n        let noMoreUndeleted: boolean = true;\r\n\r\n        const range = kv.list({\r\n            start: [this.keySpace, indexMeta.indexId, lowerBoundString],\r\n            end: [this.keySpace, indexMeta.indexId, upperBoundString]\r\n        }, {\r\n            consistency: this.settings.consistencyLevel,\r\n            batchSize: this.settings.batchSize,\r\n            limit: this.settings.batchSize\r\n        });\r\n\r\n        let rangeCount = 0;\r\n        for await (const row of range) {\r\n            rangeCount = rangeCount + 1;\r\n            const docId = row.value;\r\n            const docDataResult = await kv.get([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], this.kvOptions);\r\n            if (!docDataResult.value) {\r\n                continue;\r\n            }\r\n            const docData = ensureNotFalsy(docDataResult.value);\r\n            if (\r\n                !docData._deleted ||\r\n                docData._meta.lwt > maxDeletionTime\r\n            ) {\r\n                continue;\r\n            }\r\n\r\n\r\n            let tx = kv.atomic();\r\n            tx = tx.check(docDataResult);\r\n            tx = tx.delete([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId]);\r\n            Object\r\n                .values(this.internals.indexes)\r\n                .forEach(indexMetaInner => {\r\n                    tx = tx.delete([this.keySpace, indexMetaInner.indexId, docId]);\r\n                });\r\n            await tx.commit();\r\n        }\r\n        return noMoreUndeleted;\r\n    }\r\n    async close(): Promise<void> {\r\n        if (this.closed) {\r\n            return this.closed;\r\n        }\r\n        this.closed = (async () => {\r\n            this.changes$.complete();\r\n            const kv = await this.kvPromise;\r\n            await kv.close();\r\n        })();\r\n        return this.closed;\r\n    }\r\n    async remove(): Promise<void> {\r\n        ensureNotClosed(this);\r\n        const kv = await this.kvPromise;\r\n        const range = kv.list({\r\n            start: [this.keySpace],\r\n            end: [this.keySpace, INDEX_MAX]\r\n        }, {\r\n            consistency: this.settings.consistencyLevel,\r\n            batchSize: this.settings.batchSize\r\n        });\r\n        let promises: Promise<any>[] = [];\r\n        for await (const row of range) {\r\n            promises.push(kv.delete(row.key));\r\n        }\r\n\r\n        await Promise.all(promises);\r\n        return this.close();\r\n    }\r\n}\r\n\r\n\r\n\r\nexport async function createDenoKVStorageInstance<RxDocType>(\r\n    storage: RxStorageDenoKV,\r\n    params: RxStorageInstanceCreationParams<RxDocType, DenoKVSettings>,\r\n    settings: DenoKVSettings\r\n): Promise<RxStorageInstanceDenoKV<RxDocType>> {\r\n    settings = flatClone(settings);\r\n    if (!settings.batchSize) {\r\n        settings.batchSize = 100;\r\n    }\r\n\r\n    const primaryPath = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\r\n\r\n    const indexDBs: { [indexName: string]: DenoKVIndexMeta<RxDocType>; } = {};\r\n    const useIndexes = params.schema.indexes ? params.schema.indexes.slice(0) : [];\r\n    useIndexes.push([primaryPath]);\r\n    const useIndexesFinal = useIndexes.map(index => {\r\n        const indexAr = toArray(index);\r\n        return indexAr;\r\n    });\r\n    useIndexesFinal.push(CLEANUP_INDEX);\r\n    useIndexesFinal.forEach((indexAr, indexId) => {\r\n        const indexName = getDenoKVIndexName(indexAr);\r\n        indexDBs[indexName] = {\r\n            indexId: '|' + indexId + '|',\r\n            indexName,\r\n            getIndexableString: getIndexableStringMonad(params.schema, indexAr),\r\n            index: indexAr\r\n        };\r\n    });\r\n\r\n    const internals = {\r\n        indexes: indexDBs\r\n    };\r\n    const instance = new RxStorageInstanceDenoKV(\r\n        storage,\r\n        params.databaseName,\r\n        params.collectionName,\r\n        params.schema,\r\n        internals,\r\n        params.options,\r\n        settings\r\n    );\r\n\r\n    await addRxStorageMultiInstanceSupport(\r\n        RX_STORAGE_NAME_DENOKV,\r\n        params,\r\n        instance\r\n    );\r\n\r\n    return Promise.resolve(instance);\r\n}\r\n\r\n\r\n\r\nfunction ensureNotClosed(\r\n    instance: RxStorageInstanceDenoKV<any>\r\n) {\r\n    if (instance.closed) {\r\n        throw new Error('RxStorageInstanceDenoKV is closed ' + instance.databaseName + '-' + instance.collectionName);\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]}