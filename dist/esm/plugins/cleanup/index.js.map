{"version":3,"file":"index.js","names":["runAsyncPluginHooks","DEFAULT_CLEANUP_POLICY","startCleanupForRxState","startCleanupForRxCollection","RxDBCleanupPlugin","name","rxdb","prototypes","RxCollection","proto","cleanup","minimumDeletedTime","cleanupPolicy","Object","assign","database","isDone","closed","storageInstance","collectionName","databaseName","hooks","createRxCollection","after","i","collection","createRxState","state"],"sources":["../../../../src/plugins/cleanup/index.ts"],"sourcesContent":["import { runAsyncPluginHooks } from '../../hooks.ts';\r\nimport type {\r\n    RxCollection,\r\n    RxPlugin\r\n} from '../../types/index.d.ts';\r\nimport { DEFAULT_CLEANUP_POLICY } from './cleanup-helper.ts';\r\nimport { startCleanupForRxState } from './cleanup-state.ts';\r\nimport { startCleanupForRxCollection } from './cleanup.ts';\r\n\r\nexport const RxDBCleanupPlugin: RxPlugin = {\r\n    name: 'cleanup',\r\n    rxdb: true,\r\n    prototypes: {\r\n        RxCollection: (proto: any) => {\r\n            proto.cleanup = async function (this: RxCollection, minimumDeletedTime?: number): Promise<void> {\r\n                const cleanupPolicy = Object.assign(\r\n                    {},\r\n                    DEFAULT_CLEANUP_POLICY,\r\n                    this.database.cleanupPolicy ? this.database.cleanupPolicy : {}\r\n                );\r\n\r\n                if (typeof minimumDeletedTime === 'undefined') {\r\n                    minimumDeletedTime = cleanupPolicy.minimumDeletedTime;\r\n                }\r\n\r\n                // run cleanup() until it returns true\r\n                let isDone = false;\r\n                while (!isDone && !this.closed) {\r\n                    isDone = await this.storageInstance.cleanup(minimumDeletedTime);\r\n                }\r\n\r\n                await runAsyncPluginHooks('postCleanup', {\r\n                    collectionName: this.name,\r\n                    databaseName: this.database.name\r\n                });\r\n            };\r\n        }\r\n    },\r\n    hooks: {\r\n        createRxCollection: {\r\n            after: (i) => {\r\n                startCleanupForRxCollection(i.collection);\r\n            }\r\n        },\r\n        createRxState: {\r\n            after: (i) => {\r\n                startCleanupForRxState(i.state);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nexport * from './cleanup.ts';\r\n"],"mappings":"AAAA,SAASA,mBAAmB,QAAQ,gBAAgB;AAKpD,SAASC,sBAAsB,QAAQ,qBAAqB;AAC5D,SAASC,sBAAsB,QAAQ,oBAAoB;AAC3D,SAASC,2BAA2B,QAAQ,cAAc;AAE1D,OAAO,IAAMC,iBAA2B,GAAG;EACvCC,IAAI,EAAE,SAAS;EACfC,IAAI,EAAE,IAAI;EACVC,UAAU,EAAE;IACRC,YAAY,EAAGC,KAAU,IAAK;MAC1BA,KAAK,CAACC,OAAO,GAAG,gBAAoCC,kBAA2B,EAAiB;QAC5F,IAAMC,aAAa,GAAGC,MAAM,CAACC,MAAM,CAC/B,CAAC,CAAC,EACFb,sBAAsB,EACtB,IAAI,CAACc,QAAQ,CAACH,aAAa,GAAG,IAAI,CAACG,QAAQ,CAACH,aAAa,GAAG,CAAC,CACjE,CAAC;QAED,IAAI,OAAOD,kBAAkB,KAAK,WAAW,EAAE;UAC3CA,kBAAkB,GAAGC,aAAa,CAACD,kBAAkB;QACzD;;QAEA;QACA,IAAIK,MAAM,GAAG,KAAK;QAClB,OAAO,CAACA,MAAM,IAAI,CAAC,IAAI,CAACC,MAAM,EAAE;UAC5BD,MAAM,GAAG,MAAM,IAAI,CAACE,eAAe,CAACR,OAAO,CAACC,kBAAkB,CAAC;QACnE;QAEA,MAAMX,mBAAmB,CAAC,aAAa,EAAE;UACrCmB,cAAc,EAAE,IAAI,CAACd,IAAI;UACzBe,YAAY,EAAE,IAAI,CAACL,QAAQ,CAACV;QAChC,CAAC,CAAC;MACN,CAAC;IACL;EACJ,CAAC;EACDgB,KAAK,EAAE;IACHC,kBAAkB,EAAE;MAChBC,KAAK,EAAGC,CAAC,IAAK;QACVrB,2BAA2B,CAACqB,CAAC,CAACC,UAAU,CAAC;MAC7C;IACJ,CAAC;IACDC,aAAa,EAAE;MACXH,KAAK,EAAGC,CAAC,IAAK;QACVtB,sBAAsB,CAACsB,CAAC,CAACG,KAAK,CAAC;MACnC;IACJ;EACJ;AACJ,CAAC;AAED,cAAc,cAAc","ignoreList":[]}