{"version":3,"file":"rx-query-single-result.js","names":["mapDocumentsDataToCacheDocs","now","overwriteGetterForCaching","newRxError","RxQuerySingleResult","query","docsDataFromStorageInstance","count","time","documents","collection","_docCache","_proto","prototype","getValue","throwIfMissing","op","doc","length","name","mangoQuery","docsMap","slice","_createClass","key","get","map","d","_data","Map","forEach","set","primary","i"],"sources":["../../src/rx-query-single-result.ts"],"sourcesContent":["import { mapDocumentsDataToCacheDocs } from './doc-cache.ts';\r\nimport { now, overwriteGetterForCaching } from './plugins/utils/index.ts';\r\nimport { newRxError } from './rx-error.ts';\r\nimport { RxQueryBase } from './rx-query.ts';\r\nimport type {\r\n    RxDocument,\r\n    RxDocumentData\r\n} from './types';\r\n\r\n/**\r\n * RxDB needs the query results in multiple formats.\r\n * Sometimes as a Map or an array with only the documentData.\r\n * For better performance we work with this class\r\n * that initializes stuff lazily so that\r\n * we can directly work with the query results after RxQuery.exec()\r\n */\r\nexport class RxQuerySingleResult<RxDocType> {\r\n    /**\r\n     * Time at which the current _result state was created.\r\n     * Used to determine if the result set has changed since X\r\n     * so that we do not emit the same result multiple times on subscription.\r\n     */\r\n    public readonly time = now();\r\n    public readonly documents: RxDocument<RxDocType>[];\r\n    constructor(\r\n        public readonly query: RxQueryBase<RxDocType, unknown>,\r\n        // only used internally, do not use outside, use this.docsData instead\r\n        docsDataFromStorageInstance: RxDocumentData<RxDocType>[],\r\n        // can be overwritten for count-queries\r\n        public readonly count: number,\r\n    ) {\r\n        this.documents = mapDocumentsDataToCacheDocs<RxDocType, any>(this.query.collection._docCache, docsDataFromStorageInstance);\r\n    }\r\n\r\n\r\n    /**\r\n     * Instead of using the newResultData in the result cache,\r\n     * we directly use the objects that are stored in the RxDocument\r\n     * to ensure we do not store the same data twice and fill up the memory.\r\n     * @overwrites itself with the actual value\r\n     */\r\n    get docsData(): RxDocumentData<RxDocType>[] {\r\n        return overwriteGetterForCaching(\r\n            this,\r\n            'docsData',\r\n            this.documents.map(d => d._data)\r\n        );\r\n    }\r\n\r\n\r\n    // A key->document map, used in the event reduce optimization.\r\n    get docsDataMap(): Map<string, RxDocumentData<RxDocType>> {\r\n        const map = new Map<string, RxDocumentData<RxDocType>>();\r\n        this.documents.forEach(d => {\r\n            map.set(d.primary, d._data);\r\n        });\r\n        return overwriteGetterForCaching(\r\n            this,\r\n            'docsDataMap',\r\n            map\r\n        );\r\n    }\r\n\r\n    get docsMap(): Map<string, RxDocument<RxDocType>> {\r\n        const map = new Map<string, RxDocument<RxDocType>>();\r\n        const documents = this.documents;\r\n        for (let i = 0; i < documents.length; i++) {\r\n            const doc = documents[i];\r\n            map.set(doc.primary, doc);\r\n        }\r\n        return overwriteGetterForCaching(\r\n            this,\r\n            'docsMap',\r\n            map\r\n        );\r\n    }\r\n\r\n    getValue(throwIfMissing?: boolean) {\r\n        const op = this.query.op;\r\n        if (op === 'count') {\r\n            return this.count;\r\n        } else if (op === 'findOne') {\r\n            // findOne()-queries emit RxDocument or null\r\n            const doc = this.documents.length === 0 ? null : this.documents[0];\r\n            if (!doc && throwIfMissing) {\r\n                throw newRxError('QU10', {\r\n                    collection: this.query.collection.name,\r\n                    query: this.query.mangoQuery,\r\n                    op\r\n                });\r\n            } else {\r\n                return doc;\r\n            }\r\n        } else if (op === 'findByIds') {\r\n            return this.docsMap;\r\n        } else {\r\n            // find()-queries emit RxDocument[]\r\n            // Flat copy the array so it won't matter if the user modifies it.\r\n            return this.documents.slice(0);\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]}